{% extends "base.html" %}
{% block content %}
<div class="card">
  <h1 class="h1" data-i18n="page.logs.title">Logs</h1>
  <div class="grid">
    <div>
      <div class="label" data-i18n="logs.label.last_tasks">Ostatnie zadania</div>
      <select id="task_select"></select>
      <div class="row" style="margin-top:10px">
        <button class="btn secondary" id="task_refresh" data-i18n="logs.btn.refresh">Odśwież</button>
        <button class="btn danger" id="task_clear" data-i18n="logs.btn.clear">Wyczyść listę zadań (server)</button>
      </div>
      <div class="small" data-i18n="logs.hint">Logi pokazują wyjście workerów (stderr) + postęp.</div>

      <div class="hr"></div>
      <div class="small"><span data-i18n="common.status">Status</span>: <b id="lg_status">—</b> • <span data-i18n="common.progress">Postęp</span>: <span id="lg_pct">0%</span></div>
      <div class="progress" style="margin-top:10px"><div id="lg_bar"></div></div>
    </div>

    <div>
      <div class="label" data-i18n="logs.label.logs">Logi</div>
      <textarea id="lg_logs" style="min-height:340px" readonly data-i18n-placeholder="logs.placeholder" placeholder="Logi pojawią się tutaj…"></textarea>
      <div class="row" style="margin-top:10px; flex-wrap:wrap">
        <button class="btn secondary" id="lg_copy_sel"><span data-i18n="logs.copy_sel">Copy selection</span></button>
        <button class="btn secondary" id="lg_copy_all"><span data-i18n="logs.copy_all">Copy all</span></button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function refreshTasks(){
  const j = await api("/api/tasks");
  const sel = document.getElementById("task_select");
  const prev = sel.value || "";
  sel.innerHTML = "";
  for(const t of j.tasks){
    const o=document.createElement("option");
    o.value=t.task_id;
    o.textContent = `${t.task_id.slice(0,8)} — ${t.kind} — ${t.status}`;
    sel.appendChild(o);
  }
  // Keep previously selected task if still present
  if(prev){
    for(const opt of sel.options){
      if(opt.value === prev){ sel.value = prev; break; }
    }
  }
  if(!sel.value && sel.options.length>0) sel.selectedIndex=0;
}
async function showSelected(){
  const sel = document.getElementById("task_select");
  if(!sel.value) return;
  const j = await api(`/api/tasks/${sel.value}`);
  document.getElementById("lg_status").textContent = j.status;
  document.getElementById("lg_pct").textContent = `${j.progress||0}%`;
  document.getElementById("lg_bar").style.width = `${j.progress||0}%`;
  document.getElementById("lg_logs").value = (j.logs||[]).join("\n");
}
document.getElementById("task_refresh").addEventListener("click", async ()=>{ await refreshTasks(); await showSelected(); });
document.getElementById("task_select").addEventListener("change", showSelected);
document.getElementById("task_clear").addEventListener("click", async ()=>{
  if(!confirm(t("logs.alert.clear_confirm"))) return;
  await api("/api/tasks/clear", {method:"POST"});
  await refreshTasks(); await showSelected();
});
(async()=>{ await refreshTasks(); await showSelected(); })();

async function _copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(e){
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand('copy'); }catch(_){}
    document.body.removeChild(ta);
    return true;
  }
}

document.getElementById("lg_copy_all").addEventListener("click", async ()=>{
  const ta = document.getElementById("lg_logs");
  await _copyToClipboard(ta.value || "");
  alert(t("logs.alert.copied"));
});

document.getElementById("lg_copy_sel").addEventListener("click", async ()=>{
  const ta = document.getElementById("lg_logs");
  const start = ta.selectionStart || 0;
  const end = ta.selectionEnd || 0;
  const txt = (end>start) ? ta.value.substring(start, end) : (ta.value || "");
  await _copyToClipboard(txt);
  alert(t("logs.alert.copied"));
});

// Auto-refresh while user watches logs
setInterval(async ()=>{
  try{ await refreshTasks(); await showSelected(); }catch(e){}
}, 1000);
</script>
{% endblock %}
