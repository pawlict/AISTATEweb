{% extends "base.html" %}
{% block content %}
<div class="card" style="padding:1.5rem;">
  <h2 style="margin-top:0;">Zarządzanie użytkownikami <span class="en">User management</span></h2>
  <p style="color:var(--muted,#888);font-size:.85rem;">
    Twórz, edytuj, banuj i usuwaj użytkowników. Przypisuj role i resetuj hasła.
    <br><span class="en">Create, edit, ban and delete users. Assign roles and reset passwords.</span>
  </p>

  <div style="display:flex;justify-content:space-between;align-items:center;margin:1.2rem 0 .8rem;">
    <button class="btn" id="btnAddUser">Dodaj użytkownika <span class="en">Add user</span></button>
  </div>

  <table class="data-table" id="usersTable" style="width:100%;">
    <thead>
      <tr>
        <th>Użytkownik <br><span class="en">User</span></th>
        <th>Nazwa <br><span class="en">Name</span></th>
        <th>Rola / Grupa <br><span class="en">Role / Group</span></th>
        <th>Status</th>
        <th>Ostatnie logowanie <br><span class="en">Last login</span></th>
        <th>Akcje <br><span class="en">Actions</span></th>
      </tr>
    </thead>
    <tbody id="usersBody"></tbody>
  </table>
</div>

<!-- Role-access reference table -->
<div class="card" style="padding:1.5rem;margin-top:1rem;">
  <h3 style="margin-top:0;">Uprawnienia ról — dostęp do modułów <br><span class="en">Role permissions — module access</span></h3>
  <p style="color:var(--muted,#888);font-size:.82rem;margin-bottom:1rem;">
    Każda rola daje dostęp do określonych modułów. Użytkownik widzi w menu tylko te moduły, do których ma uprawnienia.
    <br><span class="en">Each role grants access to specific modules. Users only see modules they have permissions for.</span>
  </p>
  <div style="overflow-x:auto;">
    <table class="data-table role-matrix" id="roleMatrix" style="width:100%;font-size:.85rem;">
      <thead><tr id="roleMatrixHead"></tr></thead>
      <tbody id="roleMatrixBody"></tbody>
    </table>
  </div>
</div>

<style>
  .en { font-size: 70%; color: var(--muted, #999); font-style: italic; }
  th .en, td .en { font-size: 70%; }
  .role-matrix th, .role-matrix td { text-align: center; padding: .45rem .5rem; vertical-align: middle; }
  .role-matrix th:first-child, .role-matrix td:first-child { text-align: left; font-weight: 600; }
  .role-matrix .check { color: #27ae60; font-weight: 700; font-size: 1.1rem; }
  .role-matrix .dash { color: #ddd; }
  .role-matrix .all { color: #1e40af; font-weight: 700; font-size: .9rem; }
  .role-matrix thead th { background: var(--card-bg, #f8f9fa); font-size: .78rem; white-space: nowrap; }
  .role-matrix tbody tr:hover { background: rgba(74,108,247,.04); }
  .role-matrix .section-row td { background: #f0f2f5; font-weight: 700; font-size: .78rem; color: var(--muted,#666); padding: .3rem .5rem; }
</style>

<!-- Modal: Add/Edit User -->
<div id="userModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:440px;">
    <h3 id="userModalTitle">Dodaj użytkownika <span class="en">Add user</span></h3>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="uUsername">Nazwa użytkownika <span class="en">Username</span></label>
      <input type="text" id="uUsername" autocomplete="off"/>
    </div>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="uDisplayName">Wyświetlana nazwa <span class="en">Display name</span></label>
      <input type="text" id="uDisplayName" autocomplete="off"/>
    </div>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="uPassword">Hasło (min. 6 znaków) <span class="en">Password (min. 6 chars)</span></label>
      <input type="password" id="uPassword" autocomplete="new-password"/>
    </div>
    <div class="field" style="margin-bottom:.8rem;">
      <label style="cursor:pointer;">
        <input type="checkbox" id="uIsAdmin"/> <span>Konto administratora <span class="en">Admin account</span></span>
      </label>
    </div>
    <div id="roleSection">
      <div class="field" style="margin-bottom:.8rem;">
        <label for="uRole">Rola / Grupa użytkownika <span class="en">User role / group</span></label>
        <select id="uRole"></select>
        <div id="uRoleModules" style="margin-top:.35rem;font-size:.76rem;color:var(--muted,#888);line-height:1.4;"></div>
      </div>
    </div>
    <div id="adminRoleSection" style="display:none;">
      <div class="field" style="margin-bottom:.8rem;">
        <label>Role administratora <span class="en">Admin roles</span></label>
        <div id="adminRolesChecks"></div>
      </div>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.2rem;">
      <button class="btn btn-secondary" id="userModalCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" id="userModalSave">Zapisz <span class="en">Save</span></button>
    </div>
    <div class="error" id="userModalError" style="color:#e74c3c;font-size:.85rem;margin-top:.5rem;min-height:1.2em;"></div>
  </div>
</div>

<!-- Modal: Change Role -->
<div id="changeRoleModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:420px;">
    <h3>Zmień rolę <span class="en">Change role</span></h3>
    <p style="margin-bottom:.8rem;">Użytkownik: <span class="en">User:</span> <b id="crUsername"></b></p>
    <div class="field" style="margin-bottom:.8rem;">
      <label style="cursor:pointer;">
        <input type="checkbox" id="crIsAdmin"/> <span>Konto administratora <span class="en">Admin account</span></span>
      </label>
    </div>
    <div id="crRoleSection">
      <div class="field" style="margin-bottom:.8rem;">
        <label for="crRole">Rola / Grupa <span class="en">Role / Group</span></label>
        <select id="crRole"></select>
        <div id="crRoleModules" style="margin-top:.35rem;font-size:.76rem;color:var(--muted,#888);line-height:1.4;"></div>
      </div>
    </div>
    <div id="crAdminRoleSection" style="display:none;">
      <div class="field" style="margin-bottom:.8rem;">
        <label>Role administratora <span class="en">Admin roles</span></label>
        <div id="crAdminRolesChecks"></div>
      </div>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.2rem;">
      <button class="btn btn-secondary" id="crCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" id="crSave">Zapisz <span class="en">Save</span></button>
    </div>
    <div class="error" id="crError" style="color:#e74c3c;font-size:.85rem;margin-top:.5rem;min-height:1.2em;"></div>
  </div>
</div>

<!-- Modal: Confirm Delete -->
<div id="deleteModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:360px;text-align:center;">
    <h3>Potwierdzenie usunięcia <span class="en">Confirm deletion</span></h3>
    <p id="deleteMsg"></p>
    <div style="display:flex;gap:.5rem;justify-content:center;margin-top:1rem;">
      <button class="btn btn-secondary" id="deleteCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" style="background:#e74c3c;" id="deleteConfirm">Usuń <span class="en">Delete</span></button>
    </div>
  </div>
</div>

<!-- Modal: Reset Password -->
<div id="resetPwModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:380px;">
    <h3>Reset hasła <span class="en">Reset password</span></h3>
    <p style="margin-bottom:.8rem;">Użytkownik: <span class="en">User:</span> <b id="rpUsername"></b></p>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="rpPassword">Nowe hasło (min. 6 znaków) <span class="en">New password (min. 6 chars)</span></label>
      <input type="password" id="rpPassword" autocomplete="new-password"/>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem;">
      <button class="btn btn-secondary" id="rpCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" id="rpConfirm">Zmień hasło <span class="en">Change password</span></button>
    </div>
    <div class="error" id="rpError" style="color:#e74c3c;font-size:.85rem;margin-top:.5rem;min-height:1.2em;"></div>
  </div>
</div>

<!-- Modal: Approve Pending User -->
<div id="approveModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:440px;">
    <h3>Zatwierdź użytkownika <span class="en">Approve user</span></h3>
    <p style="margin-bottom:.8rem;">
      Przypisz rolę dla: <span class="en">Assign role for:</span>
      <b id="approveUsername"></b>
    </p>
    <div class="field" style="margin-bottom:.8rem;">
      <label style="cursor:pointer;">
        <input type="checkbox" id="approveIsAdmin"/> <span>Konto administratora <span class="en">Admin account</span></span>
      </label>
    </div>
    <div id="approveRoleSection">
      <div class="field" style="margin-bottom:.8rem;">
        <label for="approveRole">Rola / Grupa użytkownika <span class="en">User role / group</span></label>
        <select id="approveRole"></select>
        <div id="approveRoleModules" style="margin-top:.35rem;font-size:.76rem;color:var(--muted,#888);line-height:1.4;"></div>
      </div>
    </div>
    <div id="approveAdminRoleSection" style="display:none;">
      <div class="field" style="margin-bottom:.8rem;">
        <label>Role administratora <span class="en">Admin roles</span></label>
        <div id="approveAdminRolesChecks"></div>
      </div>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.2rem;">
      <button class="btn btn-secondary" id="approveCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" style="background:#27ae60;" id="approveConfirm">Zatwierdź <span class="en">Approve</span></button>
    </div>
    <div class="error" id="approveError" style="color:#e74c3c;font-size:.85rem;margin-top:.5rem;min-height:1.2em;"></div>
  </div>
</div>

<!-- Modal: Reject Pending User -->
<div id="rejectModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:360px;text-align:center;">
    <h3>Odrzuć rejestrację <span class="en">Reject registration</span></h3>
    <p id="rejectMsg"></p>
    <div style="display:flex;gap:.5rem;justify-content:center;margin-top:1rem;">
      <button class="btn btn-secondary" id="rejectCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" style="background:#e74c3c;" id="rejectConfirm">Odrzuć <span class="en">Reject</span></button>
    </div>
  </div>
</div>

<!-- Modal: Ban -->
<div id="banModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:420px;">
    <h3>Zbanuj użytkownika <span class="en">Ban user</span></h3>
    <p style="margin-bottom:.8rem;">Użytkownik: <span class="en">User:</span> <b id="banUsername"></b></p>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="banDuration">Czas trwania bana <span class="en">Ban duration</span></label>
      <select id="banDuration">
        <option value="1h">1 godzina <span class="en">1 hour</span></option>
        <option value="6h">6 godzin <span class="en">6 hours</span></option>
        <option value="24h">24 godziny <span class="en">24 hours</span></option>
        <option value="3d">3 dni <span class="en">3 days</span></option>
        <option value="7d">7 dni <span class="en">7 days</span></option>
        <option value="30d">30 dni <span class="en">30 days</span></option>
        <option value="perm" selected>Permanentny <span class="en">Permanent</span></option>
      </select>
    </div>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="banReason">Powód (opcjonalnie) <span class="en">Reason (optional)</span></label>
      <input type="text" id="banReason" placeholder="np. naruszenie regulaminu..."/>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem;">
      <button class="btn btn-secondary" id="banCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" style="background:#e74c3c;" id="banConfirm">Zbanuj <span class="en">Ban</span></button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/users.js?v={{ app_version }}"></script>
{% endblock %}
