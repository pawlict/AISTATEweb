{% extends "base.html" %}
{% block content %}
<div class="card" style="padding:1.5rem;">
  <h2 style="margin-top:0;">Zarządzanie użytkownikami <span class="en">User management</span></h2>
  <p style="color:var(--muted,#888);font-size:.85rem;">
    Twórz, edytuj, banuj i usuwaj użytkowników. Przypisuj role i resetuj hasła.
    <br><span class="en">Create, edit, ban and delete users. Assign roles and reset passwords.</span>
  </p>

  <!-- Tabs -->
  <div class="users-tabs" style="display:flex;gap:.3rem;margin:1rem 0 .8rem;border-bottom:2px solid var(--border,#e0e3e8);padding-bottom:0;">
    <button class="users-tab active" data-panel="usersPanel">
      Użytkownicy <span class="en">Users</span>
    </button>
    <button class="users-tab" data-panel="securityPanel">
      Bezpieczeństwo <span class="en">Security</span>
    </button>
  </div>

  <!-- Panel: Users -->
  <div id="usersPanel" class="users-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin:.5rem 0 .8rem;">
      <button class="btn" id="btnAddUser">Dodaj użytkownika <span class="en">Add user</span></button>
    </div>

    <table class="data-table" id="usersTable" style="width:100%;">
      <thead>
        <tr>
          <th>UID</th>
          <th>Użytkownik <br><span class="en">User</span></th>
          <th>Nazwa <br><span class="en">Name</span></th>
          <th>Rola / Grupa <br><span class="en">Role / Group</span></th>
          <th>Status</th>
          <th>Ostatnie logowanie <br><span class="en">Last login</span></th>
          <th>Akcje <br><span class="en">Actions</span></th>
        </tr>
      </thead>
      <tbody id="usersBody"></tbody>
    </table>

    <!-- Role matrix + Call Center — only visible on Users tab -->
    <div class="panels-row" style="display:flex;gap:1rem;margin-top:1rem;flex-wrap:wrap;align-items:flex-start;">

      <!-- Role-access matrix (CSS Grid layout) -->
      <div class="role-matrix-card" style="padding:.8rem 1rem;flex:1 1 480px;max-width:780px;">
        <h3 style="margin:0 0 .5rem;font-size:.82rem;">Ustawienia r&oacute;l &mdash; dost&#281;p do modu&#322;&oacute;w <span class="en">Role settings &mdash; module access</span></h3>
        <div id="roleMatrixGrid" class="rm-grid"></div>
      </div>

      <!-- Call Center -->
      {% if user and user.is_superadmin %}
      <div class="callcenter-card" style="padding:.8rem 1rem;flex:1 1 340px;max-width:560px;">
        <h3 style="margin:0 0 .5rem;font-size:.82rem;">Call Center <span class="en">Call Center</span></h3>
        <p style="color:var(--muted,#888);font-size:.74rem;margin:0 0 .6rem;">
          Wyślij wiadomość do wybranych grup użytkowników.
          <span class="en">Send a message to selected user groups.</span>
        </p>

        <!-- Compose form -->
        <div class="field" style="margin-bottom:.5rem;">
          <label for="ccSubject" style="font-size:.78rem;">Temat <span class="en">Subject</span></label>
          <input type="text" id="ccSubject" style="font-size:.85rem;" placeholder="Temat wiadomości..."/>
        </div>

        <div class="field" style="margin-bottom:.5rem;">
          <label style="font-size:.78rem;">Treść <span class="en">Content</span></label>
          <div class="cc-toolbar-wrap" id="ccToolbar">
            <div class="cc-toolbar">
              <button type="button" data-cmd="bold" title="Pogrubienie / Bold"><b>B</b></button>
              <button type="button" data-cmd="italic" title="Kursywa / Italic"><i>I</i></button>
              <button type="button" data-cmd="underline" title="Podkreślenie / Underline"><u>U</u></button>
              <button type="button" data-cmd="strikeThrough" title="Przekreślenie / Strike"><s>S</s></button>
              <span class="cc-sep"></span>
              <button type="button" data-cmd="insertUnorderedList" title="Lista / Bullet list">&#8226;</button>
              <button type="button" data-cmd="insertOrderedList" title="Numeracja / Numbered">1.</button>
              <span class="cc-sep"></span>
              <button type="button" data-cmd="justifyLeft" title="Do lewej / Align left">&#8676;</button>
              <button type="button" data-cmd="justifyCenter" title="Wyśrodkuj / Center">&#8596;</button>
            </div>
            <div class="cc-toolbar cc-toolbar-row2">
              <span class="cc-tb-label">Rozmiar:</span>
              <button type="button" class="cc-tb-size" data-size="1" title="Bardzo mały / X-Small">A</button>
              <button type="button" class="cc-tb-size" data-size="2" title="Mały / Small">A</button>
              <button type="button" class="cc-tb-size cc-tb-active" data-size="3" title="Normalny / Normal">A</button>
              <button type="button" class="cc-tb-size" data-size="4" title="Duży / Large">A</button>
              <button type="button" class="cc-tb-size" data-size="5" title="Bardzo duży / X-Large">A</button>
              <span class="cc-sep"></span>
              <span class="cc-tb-label">Kolor:</span>
              <button type="button" class="cc-tb-color cc-tb-active" data-color="" title="Domyślny / Default"><span class="cc-color-dot" style="background:#333;"></span></button>
              <button type="button" class="cc-tb-color" data-color="#e74c3c" title="Czerwony / Red"><span class="cc-color-dot" style="background:#e74c3c;"></span></button>
              <button type="button" class="cc-tb-color" data-color="#27ae60" title="Zielony / Green"><span class="cc-color-dot" style="background:#27ae60;"></span></button>
              <button type="button" class="cc-tb-color" data-color="#2980b9" title="Niebieski / Blue"><span class="cc-color-dot" style="background:#2980b9;"></span></button>
              <button type="button" class="cc-tb-color" data-color="#e67e22" title="Pomarańczowy / Orange"><span class="cc-color-dot" style="background:#e67e22;"></span></button>
              <button type="button" class="cc-tb-color" data-color="#8e44ad" title="Fioletowy / Purple"><span class="cc-color-dot" style="background:#8e44ad;"></span></button>
            </div>
          </div>
          <div class="cc-editor" id="ccEditor" contenteditable="true"></div>
        </div>

        <div class="field" style="margin-bottom:.6rem;">
          <label style="font-size:.78rem;">Grupy docelowe <span class="en">Target groups</span></label>
          <div id="ccTargetGroups" class="cc-groups"></div>
        </div>

        <div style="display:flex;gap:.5rem;justify-content:flex-end;align-items:center;">
          <div class="error" id="ccError" style="color:#e74c3c;font-size:.78rem;flex:1;"></div>
          <button class="btn" id="ccSend" style="font-size:.8rem;">Wyślij <span class="en">Send</span></button>
        </div>

        <!-- Sent messages list -->
        <div id="ccSentList" style="margin-top:.8rem;"></div>
      </div>
      {% endif %}

    </div>
  </div>

  <!-- Panel: Security Settings -->
  <div id="securityPanel" class="users-panel" style="display:none;">
    <h3 style="margin:.5rem 0 .8rem;font-size:.95rem;">Polityka bezpieczeństwa <span class="en">Security policy</span></h3>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;">

      <!-- Account Lockout -->
      <div style="border:1px solid var(--border,#e0e3e8);border-radius:8px;padding:.8rem 1rem;">
        <h4 style="margin:0 0 .5rem;font-size:.85rem;">Blokada konta <span class="en">Account lockout</span></h4>
        <div class="field" style="margin-bottom:.5rem;">
          <label style="font-size:.78rem;">Próg blokady (0 = wyłączone) <span class="en">Lockout threshold (0 = off)</span></label>
          <input type="number" id="secLockoutThreshold" min="0" max="50" value="5" style="width:80px;" onchange="saveSecuritySetting('account_lockout_threshold', parseInt(this.value))"/>
        </div>
        <div class="field" style="margin-bottom:.3rem;">
          <label style="font-size:.78rem;">Czas blokady (minuty) <span class="en">Lock duration (min)</span></label>
          <input type="number" id="secLockoutDuration" min="1" max="1440" value="15" style="width:80px;" onchange="saveSecuritySetting('account_lockout_duration', parseInt(this.value))"/>
        </div>
      </div>

      <!-- Password Policy -->
      <div style="border:1px solid var(--border,#e0e3e8);border-radius:8px;padding:.8rem 1rem;">
        <h4 style="margin:0 0 .5rem;font-size:.85rem;">Polityka haseł <span class="en">Password policy</span></h4>
        <div class="field" style="margin-bottom:.5rem;">
          <label style="font-size:.78rem;">Poziom wymagań <span class="en">Strength level</span></label>
          <select id="secPasswordPolicy" style="font-size:.85rem;" onchange="saveSecuritySetting('password_policy', this.value)">
            <option value="none">Brak (min 6) <span class="en">None (min 6)</span></option>
            <option value="basic">Podstawowy (min 8) <span class="en">Basic (min 8)</span></option>
            <option value="medium">Średni (8 + a-z A-Z 0-9) <span class="en">Medium</span></option>
            <option value="strong">Silny (12 + specjalne) <span class="en">Strong</span></option>
          </select>
        </div>
      </div>

      <!-- Password Expiry -->
      <div style="border:1px solid var(--border,#e0e3e8);border-radius:8px;padding:.8rem 1rem;">
        <h4 style="margin:0 0 .5rem;font-size:.85rem;">Wygasanie haseł <span class="en">Password expiry</span></h4>
        <div class="field" style="margin-bottom:.5rem;">
          <label style="font-size:.78rem;">Dni ważności (0 = wyłączone) <span class="en">Validity days (0 = off)</span></label>
          <input type="number" id="secPasswordExpiry" min="0" max="365" value="0" style="width:80px;" onchange="saveSecuritySetting('password_expiry_days', parseInt(this.value))"/>
        </div>
        <p style="font-size:.72rem;color:var(--muted,#888);margin:0;">
          Po wygaśnięciu użytkownik musi zmienić hasło przy logowaniu.
          <span class="en">After expiry the user must change password at login.</span>
        </p>
      </div>

      <!-- Session Timeout -->
      <div style="border:1px solid var(--border,#e0e3e8);border-radius:8px;padding:.8rem 1rem;">
        <h4 style="margin:0 0 .5rem;font-size:.85rem;">Sesja <span class="en">Session</span></h4>
        <div class="field" style="margin-bottom:.3rem;">
          <label style="font-size:.78rem;">Timeout sesji (godziny) <span class="en">Session timeout (hours)</span></label>
          <input type="number" id="secSessionTimeout" min="1" max="720" value="8" style="width:80px;" onchange="saveSecuritySetting('session_timeout_hours', parseInt(this.value))"/>
        </div>
      </div>

    </div>
    <div id="secSaveMsg" style="font-size:.82rem;color:#27ae60;margin-top:.6rem;min-height:1.2em;"></div>

    <!-- Password Blacklist (separate card) -->
    <div id="blCard" style="border:1px solid var(--border,#e0e3e8);border-radius:8px;padding:.8rem 1rem;margin-top:1rem;">
      <div style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;" onclick="toggleBlacklist()">
        <h4 style="margin:0;font-size:.85rem;">
          <span id="blArrow" class="bl-arrow">&#9654;</span>
          Czarna lista haseł <span class="en">Password blacklist</span>
          <span style="font-weight:400;color:var(--muted,#888);font-size:.78rem;">(<span id="blCount">...</span>)</span>
        </h4>
      </div>
      <div id="blPanel" style="display:none;margin-top:.6rem;">
        <p style="font-size:.72rem;color:var(--muted,#888);margin:0 0 .5rem;">
          Hasła z tej listy są zawsze blokowane niezależnie od poziomu polityki.
          <span class="en">Passwords on this list are always blocked regardless of policy level.</span>
        </p>
        <!-- Add form -->
        <div style="display:flex;gap:.3rem;margin-bottom:.5rem;">
          <input type="text" id="blNewPassword" placeholder="Nowe hasło do zablokowania..." style="flex:1;font-size:.8rem;padding:.3rem .5rem;border-radius:5px;border:1px solid var(--border,#ddd);"/>
          <button class="btn" id="blAddBtn" style="font-size:.76rem;padding:.3rem .6rem;" onclick="addToBlacklist()">+ Dodaj <span class="en">Add</span></button>
        </div>
        <!-- List container -->
        <div id="blList" class="bl-list"></div>
      </div>
    </div>

    <!-- Audit Log (Login history) -->
    <h3 style="margin:1.5rem 0 .3rem;font-size:.95rem;" id="auditHeading">Historia logowań</h3>
    <p id="auditDescription" style="color:var(--muted,#888);font-size:.76rem;margin:0 0 .8rem;line-height:1.5;">
      Wyszukuj po nazwie użytkownika lub wklej UID (np. <code style="font-size:.72rem;">3fa85f64-5717...</code>). Wybierz typ zdarzenia, aby przefiltrować listę. Kliknij użytkownika w wynikach, aby zobaczyć jego historię.
      <br><span class="en">Search by username or paste a UID (e.g. <code style="font-size:.72rem;">3fa85f64-5717...</code>). Select an event type to filter the list. Click a user in results to see their history.</span>
    </p>
    <div class="audit-filters" style="display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-start;margin:0 0 .8rem;">

      <!-- User filter group -->
      <div class="audit-filter-group" style="flex:0 0 auto;min-width:220px;position:relative;">
        <label class="audit-filter-label" id="auditUserLabel" style="display:block;font-size:.72rem;font-weight:700;color:var(--muted,#666);margin-bottom:.25rem;text-transform:uppercase;letter-spacing:.04em;">Użytkownicy</label>
        <div id="auditUserActiveFilter" style="display:none;margin-bottom:.35rem;">
          <span class="audit-badge" style="display:inline-flex;align-items:center;gap:.3rem;background:var(--accent,#4a6cf7);color:#fff;font-size:.76rem;font-weight:600;padding:.2rem .5rem .2rem .6rem;border-radius:12px;">
            <span id="auditUserBadgeText"></span>
            <button type="button" id="auditUserClear" style="background:none;border:none;color:#fff;cursor:pointer;font-size:.85rem;line-height:1;padding:0 .1rem;opacity:.8;" title="Usuń filtr">&times;</button>
          </span>
        </div>
        <div style="position:relative;">
          <input type="text" id="auditUserSearch" autocomplete="off" placeholder="Szukaj po nazwie lub UID..." style="font-size:.82rem;padding:.35rem .5rem;border-radius:6px;border:1px solid var(--border,#ddd);width:100%;box-sizing:border-box;"/>
          <div id="auditUserResults" class="audit-user-results" style="display:none;"></div>
        </div>
      </div>

      <!-- Event filter group -->
      <div class="audit-filter-group" style="flex:0 0 auto;min-width:200px;">
        <label class="audit-filter-label" id="auditEventLabel" style="display:block;font-size:.72rem;font-weight:700;color:var(--muted,#666);margin-bottom:.25rem;text-transform:uppercase;letter-spacing:.04em;">Zdarzenia</label>
        <select id="auditEventFilter" style="font-size:.82rem;padding:.35rem .5rem;border-radius:6px;border:1px solid var(--border,#ddd);min-width:200px;">
          <option value="">—</option>
        </select>
      </div>

      <!-- Pagination -->
      <div style="margin-left:auto;display:flex;gap:.3rem;align-items:flex-end;padding-bottom:.15rem;">
        <button class="btn btn-secondary" id="auditPrev" style="font-size:.75rem;padding:.2rem .5rem;">&larr;</button>
        <span id="auditInfo" style="font-size:.78rem;color:var(--muted,#888);"></span>
        <button class="btn btn-secondary" id="auditNext" style="font-size:.75rem;padding:.2rem .5rem;">&rarr;</button>
      </div>
    </div>
    <div class="audit-table-scroll">
      <table class="data-table" style="width:100%;font-size:.82rem;">
        <thead>
          <tr>
            <th>Data / czas</th>
            <th>UID</th>
            <th>Użytkownik</th>
            <th>Zdarzenie</th>
            <th>IP</th>
            <th>Szczegóły</th>
            <th>Urządzenie</th>
          </tr>
        </thead>
        <tbody id="auditBody"></tbody>
      </table>
    </div>
  </div>

</div>

<style>
  .en { font-size: 70%; color: var(--muted, #999); font-style: italic; }
  /* Audit user search autocomplete */
  .audit-user-results { position:absolute;top:100%;left:0;right:0;background:var(--card-bg,#fff);border:1px solid var(--border,#ddd);border-top:none;border-radius:0 0 6px 6px;max-height:200px;overflow-y:auto;z-index:50;box-shadow:0 4px 12px rgba(0,0,0,.1); }
  .audit-user-item { padding:.4rem .6rem;cursor:pointer;font-size:.82rem;display:flex;align-items:center;gap:.4rem;border-bottom:1px solid var(--border,#f0f0f0); }
  .audit-user-item:last-child { border-bottom:none; }
  .audit-user-item:hover, .audit-user-item.focused { background:rgba(74,108,247,.08); }
  .audit-user-item .au-username { font-weight:600;color:var(--text,#333); }
  .audit-user-item .au-display { font-size:.76rem;color:var(--muted,#888); }
  .audit-user-item .au-match { background:rgba(74,108,247,.15);border-radius:2px;padding:0 1px; }
  /* Tab styling — base (inactive) */
  .users-tab { padding:.45rem .9rem; border:none; border-bottom:2px solid transparent; border-radius:6px 6px 0 0; background:transparent; font-weight:400; font-size:.85rem; cursor:pointer; margin-bottom:-2px; color:var(--muted,#888); transition: all .2s; }
  .users-tab:hover { color: var(--accent, #4a6cf7); }
  /* Tab styling — active */
  .users-tab.active { border-bottom-color: var(--accent, #4a6cf7); color: var(--accent, #4a6cf7); font-weight: 600; background: var(--card-bg, #fff); }
  /* Audit table scrollable container */
  .audit-table-scroll { max-height: calc(30 * 2.1em + 2.4em); overflow-y: auto; border: 1px solid var(--border, #eee); border-radius: 6px; }
  .audit-table-scroll .data-table { border-collapse: collapse; }
  .audit-table-scroll thead th { position: sticky; top: 0; background: var(--card-bg, #f8f9fa); z-index: 2; }
  /* Password blacklist panel */
  .bl-arrow { font-size:.6rem; transition:transform .2s; display:inline-block; margin-right:.3rem; }
  .bl-arrow.open { transform:rotate(90deg); }

  /* User table row hover + cursor for dblclick */
  #usersBody tr[data-uid] { transition: background .15s; cursor: pointer; }
  #usersBody tr[data-uid]:hover { background: rgba(74,108,247,.06) !important; }

  /* Audit table row hover */
  #auditBody tr[data-uid] { transition: background .15s; cursor: pointer; }
  #auditBody tr[data-uid]:hover { background: rgba(74,108,247,.06) !important; }

  /* Context menu */
  .ctx-menu { position:fixed; z-index:999; min-width:240px; background:var(--card-bg,#fff); border:1px solid var(--border,#ddd); border-radius:10px; box-shadow:0 8px 32px rgba(0,0,0,.18); padding:.3rem 0; animation: ctxFadeIn .15s ease-out; }
  @keyframes ctxFadeIn { from { opacity:0; transform:scale(.95) translateY(-4px); } to { opacity:1; transform:scale(1) translateY(0); } }
  .ctx-menu-header { padding:.45rem .7rem; font-size:.78rem; font-weight:700; color:var(--text,#333); border-bottom:1px solid var(--border,#eee); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .ctx-menu-item { display:flex; align-items:center; gap:.45rem; width:100%; background:none; border:none; padding:.45rem .7rem; font-size:.8rem; color:var(--text,#333); cursor:pointer; text-align:left; transition:background .1s; }
  .ctx-menu-item:hover { background:rgba(74,108,247,.08); }
  .ctx-menu-item:first-of-type { border-radius:0; }
  .ctx-menu-item:last-of-type { border-radius:0 0 10px 10px; }
  .ctx-icon { font-size:.9rem; width:1.2em; text-align:center; }
  .bl-list { max-height:250px; overflow-y:auto; border:1px solid var(--border,#eee); border-radius:6px; padding:.3rem; }
  .bl-item { display:flex; align-items:center; justify-content:space-between; padding:.2rem .4rem; font-size:.78rem; border-bottom:1px solid var(--border,#f0f0f0); font-family:monospace; }
  .bl-item:last-child { border-bottom:none; }
  .bl-item:hover { background:rgba(0,0,0,.02); }
  .bl-item .bl-badge { font-size:.6rem; color:var(--muted,#999); background:var(--border,#eee); padding:.05rem .3rem; border-radius:3px; margin-left:.4rem; font-family:sans-serif; }
  .bl-item .bl-del { background:none; border:none; color:#e74c3c; cursor:pointer; font-size:.78rem; padding:0 .2rem; opacity:.6; }
  .bl-item .bl-del:hover { opacity:1; }
  .bl-empty { font-size:.74rem; color:var(--muted,#999); text-align:center; padding:.5rem; }
  .role-matrix-card { background: var(--card-bg, #fff); border-radius: 10px; box-shadow: 0 1px 8px rgba(0,0,0,.05); border: 1px solid var(--border, #e0e3e8); }
  /* CSS Grid role matrix */
  .rm-grid { display: grid; font-size: .72rem; gap: 0; border: 1px solid var(--border, #e0e3e8); border-radius: 6px; overflow: hidden; }
  .rm-grid .rm-cell { padding: .3rem .45rem; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--border, #eee); border-right: 1px solid var(--border, #eee); min-height: 1.8em; white-space: nowrap; }
  .rm-grid .rm-cell:last-child { border-right: none; }
  .rm-grid .rm-header { background: var(--card-bg, #f8f9fa); font-weight: 700; font-size: .64rem; color: var(--text, #333); }
  .rm-grid .rm-role-name { justify-content: flex-start; font-weight: 600; font-size: .72rem; }
  .rm-grid .rm-section { font-weight: 700; font-size: .64rem; color: var(--muted, #666); background: #f0f2f5; justify-content: flex-start; }
  .rm-grid .rm-check { color: #27ae60; font-weight: 700; font-size: .9rem; }
  .rm-grid .rm-no { color: #e74c3c; font-weight: 700; font-size: .85rem; }
  .rm-grid .rm-row:hover .rm-cell { background: rgba(74,108,247,.04); }

  /* Call Center panel */
  .callcenter-card { background: var(--card-bg, #fff); border-radius: 10px; box-shadow: 0 1px 8px rgba(0,0,0,.05); border: 1px solid var(--border, #e0e3e8); }
  .cc-toolbar-wrap { border: 1px solid var(--border, #ddd); border-bottom: none; border-radius: 6px 6px 0 0; background: #f8f9fa; overflow: hidden; }
  .cc-toolbar { display: flex; align-items: center; gap: 2px; padding: .3rem .4rem; }
  .cc-toolbar-row2 { border-top: 1px solid var(--border, #eee); padding-top: .25rem; }
  .cc-toolbar button { background: none; border: 1px solid transparent; border-radius: 3px; padding: .15rem .35rem; cursor: pointer; font-size: .78rem; color: var(--text, #333); line-height: 1; }
  .cc-toolbar button:hover { background: var(--border, #e0e3e8); }
  .cc-toolbar .cc-tb-active { background: var(--border, #e0e3e8); border-color: var(--muted, #999); }
  .cc-tb-label { font-size: .64rem; color: var(--muted, #888); font-weight: 600; margin-right: 2px; white-space: nowrap; }
  .cc-color-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; border: 1.5px solid rgba(0,0,0,.12); vertical-align: middle; }
  .cc-toolbar .cc-tb-color { padding: .15rem .22rem; }
  .cc-toolbar .cc-tb-color.cc-tb-active .cc-color-dot { border-color: var(--text, #333); box-shadow: 0 0 0 1px var(--text, #333); }
  .cc-toolbar .cc-tb-size { min-width: 20px; text-align: center; }
  .cc-toolbar .cc-tb-size[data-size="1"] { font-size: .58rem; }
  .cc-toolbar .cc-tb-size[data-size="2"] { font-size: .68rem; }
  .cc-toolbar .cc-tb-size[data-size="3"] { font-size: .78rem; }
  .cc-toolbar .cc-tb-size[data-size="4"] { font-size: .9rem; }
  .cc-toolbar .cc-tb-size[data-size="5"] { font-size: 1.02rem; }
  .cc-sep { width: 1px; height: 16px; background: var(--border, #ddd); margin: 0 3px; }
  .cc-editor { min-height: 120px; max-height: 250px; overflow-y: auto; padding: .5rem; border: 1px solid var(--border, #ddd); border-radius: 0 0 6px 6px; font-size: .85rem; line-height: 1.5; background: #fff; outline: none; }
  .cc-editor:focus { border-color: var(--accent, #4a6cf7); }
  .cc-editor ul, .cc-editor ol { margin: .3rem 0 .3rem 1.2rem; }
  .cc-groups { display: flex; flex-wrap: wrap; gap: .3rem; }
  .cc-groups label { font-size: .74rem; display: flex; align-items: center; gap: .2rem; padding: .15rem .4rem; border: 1px solid var(--border, #ddd); border-radius: 4px; cursor: pointer; background: #fafafa; }
  .cc-groups label:hover { background: #f0f2f5; }
  .cc-groups input { margin: 0; }
  .cc-sent-item { background: #f8f9fa; border: 1px solid var(--border, #eee); border-radius: 6px; padding: .5rem .6rem; margin-bottom: .4rem; font-size: .76rem; }
  .cc-sent-item .cc-sent-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: .25rem; }
  .cc-sent-item .cc-sent-subj { font-weight: 600; }
  .cc-sent-item .cc-sent-date { color: var(--muted, #999); font-size: .68rem; }
  .cc-sent-item .cc-sent-groups { color: var(--muted, #888); font-size: .68rem; }
  .cc-sent-item .cc-sent-stats { color: var(--muted, #888); font-size: .68rem; margin-top: .2rem; }
  .cc-sent-item .cc-sent-del { background: none; border: none; color: #e74c3c; cursor: pointer; font-size: .72rem; padding: .1rem .3rem; }
  .cc-sent-item .cc-sent-del:hover { text-decoration: underline; }
</style>

<!-- Context menu for audit log user clicks -->
<div id="userContextMenu" class="ctx-menu" style="display:none;">
  <div class="ctx-menu-header" id="ctxMenuHeader"></div>
  <button class="ctx-menu-item" id="ctxFilterAudit">
    <span class="ctx-icon">&#128269;</span>
    Filtruj zdarzenia <span class="en">Filter events</span>
  </button>
  <button class="ctx-menu-item" id="ctxGoToUsers">
    <span class="ctx-icon">&#128100;</span>
    Przejdź do Użytkowników <span class="en">Go to Users</span>
  </button>
</div>

<!-- Modal: Add/Edit User -->
<div id="userModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:440px;">
    <h3 id="userModalTitle">Dodaj użytkownika <span class="en">Add user</span></h3>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="uUsername">Nazwa użytkownika <span class="en">Username</span></label>
      <input type="text" id="uUsername" autocomplete="off"/>
    </div>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="uDisplayName">Wyświetlana nazwa <span class="en">Display name</span></label>
      <input type="text" id="uDisplayName" autocomplete="off"/>
    </div>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="uPassword">Hasło (min. 6 znaków) <span class="en">Password (min. 6 chars)</span></label>
      <input type="password" id="uPassword" autocomplete="new-password"/>
    </div>
    <div class="field" style="margin-bottom:.8rem;">
      <label style="cursor:pointer;">
        <input type="checkbox" id="uIsAdmin"/> <span>Konto administratora <span class="en">Admin account</span></span>
      </label>
    </div>
    <div id="roleSection">
      <div class="field" style="margin-bottom:.8rem;">
        <label for="uRole">Rola / Grupa użytkownika <span class="en">User role / group</span></label>
        <select id="uRole"></select>
        <div id="uRoleModules" style="margin-top:.35rem;font-size:.76rem;color:var(--muted,#888);line-height:1.4;"></div>
      </div>
    </div>
    <div id="adminRoleSection" style="display:none;">
      <div class="field" style="margin-bottom:.8rem;">
        <label>Role administratora <span class="en">Admin roles</span></label>
        <div id="adminRolesChecks"></div>
      </div>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.2rem;">
      <button class="btn btn-secondary" id="userModalCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" id="userModalSave">Zapisz <span class="en">Save</span></button>
    </div>
    <div class="error" id="userModalError" style="color:#e74c3c;font-size:.85rem;margin-top:.5rem;min-height:1.2em;"></div>
  </div>
</div>

<!-- Modal: Change Role -->
<div id="changeRoleModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:420px;">
    <h3>Zmień rolę <span class="en">Change role</span></h3>
    <p style="margin-bottom:.8rem;">Użytkownik: <span class="en">User:</span> <b id="crUsername"></b></p>
    <div class="field" style="margin-bottom:.8rem;">
      <label style="cursor:pointer;">
        <input type="checkbox" id="crIsAdmin"/> <span>Konto administratora <span class="en">Admin account</span></span>
      </label>
    </div>
    <div id="crRoleSection">
      <div class="field" style="margin-bottom:.8rem;">
        <label for="crRole">Rola / Grupa <span class="en">Role / Group</span></label>
        <select id="crRole"></select>
        <div id="crRoleModules" style="margin-top:.35rem;font-size:.76rem;color:var(--muted,#888);line-height:1.4;"></div>
      </div>
    </div>
    <div id="crAdminRoleSection" style="display:none;">
      <div class="field" style="margin-bottom:.8rem;">
        <label>Role administratora <span class="en">Admin roles</span></label>
        <div id="crAdminRolesChecks"></div>
      </div>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.2rem;">
      <button class="btn btn-secondary" id="crCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" id="crSave">Zapisz <span class="en">Save</span></button>
    </div>
    <div class="error" id="crError" style="color:#e74c3c;font-size:.85rem;margin-top:.5rem;min-height:1.2em;"></div>
  </div>
</div>

<!-- Modal: Confirm Delete -->
<div id="deleteModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:360px;text-align:center;">
    <h3>Potwierdzenie usunięcia <span class="en">Confirm deletion</span></h3>
    <p id="deleteMsg"></p>
    <div style="display:flex;gap:.5rem;justify-content:center;margin-top:1rem;">
      <button class="btn btn-secondary" id="deleteCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" style="background:#e74c3c;" id="deleteConfirm">Usuń <span class="en">Delete</span></button>
    </div>
  </div>
</div>

<!-- Modal: Reset Password -->
<div id="resetPwModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:380px;">
    <h3>Reset hasła <span class="en">Reset password</span></h3>
    <p style="margin-bottom:.8rem;">Użytkownik: <span class="en">User:</span> <b id="rpUsername"></b></p>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="rpPassword">Nowe hasło (min. 6 znaków) <span class="en">New password (min. 6 chars)</span></label>
      <input type="password" id="rpPassword" autocomplete="new-password"/>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem;">
      <button class="btn btn-secondary" id="rpCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" id="rpConfirm">Zmień hasło <span class="en">Change password</span></button>
    </div>
    <div class="error" id="rpError" style="color:#e74c3c;font-size:.85rem;margin-top:.5rem;min-height:1.2em;"></div>
  </div>
</div>

<!-- Modal: Approve Pending User -->
<div id="approveModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:440px;">
    <h3>Zatwierdź użytkownika <span class="en">Approve user</span></h3>
    <p style="margin-bottom:.8rem;">
      Przypisz rolę dla: <span class="en">Assign role for:</span>
      <b id="approveUsername"></b>
    </p>
    <div class="field" style="margin-bottom:.8rem;">
      <label style="cursor:pointer;">
        <input type="checkbox" id="approveIsAdmin"/> <span>Konto administratora <span class="en">Admin account</span></span>
      </label>
    </div>
    <div id="approveRoleSection">
      <div class="field" style="margin-bottom:.8rem;">
        <label for="approveRole">Rola / Grupa użytkownika <span class="en">User role / group</span></label>
        <select id="approveRole"></select>
        <div id="approveRoleModules" style="margin-top:.35rem;font-size:.76rem;color:var(--muted,#888);line-height:1.4;"></div>
      </div>
    </div>
    <div id="approveAdminRoleSection" style="display:none;">
      <div class="field" style="margin-bottom:.8rem;">
        <label>Role administratora <span class="en">Admin roles</span></label>
        <div id="approveAdminRolesChecks"></div>
      </div>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.2rem;">
      <button class="btn btn-secondary" id="approveCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" style="background:#27ae60;" id="approveConfirm">Zatwierdź <span class="en">Approve</span></button>
    </div>
    <div class="error" id="approveError" style="color:#e74c3c;font-size:.85rem;margin-top:.5rem;min-height:1.2em;"></div>
  </div>
</div>

<!-- Modal: Reject Pending User -->
<div id="rejectModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:360px;text-align:center;">
    <h3>Odrzuć rejestrację <span class="en">Reject registration</span></h3>
    <p id="rejectMsg"></p>
    <div style="display:flex;gap:.5rem;justify-content:center;margin-top:1rem;">
      <button class="btn btn-secondary" id="rejectCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" style="background:#e74c3c;" id="rejectConfirm">Odrzuć <span class="en">Reject</span></button>
    </div>
  </div>
</div>

<!-- Modal: Ban -->
<div id="banModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:420px;">
    <h3>Zbanuj użytkownika <span class="en">Ban user</span></h3>
    <p style="margin-bottom:.8rem;">Użytkownik: <span class="en">User:</span> <b id="banUsername"></b></p>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="banDuration">Czas trwania bana <span class="en">Ban duration</span></label>
      <select id="banDuration">
        <option value="1h">1 godzina <span class="en">1 hour</span></option>
        <option value="6h">6 godzin <span class="en">6 hours</span></option>
        <option value="24h">24 godziny <span class="en">24 hours</span></option>
        <option value="3d">3 dni <span class="en">3 days</span></option>
        <option value="7d">7 dni <span class="en">7 days</span></option>
        <option value="30d">30 dni <span class="en">30 days</span></option>
        <option value="perm" selected>Permanentny <span class="en">Permanent</span></option>
      </select>
    </div>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="banReason">Powód (opcjonalnie) <span class="en">Reason (optional)</span></label>
      <input type="text" id="banReason" placeholder="np. naruszenie regulaminu..."/>
    </div>
    <div class="field" style="margin-bottom:.8rem;">
      <label style="cursor:pointer;">
        <input type="checkbox" id="banShowExpiry" checked/>
        <span>Pokaż użytkownikowi datę końca bana <span class="en">Show ban expiry date to user</span></span>
      </label>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem;">
      <button class="btn btn-secondary" id="banCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" style="background:#e74c3c;" id="banConfirm">Zbanuj <span class="en">Ban</span></button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/users.js?v={{ app_version }}"></script>
{% if user and user.is_superadmin %}
<script>
/* Call Center — rich text messaging for Główny Opiekun */
(function(){
  'use strict';

  /* All target groups: user roles + admin roles + "all" */
  var ALL_GROUPS = [
    { key: 'all', pl: 'Wszyscy', en: 'Everyone' },
    { key: 'Transkryptor', pl: 'Transkryptor', en: 'Transcriber' },
    { key: 'Lingwista', pl: 'Lingwista', en: 'Linguist' },
    { key: 'Analityk', pl: 'Analityk', en: 'Analyst' },
    { key: 'Dialogista', pl: 'Dialogista', en: 'Dialogue Spec.' },
    { key: 'Strateg', pl: 'Strateg', en: 'Strategist' },
    { key: 'Mistrz Sesji', pl: 'Mistrz Sesji', en: 'Session Master' },
    { key: 'Architekt Funkcji', pl: 'Architekt Funkcji', en: 'Function Architect' },
    { key: 'Stra\u017cnik Dost\u0119pu', pl: 'Stra\u017cnik Dost\u0119pu', en: 'Access Guardian' },
    { key: 'G\u0142\u00f3wny Opiekun', pl: 'G\u0142\u00f3wny Opiekun', en: 'Main Guardian' },
  ];

  /* Build target group checkboxes */
  var groupsEl = document.getElementById('ccTargetGroups');
  if (groupsEl) {
    ALL_GROUPS.forEach(function(g) {
      var label = document.createElement('label');
      label.innerHTML = '<input type="checkbox" value="' + g.key + '"/> ' + g.pl + ' <span class="en">' + g.en + '</span>';
      groupsEl.appendChild(label);
    });
  }

  /* Rich text toolbar */
  var toolbar = document.getElementById('ccToolbar');
  var editor = document.getElementById('ccEditor');
  if (toolbar && editor) {
    /* Standard commands (bold, italic, etc.) */
    toolbar.addEventListener('click', function(e) {
      var btn = e.target.closest('button[data-cmd]');
      if (!btn) return;
      e.preventDefault();
      document.execCommand(btn.dataset.cmd, false, null);
      editor.focus();
    });
    /* Font size buttons */
    toolbar.querySelectorAll('.cc-tb-size').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toolbar.querySelectorAll('.cc-tb-size').forEach(function(b) { b.classList.remove('cc-tb-active'); });
        btn.classList.add('cc-tb-active');
        document.execCommand('fontSize', false, btn.dataset.size);
        editor.focus();
      });
    });
    /* Font color buttons */
    toolbar.querySelectorAll('.cc-tb-color').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toolbar.querySelectorAll('.cc-tb-color').forEach(function(b) { b.classList.remove('cc-tb-active'); });
        btn.classList.add('cc-tb-active');
        if (btn.dataset.color) {
          document.execCommand('foreColor', false, btn.dataset.color);
        } else {
          document.execCommand('removeFormat', false, null);
        }
        editor.focus();
      });
    });
  }

  /* Send message */
  var sendBtn = document.getElementById('ccSend');
  var errEl = document.getElementById('ccError');
  if (sendBtn) {
    sendBtn.addEventListener('click', async function() {
      errEl.textContent = '';
      var subject = document.getElementById('ccSubject').value.trim();
      var content = editor.innerHTML.trim();
      var groups = [];
      document.querySelectorAll('#ccTargetGroups input:checked').forEach(function(cb) {
        groups.push(cb.value);
      });
      if (!subject) { errEl.textContent = 'Podaj temat / Enter subject'; return; }
      if (!content || content === '<br>') { errEl.textContent = 'Wpisz treść / Enter content'; return; }
      if (groups.length === 0) { errEl.textContent = 'Wybierz grupy / Select groups'; return; }

      try {
        var res = await fetch('/api/messages', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ subject: subject, content: content, target_groups: groups }),
        });
        var data = await res.json();
        if (!res.ok) { errEl.textContent = data.message || 'Error'; return; }
        /* Clear form */
        document.getElementById('ccSubject').value = '';
        editor.innerHTML = '';
        document.querySelectorAll('#ccTargetGroups input:checked').forEach(function(cb) { cb.checked = false; });
        loadSentMessages();
      } catch(e) {
        errEl.textContent = 'Connection error';
      }
    });
  }

  /* Load & render sent messages */
  async function loadSentMessages() {
    var list = document.getElementById('ccSentList');
    if (!list) return;
    try {
      var res = await fetch('/api/messages');
      var data = await res.json();
      if (data.status !== 'ok') return;
      var msgs = data.messages || [];
      if (msgs.length === 0) {
        list.innerHTML = '<div style="color:var(--muted,#999);font-size:.74rem;">Brak wiadomości <span class="en">No messages</span></div>';
        return;
      }
      list.innerHTML = '<div style="font-size:.74rem;font-weight:600;margin-bottom:.3rem;color:var(--muted,#666);">Wysłane wiadomości <span class="en">Sent messages</span> (' + msgs.length + ')</div>';
      msgs.forEach(function(m) {
        var item = document.createElement('div');
        item.className = 'cc-sent-item';
        var dt = m.created_at ? m.created_at.replace('T',' ').slice(0,16) : '';
        var readCount = (m.read_by || []).length;
        item.innerHTML =
          '<div class="cc-sent-head">' +
            '<span class="cc-sent-subj">' + escH(m.subject) + '</span>' +
            '<span>' +
              '<span class="cc-sent-date">' + escH(dt) + '</span> ' +
              '<button class="cc-sent-del" data-mid="' + m.message_id + '">&#10005;</button>' +
            '</span>' +
          '</div>' +
          '<div class="cc-sent-groups">&#8594; ' + (m.target_groups || []).join(', ') + '</div>' +
          '<div class="cc-sent-stats">' + readCount + ' przeczytało <span class="en">read</span></div>';
        list.appendChild(item);
      });
      /* Delete buttons */
      list.querySelectorAll('.cc-sent-del').forEach(function(btn) {
        btn.addEventListener('click', async function() {
          const ok = await showConfirm({title:'Usunięcie wiadomości',message:'Usunąć wiadomość? / Delete message?',confirmText:'Usuń / Delete',type:'danger'});
          if (!ok) return;
          await fetch('/api/messages/' + btn.dataset.mid, { method: 'DELETE' });
          loadSentMessages();
        });
      });
      if (typeof applyBilingualMode === 'function') applyBilingualMode();
    } catch(e) { /* ignore */ }
  }

  function escH(s) {
    var d = document.createElement('div');
    d.textContent = s || '';
    return d.innerHTML;
  }

  /* Init */
  loadSentMessages();
})();
</script>
{% endif %}
{% endblock %}
