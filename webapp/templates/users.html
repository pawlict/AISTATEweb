{% extends "base.html" %}
{% block content %}
<div class="card" style="padding:1.5rem;">
  <h2 style="margin-top:0;">Zarządzanie użytkownikami <span class="en">User management</span></h2>
  <p style="color:var(--muted,#888);font-size:.85rem;">
    Twórz, edytuj, banuj i usuwaj użytkowników. Przypisuj role i resetuj hasła.
    <br><span class="en">Create, edit, ban and delete users. Assign roles and reset passwords.</span>
  </p>

  <div style="display:flex;justify-content:space-between;align-items:center;margin:1.2rem 0 .8rem;">
    <button class="btn" id="btnAddUser">Dodaj użytkownika <span class="en">Add user</span></button>
  </div>

  <table class="data-table" id="usersTable" style="width:100%;">
    <thead>
      <tr>
        <th>Użytkownik <br><span class="en">User</span></th>
        <th>Nazwa <br><span class="en">Name</span></th>
        <th>Rola / Grupa <br><span class="en">Role / Group</span></th>
        <th>Status</th>
        <th>Ostatnie logowanie <br><span class="en">Last login</span></th>
        <th>Akcje <br><span class="en">Actions</span></th>
      </tr>
    </thead>
    <tbody id="usersBody"></tbody>
  </table>
</div>

<!-- Bottom panels: role matrix + call center side by side -->
<div class="panels-row" style="display:flex;gap:1rem;margin-top:1rem;flex-wrap:wrap;align-items:flex-start;">

  <!-- Role-access matrix (CSS Grid layout) -->
  <div class="role-matrix-card" style="padding:.8rem 1rem;flex:1 1 480px;max-width:780px;">
    <h3 style="margin:0 0 .5rem;font-size:.82rem;">Ustawienia r&oacute;l &mdash; dost&#281;p do modu&#322;&oacute;w <span class="en">Role settings &mdash; module access</span></h3>
    <div id="roleMatrixGrid" class="rm-grid"></div>
  </div>

  <!-- Call Center -->
  {% if user and user.is_superadmin %}
  <div class="callcenter-card" style="padding:.8rem 1rem;flex:1 1 340px;max-width:560px;">
    <h3 style="margin:0 0 .5rem;font-size:.82rem;">Call Center <span class="en">Call Center</span></h3>
    <p style="color:var(--muted,#888);font-size:.74rem;margin:0 0 .6rem;">
      Wyślij wiadomość do wybranych grup użytkowników.
      <span class="en">Send a message to selected user groups.</span>
    </p>

    <!-- Compose form -->
    <div class="field" style="margin-bottom:.5rem;">
      <label for="ccSubject" style="font-size:.78rem;">Temat <span class="en">Subject</span></label>
      <input type="text" id="ccSubject" style="font-size:.85rem;" placeholder="Temat wiadomości..."/>
    </div>

    <div class="field" style="margin-bottom:.5rem;">
      <label style="font-size:.78rem;">Treść <span class="en">Content</span></label>
      <div class="cc-toolbar-wrap" id="ccToolbar">
        <div class="cc-toolbar">
          <button type="button" data-cmd="bold" title="Pogrubienie / Bold"><b>B</b></button>
          <button type="button" data-cmd="italic" title="Kursywa / Italic"><i>I</i></button>
          <button type="button" data-cmd="underline" title="Podkreślenie / Underline"><u>U</u></button>
          <button type="button" data-cmd="strikeThrough" title="Przekreślenie / Strike"><s>S</s></button>
          <span class="cc-sep"></span>
          <button type="button" data-cmd="insertUnorderedList" title="Lista / Bullet list">&#8226;</button>
          <button type="button" data-cmd="insertOrderedList" title="Numeracja / Numbered">1.</button>
          <span class="cc-sep"></span>
          <button type="button" data-cmd="justifyLeft" title="Do lewej / Align left">&#8676;</button>
          <button type="button" data-cmd="justifyCenter" title="Wyśrodkuj / Center">&#8596;</button>
        </div>
        <div class="cc-toolbar cc-toolbar-row2">
          <span class="cc-tb-label">Rozmiar:</span>
          <button type="button" class="cc-tb-size" data-size="1" title="Bardzo mały / X-Small">A</button>
          <button type="button" class="cc-tb-size" data-size="2" title="Mały / Small">A</button>
          <button type="button" class="cc-tb-size cc-tb-active" data-size="3" title="Normalny / Normal">A</button>
          <button type="button" class="cc-tb-size" data-size="4" title="Duży / Large">A</button>
          <button type="button" class="cc-tb-size" data-size="5" title="Bardzo duży / X-Large">A</button>
          <span class="cc-sep"></span>
          <span class="cc-tb-label">Kolor:</span>
          <button type="button" class="cc-tb-color cc-tb-active" data-color="" title="Domyślny / Default"><span class="cc-color-dot" style="background:#333;"></span></button>
          <button type="button" class="cc-tb-color" data-color="#e74c3c" title="Czerwony / Red"><span class="cc-color-dot" style="background:#e74c3c;"></span></button>
          <button type="button" class="cc-tb-color" data-color="#27ae60" title="Zielony / Green"><span class="cc-color-dot" style="background:#27ae60;"></span></button>
          <button type="button" class="cc-tb-color" data-color="#2980b9" title="Niebieski / Blue"><span class="cc-color-dot" style="background:#2980b9;"></span></button>
          <button type="button" class="cc-tb-color" data-color="#e67e22" title="Pomarańczowy / Orange"><span class="cc-color-dot" style="background:#e67e22;"></span></button>
          <button type="button" class="cc-tb-color" data-color="#8e44ad" title="Fioletowy / Purple"><span class="cc-color-dot" style="background:#8e44ad;"></span></button>
        </div>
      </div>
      <div class="cc-editor" id="ccEditor" contenteditable="true"></div>
    </div>

    <div class="field" style="margin-bottom:.6rem;">
      <label style="font-size:.78rem;">Grupy docelowe <span class="en">Target groups</span></label>
      <div id="ccTargetGroups" class="cc-groups"></div>
    </div>

    <div style="display:flex;gap:.5rem;justify-content:flex-end;align-items:center;">
      <div class="error" id="ccError" style="color:#e74c3c;font-size:.78rem;flex:1;"></div>
      <button class="btn" id="ccSend" style="font-size:.8rem;">Wyślij <span class="en">Send</span></button>
    </div>

    <!-- Sent messages list -->
    <div id="ccSentList" style="margin-top:.8rem;"></div>
  </div>
  {% endif %}

</div>

<style>
  .en { font-size: 70%; color: var(--muted, #999); font-style: italic; }
  .role-matrix-card { background: var(--card-bg, #fff); border-radius: 10px; box-shadow: 0 1px 8px rgba(0,0,0,.05); border: 1px solid var(--border, #e0e3e8); }
  /* CSS Grid role matrix */
  .rm-grid { display: grid; font-size: .72rem; gap: 0; border: 1px solid var(--border, #e0e3e8); border-radius: 6px; overflow: hidden; }
  .rm-grid .rm-cell { padding: .3rem .45rem; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--border, #eee); border-right: 1px solid var(--border, #eee); min-height: 1.8em; white-space: nowrap; }
  .rm-grid .rm-cell:last-child { border-right: none; }
  .rm-grid .rm-header { background: var(--card-bg, #f8f9fa); font-weight: 700; font-size: .64rem; color: var(--text, #333); }
  .rm-grid .rm-role-name { justify-content: flex-start; font-weight: 600; font-size: .72rem; }
  .rm-grid .rm-section { font-weight: 700; font-size: .64rem; color: var(--muted, #666); background: #f0f2f5; justify-content: flex-start; }
  .rm-grid .rm-check { color: #27ae60; font-weight: 700; font-size: .9rem; }
  .rm-grid .rm-no { color: #e74c3c; font-weight: 700; font-size: .85rem; }
  .rm-grid .rm-row:hover .rm-cell { background: rgba(74,108,247,.04); }

  /* Call Center panel */
  .callcenter-card { background: var(--card-bg, #fff); border-radius: 10px; box-shadow: 0 1px 8px rgba(0,0,0,.05); border: 1px solid var(--border, #e0e3e8); }
  .cc-toolbar-wrap { border: 1px solid var(--border, #ddd); border-bottom: none; border-radius: 6px 6px 0 0; background: #f8f9fa; overflow: hidden; }
  .cc-toolbar { display: flex; align-items: center; gap: 2px; padding: .3rem .4rem; }
  .cc-toolbar-row2 { border-top: 1px solid var(--border, #eee); padding-top: .25rem; }
  .cc-toolbar button { background: none; border: 1px solid transparent; border-radius: 3px; padding: .15rem .35rem; cursor: pointer; font-size: .78rem; color: var(--text, #333); line-height: 1; }
  .cc-toolbar button:hover { background: var(--border, #e0e3e8); }
  .cc-toolbar .cc-tb-active { background: var(--border, #e0e3e8); border-color: var(--muted, #999); }
  .cc-tb-label { font-size: .64rem; color: var(--muted, #888); font-weight: 600; margin-right: 2px; white-space: nowrap; }
  .cc-color-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; border: 1.5px solid rgba(0,0,0,.12); vertical-align: middle; }
  .cc-toolbar .cc-tb-color { padding: .15rem .22rem; }
  .cc-toolbar .cc-tb-color.cc-tb-active .cc-color-dot { border-color: var(--text, #333); box-shadow: 0 0 0 1px var(--text, #333); }
  .cc-toolbar .cc-tb-size { min-width: 20px; text-align: center; }
  .cc-toolbar .cc-tb-size[data-size="1"] { font-size: .58rem; }
  .cc-toolbar .cc-tb-size[data-size="2"] { font-size: .68rem; }
  .cc-toolbar .cc-tb-size[data-size="3"] { font-size: .78rem; }
  .cc-toolbar .cc-tb-size[data-size="4"] { font-size: .9rem; }
  .cc-toolbar .cc-tb-size[data-size="5"] { font-size: 1.02rem; }
  .cc-sep { width: 1px; height: 16px; background: var(--border, #ddd); margin: 0 3px; }
  .cc-editor { min-height: 120px; max-height: 250px; overflow-y: auto; padding: .5rem; border: 1px solid var(--border, #ddd); border-radius: 0 0 6px 6px; font-size: .85rem; line-height: 1.5; background: #fff; outline: none; }
  .cc-editor:focus { border-color: var(--accent, #4a6cf7); }
  .cc-editor ul, .cc-editor ol { margin: .3rem 0 .3rem 1.2rem; }
  .cc-groups { display: flex; flex-wrap: wrap; gap: .3rem; }
  .cc-groups label { font-size: .74rem; display: flex; align-items: center; gap: .2rem; padding: .15rem .4rem; border: 1px solid var(--border, #ddd); border-radius: 4px; cursor: pointer; background: #fafafa; }
  .cc-groups label:hover { background: #f0f2f5; }
  .cc-groups input { margin: 0; }
  .cc-sent-item { background: #f8f9fa; border: 1px solid var(--border, #eee); border-radius: 6px; padding: .5rem .6rem; margin-bottom: .4rem; font-size: .76rem; }
  .cc-sent-item .cc-sent-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: .25rem; }
  .cc-sent-item .cc-sent-subj { font-weight: 600; }
  .cc-sent-item .cc-sent-date { color: var(--muted, #999); font-size: .68rem; }
  .cc-sent-item .cc-sent-groups { color: var(--muted, #888); font-size: .68rem; }
  .cc-sent-item .cc-sent-stats { color: var(--muted, #888); font-size: .68rem; margin-top: .2rem; }
  .cc-sent-item .cc-sent-del { background: none; border: none; color: #e74c3c; cursor: pointer; font-size: .72rem; padding: .1rem .3rem; }
  .cc-sent-item .cc-sent-del:hover { text-decoration: underline; }
</style>

<!-- Modal: Add/Edit User -->
<div id="userModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:440px;">
    <h3 id="userModalTitle">Dodaj użytkownika <span class="en">Add user</span></h3>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="uUsername">Nazwa użytkownika <span class="en">Username</span></label>
      <input type="text" id="uUsername" autocomplete="off"/>
    </div>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="uDisplayName">Wyświetlana nazwa <span class="en">Display name</span></label>
      <input type="text" id="uDisplayName" autocomplete="off"/>
    </div>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="uPassword">Hasło (min. 6 znaków) <span class="en">Password (min. 6 chars)</span></label>
      <input type="password" id="uPassword" autocomplete="new-password"/>
    </div>
    <div class="field" style="margin-bottom:.8rem;">
      <label style="cursor:pointer;">
        <input type="checkbox" id="uIsAdmin"/> <span>Konto administratora <span class="en">Admin account</span></span>
      </label>
    </div>
    <div id="roleSection">
      <div class="field" style="margin-bottom:.8rem;">
        <label for="uRole">Rola / Grupa użytkownika <span class="en">User role / group</span></label>
        <select id="uRole"></select>
        <div id="uRoleModules" style="margin-top:.35rem;font-size:.76rem;color:var(--muted,#888);line-height:1.4;"></div>
      </div>
    </div>
    <div id="adminRoleSection" style="display:none;">
      <div class="field" style="margin-bottom:.8rem;">
        <label>Role administratora <span class="en">Admin roles</span></label>
        <div id="adminRolesChecks"></div>
      </div>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.2rem;">
      <button class="btn btn-secondary" id="userModalCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" id="userModalSave">Zapisz <span class="en">Save</span></button>
    </div>
    <div class="error" id="userModalError" style="color:#e74c3c;font-size:.85rem;margin-top:.5rem;min-height:1.2em;"></div>
  </div>
</div>

<!-- Modal: Change Role -->
<div id="changeRoleModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:420px;">
    <h3>Zmień rolę <span class="en">Change role</span></h3>
    <p style="margin-bottom:.8rem;">Użytkownik: <span class="en">User:</span> <b id="crUsername"></b></p>
    <div class="field" style="margin-bottom:.8rem;">
      <label style="cursor:pointer;">
        <input type="checkbox" id="crIsAdmin"/> <span>Konto administratora <span class="en">Admin account</span></span>
      </label>
    </div>
    <div id="crRoleSection">
      <div class="field" style="margin-bottom:.8rem;">
        <label for="crRole">Rola / Grupa <span class="en">Role / Group</span></label>
        <select id="crRole"></select>
        <div id="crRoleModules" style="margin-top:.35rem;font-size:.76rem;color:var(--muted,#888);line-height:1.4;"></div>
      </div>
    </div>
    <div id="crAdminRoleSection" style="display:none;">
      <div class="field" style="margin-bottom:.8rem;">
        <label>Role administratora <span class="en">Admin roles</span></label>
        <div id="crAdminRolesChecks"></div>
      </div>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.2rem;">
      <button class="btn btn-secondary" id="crCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" id="crSave">Zapisz <span class="en">Save</span></button>
    </div>
    <div class="error" id="crError" style="color:#e74c3c;font-size:.85rem;margin-top:.5rem;min-height:1.2em;"></div>
  </div>
</div>

<!-- Modal: Confirm Delete -->
<div id="deleteModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:360px;text-align:center;">
    <h3>Potwierdzenie usunięcia <span class="en">Confirm deletion</span></h3>
    <p id="deleteMsg"></p>
    <div style="display:flex;gap:.5rem;justify-content:center;margin-top:1rem;">
      <button class="btn btn-secondary" id="deleteCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" style="background:#e74c3c;" id="deleteConfirm">Usuń <span class="en">Delete</span></button>
    </div>
  </div>
</div>

<!-- Modal: Reset Password -->
<div id="resetPwModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:380px;">
    <h3>Reset hasła <span class="en">Reset password</span></h3>
    <p style="margin-bottom:.8rem;">Użytkownik: <span class="en">User:</span> <b id="rpUsername"></b></p>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="rpPassword">Nowe hasło (min. 6 znaków) <span class="en">New password (min. 6 chars)</span></label>
      <input type="password" id="rpPassword" autocomplete="new-password"/>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem;">
      <button class="btn btn-secondary" id="rpCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" id="rpConfirm">Zmień hasło <span class="en">Change password</span></button>
    </div>
    <div class="error" id="rpError" style="color:#e74c3c;font-size:.85rem;margin-top:.5rem;min-height:1.2em;"></div>
  </div>
</div>

<!-- Modal: Approve Pending User -->
<div id="approveModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:440px;">
    <h3>Zatwierdź użytkownika <span class="en">Approve user</span></h3>
    <p style="margin-bottom:.8rem;">
      Przypisz rolę dla: <span class="en">Assign role for:</span>
      <b id="approveUsername"></b>
    </p>
    <div class="field" style="margin-bottom:.8rem;">
      <label style="cursor:pointer;">
        <input type="checkbox" id="approveIsAdmin"/> <span>Konto administratora <span class="en">Admin account</span></span>
      </label>
    </div>
    <div id="approveRoleSection">
      <div class="field" style="margin-bottom:.8rem;">
        <label for="approveRole">Rola / Grupa użytkownika <span class="en">User role / group</span></label>
        <select id="approveRole"></select>
        <div id="approveRoleModules" style="margin-top:.35rem;font-size:.76rem;color:var(--muted,#888);line-height:1.4;"></div>
      </div>
    </div>
    <div id="approveAdminRoleSection" style="display:none;">
      <div class="field" style="margin-bottom:.8rem;">
        <label>Role administratora <span class="en">Admin roles</span></label>
        <div id="approveAdminRolesChecks"></div>
      </div>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.2rem;">
      <button class="btn btn-secondary" id="approveCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" style="background:#27ae60;" id="approveConfirm">Zatwierdź <span class="en">Approve</span></button>
    </div>
    <div class="error" id="approveError" style="color:#e74c3c;font-size:.85rem;margin-top:.5rem;min-height:1.2em;"></div>
  </div>
</div>

<!-- Modal: Reject Pending User -->
<div id="rejectModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:360px;text-align:center;">
    <h3>Odrzuć rejestrację <span class="en">Reject registration</span></h3>
    <p id="rejectMsg"></p>
    <div style="display:flex;gap:.5rem;justify-content:center;margin-top:1rem;">
      <button class="btn btn-secondary" id="rejectCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" style="background:#e74c3c;" id="rejectConfirm">Odrzuć <span class="en">Reject</span></button>
    </div>
  </div>
</div>

<!-- Modal: Ban -->
<div id="banModal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:420px;">
    <h3>Zbanuj użytkownika <span class="en">Ban user</span></h3>
    <p style="margin-bottom:.8rem;">Użytkownik: <span class="en">User:</span> <b id="banUsername"></b></p>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="banDuration">Czas trwania bana <span class="en">Ban duration</span></label>
      <select id="banDuration">
        <option value="1h">1 godzina <span class="en">1 hour</span></option>
        <option value="6h">6 godzin <span class="en">6 hours</span></option>
        <option value="24h">24 godziny <span class="en">24 hours</span></option>
        <option value="3d">3 dni <span class="en">3 days</span></option>
        <option value="7d">7 dni <span class="en">7 days</span></option>
        <option value="30d">30 dni <span class="en">30 days</span></option>
        <option value="perm" selected>Permanentny <span class="en">Permanent</span></option>
      </select>
    </div>
    <div class="field" style="margin-bottom:.8rem;">
      <label for="banReason">Powód (opcjonalnie) <span class="en">Reason (optional)</span></label>
      <input type="text" id="banReason" placeholder="np. naruszenie regulaminu..."/>
    </div>
    <div class="field" style="margin-bottom:.8rem;">
      <label style="cursor:pointer;">
        <input type="checkbox" id="banShowExpiry" checked/>
        <span>Pokaż użytkownikowi datę końca bana <span class="en">Show ban expiry date to user</span></span>
      </label>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem;">
      <button class="btn btn-secondary" id="banCancel">Anuluj <span class="en">Cancel</span></button>
      <button class="btn" style="background:#e74c3c;" id="banConfirm">Zbanuj <span class="en">Ban</span></button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/users.js?v={{ app_version }}"></script>
{% if user and user.is_superadmin %}
<script>
/* Call Center — rich text messaging for Główny Opiekun */
(function(){
  'use strict';

  /* All target groups: user roles + admin roles + "all" */
  var ALL_GROUPS = [
    { key: 'all', pl: 'Wszyscy', en: 'Everyone' },
    { key: 'Transkryptor', pl: 'Transkryptor', en: 'Transcriber' },
    { key: 'Lingwista', pl: 'Lingwista', en: 'Linguist' },
    { key: 'Analityk', pl: 'Analityk', en: 'Analyst' },
    { key: 'Dialogista', pl: 'Dialogista', en: 'Dialogue Spec.' },
    { key: 'Strateg', pl: 'Strateg', en: 'Strategist' },
    { key: 'Mistrz Sesji', pl: 'Mistrz Sesji', en: 'Session Master' },
    { key: 'Architekt Funkcji', pl: 'Architekt Funkcji', en: 'Function Architect' },
    { key: 'Stra\u017cnik Dost\u0119pu', pl: 'Stra\u017cnik Dost\u0119pu', en: 'Access Guardian' },
    { key: 'G\u0142\u00f3wny Opiekun', pl: 'G\u0142\u00f3wny Opiekun', en: 'Main Guardian' },
  ];

  /* Build target group checkboxes */
  var groupsEl = document.getElementById('ccTargetGroups');
  if (groupsEl) {
    ALL_GROUPS.forEach(function(g) {
      var label = document.createElement('label');
      label.innerHTML = '<input type="checkbox" value="' + g.key + '"/> ' + g.pl + ' <span class="en">' + g.en + '</span>';
      groupsEl.appendChild(label);
    });
  }

  /* Rich text toolbar */
  var toolbar = document.getElementById('ccToolbar');
  var editor = document.getElementById('ccEditor');
  if (toolbar && editor) {
    /* Standard commands (bold, italic, etc.) */
    toolbar.addEventListener('click', function(e) {
      var btn = e.target.closest('button[data-cmd]');
      if (!btn) return;
      e.preventDefault();
      document.execCommand(btn.dataset.cmd, false, null);
      editor.focus();
    });
    /* Font size buttons */
    toolbar.querySelectorAll('.cc-tb-size').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toolbar.querySelectorAll('.cc-tb-size').forEach(function(b) { b.classList.remove('cc-tb-active'); });
        btn.classList.add('cc-tb-active');
        document.execCommand('fontSize', false, btn.dataset.size);
        editor.focus();
      });
    });
    /* Font color buttons */
    toolbar.querySelectorAll('.cc-tb-color').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toolbar.querySelectorAll('.cc-tb-color').forEach(function(b) { b.classList.remove('cc-tb-active'); });
        btn.classList.add('cc-tb-active');
        if (btn.dataset.color) {
          document.execCommand('foreColor', false, btn.dataset.color);
        } else {
          document.execCommand('removeFormat', false, null);
        }
        editor.focus();
      });
    });
  }

  /* Send message */
  var sendBtn = document.getElementById('ccSend');
  var errEl = document.getElementById('ccError');
  if (sendBtn) {
    sendBtn.addEventListener('click', async function() {
      errEl.textContent = '';
      var subject = document.getElementById('ccSubject').value.trim();
      var content = editor.innerHTML.trim();
      var groups = [];
      document.querySelectorAll('#ccTargetGroups input:checked').forEach(function(cb) {
        groups.push(cb.value);
      });
      if (!subject) { errEl.textContent = 'Podaj temat / Enter subject'; return; }
      if (!content || content === '<br>') { errEl.textContent = 'Wpisz treść / Enter content'; return; }
      if (groups.length === 0) { errEl.textContent = 'Wybierz grupy / Select groups'; return; }

      try {
        var res = await fetch('/api/messages', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ subject: subject, content: content, target_groups: groups }),
        });
        var data = await res.json();
        if (!res.ok) { errEl.textContent = data.message || 'Error'; return; }
        /* Clear form */
        document.getElementById('ccSubject').value = '';
        editor.innerHTML = '';
        document.querySelectorAll('#ccTargetGroups input:checked').forEach(function(cb) { cb.checked = false; });
        loadSentMessages();
      } catch(e) {
        errEl.textContent = 'Connection error';
      }
    });
  }

  /* Load & render sent messages */
  async function loadSentMessages() {
    var list = document.getElementById('ccSentList');
    if (!list) return;
    try {
      var res = await fetch('/api/messages');
      var data = await res.json();
      if (data.status !== 'ok') return;
      var msgs = data.messages || [];
      if (msgs.length === 0) {
        list.innerHTML = '<div style="color:var(--muted,#999);font-size:.74rem;">Brak wiadomości <span class="en">No messages</span></div>';
        return;
      }
      list.innerHTML = '<div style="font-size:.74rem;font-weight:600;margin-bottom:.3rem;color:var(--muted,#666);">Wysłane wiadomości <span class="en">Sent messages</span> (' + msgs.length + ')</div>';
      msgs.forEach(function(m) {
        var item = document.createElement('div');
        item.className = 'cc-sent-item';
        var dt = m.created_at ? m.created_at.replace('T',' ').slice(0,16) : '';
        var readCount = (m.read_by || []).length;
        item.innerHTML =
          '<div class="cc-sent-head">' +
            '<span class="cc-sent-subj">' + escH(m.subject) + '</span>' +
            '<span>' +
              '<span class="cc-sent-date">' + escH(dt) + '</span> ' +
              '<button class="cc-sent-del" data-mid="' + m.message_id + '">&#10005;</button>' +
            '</span>' +
          '</div>' +
          '<div class="cc-sent-groups">&#8594; ' + (m.target_groups || []).join(', ') + '</div>' +
          '<div class="cc-sent-stats">' + readCount + ' przeczytało <span class="en">read</span></div>';
        list.appendChild(item);
      });
      /* Delete buttons */
      list.querySelectorAll('.cc-sent-del').forEach(function(btn) {
        btn.addEventListener('click', async function() {
          if (!confirm('Usunąć wiadomość? / Delete message?')) return;
          await fetch('/api/messages/' + btn.dataset.mid, { method: 'DELETE' });
          loadSentMessages();
        });
      });
      if (typeof applyBilingualMode === 'function') applyBilingualMode();
    } catch(e) { /* ignore */ }
  }

  function escH(s) {
    var d = document.createElement('div');
    d.textContent = s || '';
    return d.innerHTML;
  }

  /* Init */
  loadSentMessages();
})();
</script>
{% endif %}
{% endblock %}
