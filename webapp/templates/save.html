{% extends "base.html" %}
{% block content %}
<div class="card">
  <h1 class="h1">Zapis / Projekty</h1>

  <div class="grid">
    <div>
      <div class="label">Bieżący projekt (ID)</div>
      <input class="input" id="pid" value="{{ current_project or '' }}" placeholder="auto (localStorage)"/>
      <div class="small">Możesz wkleić ID i kliknąć „Ustaw jako bieżący”.</div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn" id="set_pid">Ustaw jako bieżący</button>
        <button class="btn secondary" id="new_pid">Utwórz nowy</button>
      </div>

      <div class="hr"></div>

      <div class="label">Eksport</div>
      <div class="row">
        <a class="btn secondary" id="export_zip" href="#">Eksportuj ZIP bieżącego projektu</a>
      </div>
      <div class="small">Eksportuje folder projektu (audio, wyniki, raporty, metadata).</div>
      <div class="hr"></div>

      <div class="label">Raporty</div>
      <div class="row" style="flex-wrap:wrap">
        <a class="btn secondary" href="#" onclick="event.preventDefault(); downloadReport('txt')">TXT</a>
        <a class="btn secondary" href="#" onclick="event.preventDefault(); downloadReport('html')">HTML</a>
        <a class="btn secondary" href="#" onclick="event.preventDefault(); downloadReport('pdf')">PDF</a>
        <label class="small" style="display:inline-flex; align-items:center; gap:8px">
          <input type="checkbox" id="include_logs"/> dołącz logi
        </label>
      </div>
      <div class="small">Raport jest generowany z plików <code>transcript.txt</code> / <code>diarized.txt</code> w folderze projektu.</div>

    </div>

    <div>
      <div class="label">Lista projektów</div>
      <div class="logbox" id="projects_box"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn secondary" id="projects_refresh">Odśwież</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function showProjects(){
  const j = await api("/api/projects");
  const lines = j.projects.map(p => `${p.project_id}  |  ${p.created_at || ""}  |  ${p.name || "projekt"}`);
  document.getElementById("projects_box").textContent = lines.join("\n");
}
document.getElementById("projects_refresh").addEventListener("click", showProjects);

document.getElementById("set_pid").addEventListener("click", ()=>{
  const v = document.getElementById("pid").value.trim();
  AISTATE.projectId = v || "";
  location.reload();
});
document.getElementById("new_pid").addEventListener("click", async ()=>{
  const j = await api("/api/projects/new", {method:"POST"});
  AISTATE.projectId = j.project_id;
  location.reload();
});

document.getElementById("export_zip").addEventListener("click", async (e)=>{
  e.preventDefault();
  const pid = await ensureProject();
  window.location = `/api/projects/${pid}/export.zip`;
});

(async()=>{ await showProjects(); })();
</script>
{% endblock %}
