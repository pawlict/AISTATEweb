{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="card-title">
    <span data-i18n="admin.gpu.title">Ustawienia GPU • Menedżer GPU</span>
  </div>
  <div class="small muted" style="margin-top:6px" data-i18n="admin.gpu.subtitle">
    Monitoruj GPU, limity współbieżności i kolejkę zadań. (Autoryzacja później.)
  </div>

  <div class="hr"></div>

  <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
    <div class="card" style="margin:0">
      <div class="label" data-i18n="admin.gpu.config">Configuration</div>
      <div class="small muted" data-i18n="admin.gpu.config_desc">
        Limits apply to transcription/diarization tasks started from this server.
      </div>

      <div style="margin-top:10px">
        <div class="small muted" data-i18n="admin.gpu.mem_fraction">GPU memory fraction (soft limit)</div>
        <input id="gpu_mem_fraction" class="input" type="number" min="0.3" max="0.98" step="0.01" value="0.85" />
      </div>

      <div style="margin-top:10px">
        <div class="small muted" data-i18n="admin.gpu.slots_per_gpu">Slots per GPU</div>
        <input id="gpu_slots_per_gpu" class="input" type="number" min="1" max="8" step="1" value="1" />
      </div>

      <div style="margin-top:10px">
        <div class="small muted" data-i18n="admin.gpu.cpu_slots">CPU slots (fallback)</div>
        <input id="gpu_cpu_slots" class="input" type="number" min="1" max="16" step="1" value="1" />
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
        <button id="gpu_cfg_save" class="btn" data-i18n="admin.gpu.save">Save</button>
        <span id="gpu_cfg_msg" class="small muted"></span>
      </div>

      <div class="small muted" style="margin-top:10px" data-i18n="admin.gpu.hint">
        Tip: set 0.70–0.85 to keep VRAM headroom and avoid UI freezes.
      </div>
    </div>

    <div class="card" style="margin:0">
      <div class="label" data-i18n="admin.gpu.status">Status</div>
      <div id="gpu_status_summary" class="small muted" style="margin-top:6px"></div>

      <div style="margin-top:10px; overflow:auto;">
        <table class="table" style="min-width:520px">
          <thead>
            <tr>
              <th data-i18n="admin.gpu.col.device">Device</th>
              <th data-i18n="admin.gpu.col.name">Name</th>
              <th data-i18n="admin.gpu.col.vram">VRAM</th>
              <th data-i18n="admin.gpu.col.running">Running</th>
              <th data-i18n="admin.gpu.col.slots">Slots</th>
            </tr>
          </thead>
          <tbody id="gpu_table_body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="hr"></div>

  <div class="card" style="margin:0">
    <div class="label" data-i18n="admin.gpu.jobs">Jobs</div>
    <div class="small muted" data-i18n="admin.gpu.jobs_desc">
      Queued jobs will start automatically when a GPU slot is free.
    </div>

    <div style="margin-top:10px; overflow:auto;">
      <table class="table" style="min-width:1080px">
        <thead>
          <tr>
            <th data-i18n="admin.gpu.jobs.col.when">Created</th>
            <th data-i18n="admin.gpu.jobs.col.task">Task</th>
            <th data-i18n="admin.gpu.jobs.col.kind">Kind</th>
            <th data-i18n="admin.gpu.jobs.col.job_type">Job type</th>
            <th data-i18n="admin.gpu.jobs.col.priority">Priority</th>
            <th data-i18n="admin.gpu.jobs.col.project">Project</th>
            <th data-i18n="admin.gpu.jobs.col.status">Status</th>
            <th data-i18n="admin.gpu.jobs.col.device">Device</th>
            <th data-i18n="admin.gpu.jobs.col.actions">Actions</th>
          </tr>
        </thead>
        <tbody id="gpu_jobs_body"></tbody>
      </table>
    </div>


  </div>

    <div class="grid prio-grid" style="grid-template-columns: 520px 1fr; gap: 16px; margin-top:16px; align-items:start;">
    <div class="card prio-card" style="margin:0">
      <div class="label" data-i18n="admin.gpu.priorities">Job priorities</div>
      <div class="small muted" data-i18n="admin.gpu.priorities_desc" style="margin-top:6px">
        Set the order (1 = highest). Drag icons to reorder.
      </div>

      <style>
        /* Priority order list (scoped to this page) */
        .prio-grid{ }
        @media (max-width: 980px){
          .prio-grid{ grid-template-columns: 1fr !important; }
        }

        .prio-list{ margin-top:10px; }

        .prio-item{
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap:12px;
          padding:10px 10px;
          border:1px solid rgba(255,255,255,0.08);
          border-radius:14px;
          background: rgba(255,255,255,0.02);
        }
        .prio-item + .prio-item{ margin-top:8px; }

        .prio-left{ display:flex; align-items:center; gap:10px; min-width:0; }
        .prio-right{ display:flex; align-items:center; gap:10px; }

        .prio-rank{
          width:28px; height:28px;
          display:flex; align-items:center; justify-content:center;
          border-radius:10px; font-weight:700;
          background: rgba(255,255,255,0.08);
        }
        .prio-handle{
          cursor:grab; user-select:none; opacity:.85;
          font-size:18px; line-height:1;
          padding:2px 6px;
          border-radius:8px;
          background: rgba(255,255,255,0.04);
        }

        /* 30% bigger icons */
        .prio-icon{
          position:relative;
          width:52px; height:52px;
          display:flex; align-items:center; justify-content:center;
          border-radius:16px;
          background: rgba(255,255,255,0.04);
          border:1px solid rgba(255,255,255,0.08);
        }
        .prio-icon svg{ width:26px; height:26px; display:block; }
        .prio-icon svg path, .prio-icon svg rect, .prio-icon svg circle, .prio-icon svg line, .prio-icon svg polyline, .prio-icon svg polygon{
          stroke: currentColor; fill:none; stroke-linecap:round; stroke-linejoin:round; stroke-width:2.0
        }
        .prio-icon svg .brush{ stroke-width:3.2; opacity:.28 }

        /* Tooltip bubble (dymek) */
        .prio-icon[data-tip]:hover::after{
          content: attr(data-tip);
          position:absolute;
          left:50%;
          transform: translateX(-50%);
          bottom: calc(100% + 10px);
          padding: 6px 10px;
          color: rgba(255,255,255,0.98);
          font-weight: 600;
          background: rgba(10,10,10,0.94);
          border: 1px solid rgba(255,255,255,0.28);
          border-radius: 10px;
          font-size: 12px;
          white-space: nowrap;
          z-index: 9999;
          box-shadow: 0 6px 18px rgba(0,0,0,0.45);
          text-shadow: 0 1px 0 rgba(0,0,0,0.65);
          pointer-events: none;
        }
        .prio-icon[data-tip]:hover::before{
          content:"";
          position:absolute;
          left:50%;
          transform: translateX(-50%);
          bottom: calc(100% + 4px);
          border: 6px solid transparent;
          border-top-color: rgba(0,0,0,0.78);
          z-index: 9998;
          pointer-events: none;
        }

        .prio-badge{
          position:absolute; right:-6px; bottom:-6px;
          width:20px; height:20px;
          border-radius:10px;
          display:flex; align-items:center; justify-content:center;
          font-size:12px;
          background: rgba(0,0,0,0.55);
          border:1px solid rgba(255,255,255,0.12);
        }

        .prio-num{
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
          font-size:12px;
          opacity:.75;
        }
        .prio-move{ display:flex; gap:6px; }

        .prio-item[draggable="true"]{ -webkit-user-drag: element; }
        .prio-item.dragging{ opacity:.55; }
        .prio-item.drop-target{ outline: 2px dashed rgba(255,255,255,0.25); outline-offset: 2px; }

        /* Match sidebar icon accent colors */
        .prio-item[data-icon="transcription"] .prio-icon svg .brush{stroke: var(--brand-sky); opacity:.42}
        .prio-item[data-icon="diarization"] .prio-icon svg .brush{stroke: var(--brand-cyan); opacity:.50}
        .prio-item[data-icon="analysis"] .prio-icon svg .brush{stroke: var(--brand-purple); opacity:.35}
        .prio-item[data-icon="translation"] .prio-icon svg .brush{stroke: var(--brand-cyan); opacity:.45}

        /* Tiny accessibility helper */
        .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
      </style>

      <div id="prio_list" class="prio-list"></div>

      <div style="margin-top:10px; display:flex; align-items:center;">
        <span id="gpu_prio_msg" class="small muted"></span>
      </div>
    </div>

    <!-- empty space reserved for future admin widgets -->
    <div></div>
  </div></div>
</div>

<script src="/static/admin_gpu.js?v={{ app_version }}"></script>
{% endblock %}
