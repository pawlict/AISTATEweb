{% extends "base.html" %}
{% block content %}
<div class="card">
  <h1 class="h1" data-i18n="asr.page_title">Ustawienia ASR</h1>

  <div class="grid">
    <div class="subcard">

      <style>
        /* Inline layout only for ASR Settings page */
        .asr-toprow{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px; }
        .asr-toprow .spacer{ flex:1 1 auto; }

        /* Per-model row: controls + description in the SAME row */
        .asr-model-row{ display:grid; grid-template-columns: minmax(360px, 520px) 1fr; gap:14px; align-items:start; }
        .asr-model-left{ min-width: 0; }
        .asr-model-right{ min-width: 0; }

        .asr-info-box{
          border: 1px solid rgba(255,255,255,0.10);
          background: rgba(0,0,0,0.08);
          border-radius: 10px;
          padding: 10px 12px;
        }
        .asr-info-title{ font-weight:600; margin-bottom:6px; }
        .asr-install-row{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
        .asr-install-row .small{ margin:0; }

        .asr-kv{ display:grid; grid-template-columns: 160px 1fr; gap:6px 12px; }
        .asr-kv .kv-h{ font-weight:600; opacity:.95; }

        .asr-warn{
          border: 1px solid rgba(185, 28, 28, 0.22);
          background: rgba(185, 28, 28, 0.10);
          border-radius: 10px;
          padding: 8px 10px;
          margin-top: 10px;
          font-size: 12px;
          color: var(--text);
        }

        @media (max-width: 980px){
          .asr-model-row{ grid-template-columns: 1fr; }
        }

        .asr-badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700; letter-spacing:.02em; }
        .asr-badge.offline-yes{ border:1px solid rgba(16,185,129,0.35); background: rgba(16,185,129,0.12); }
        .asr-badge.offline-no{ border:1px solid rgba(239,68,68,0.35); background: rgba(239,68,68,0.10); }
        .asr-offline-strong{ font-weight:800; }
        .asr-reco{ border: 1px solid rgba(250, 204, 21, 0.25); background: rgba(250, 204, 21, 0.10); border-radius: 10px; padding: 10px 12px; margin-top: 10px; }
        .asr-reco .title{ font-weight:800; margin-bottom:6px; }
        .asr-list{ margin: 8px 0 0 18px; }
        .asr-list li{ margin: 4px 0; }
      </style>

      <!-- Task progress (top) -->
      <div class="label" data-i18n="asr.task_title"><i data-icon="document" data-size="14"></i> Postęp zadania</div>
      <div class="small"><span data-i18n="common.status">Status</span>: <span id="asr_task_status">—</span></div>
      <div class="small"><span data-i18n="common.progress">Postęp</span>: <span id="asr_task_pct">0%</span></div>
      <div class="progress" style="margin-top:10px"><div id="asr_task_bar"></div></div>

      <div class="hr"></div>

      <!-- HF Token (pyannote) -->
      <div class="label" data-i18n="settings.hf_label">Hugging Face Token (pyannote)</div>
      <input class="input" id="hf_token" type="password" data-i18n-placeholder="settings.hf_placeholder"
             placeholder="Paste your token (stored locally on the server)" value="{{ settings.hf_token or '' }}"/>
      <div class="small" data-i18n-html="settings.hf_hint_html">Token jest przechowywany w pliku <code>settings.json</code> w katalogu konfiguracji.</div>

      <div class="hr"></div>

      <!-- MODELS -->
      <div>
        <div class="label" data-i18n="asr.models_title"><i data-icon="settings" data-size="14"></i> Modele / silniki</div>
        <div class="small muted" data-i18n="asr.models_desc">Wybierz model, następnie kliknij „Instaluj”.</div>

        <div class="hr"></div>

        <!-- GROUP: Transcription -->
        <div class="label" data-i18n="asr.group.transcription"><i data-icon="notes" data-size="16"></i> Transkrypcja</div>
        <div class="small muted" data-i18n="asr.group.transcription_desc">Whisper i NeMo ASR (modele do transkrypcji).</div>

        <div class="hr"></div>

        <!-- Whisper (row: controls + description) -->
        <div class="asr-model-row">
          <div class="asr-model-left">
            <div class="label">Whisper</div>
            <div class="small" id="asr_whisper_status">—</div>
            <select id="asr_whisper_select" class="input" data-engine="whisper">
              <option value="" data-i18n="settings.llm_select_placeholder">Wybierz model…</option>
              {% for m in whisper_models %}
                <option value="{{m}}" {% if m==default_whisper_model %}selected{% endif %}>{{m}}</option>
              {% endfor %}
            </select>

            <div class="asr-install-row">
              <button class="btn primary mini" type="button" id="asr_whisper_install_btn" data-engine="whisper"><i data-icon="install" data-size="14"></i> <span data-i18n="asr.btn.install">Instaluj</span></button>
              <span class="small muted" id="asr_whisper_inline">—</span>
            </div>
            <div class="small muted" data-i18n="asr.whisper_hint" style="margin-top:6px;">Klasyczny Whisper (bez alignera). Najprostszy i stabilny wariant.</div>
          </div>

          <div class="asr-model-right">
            <div class="asr-info-box" id="asr_info_box_whisper">
              <div class="asr-info-title small"><i data-icon="info_circle" data-size="14"></i> <span data-i18n="asr.model_info">Informacje o modelu</span> — Whisper</div>
              <div class="small" id="asr_info_name_whisper">—</div>
              <div id="asr_info_body_whisper" class="small muted" style="margin-top:6px;"></div>
              <div class="asr-warn" id="asr_info_warning_whisper" style="display:none"></div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <!-- NeMo ASR (row: controls + description) -->
        <div class="asr-model-row">
          <div class="asr-model-left">
            <div class="label">NeMo ASR</div>
            <div class="small" id="asr_nemo_asr_status">—</div>
            <select id="asr_nemo_select" class="input" data-engine="nemo">
              <option value="" data-i18n="settings.llm_select_placeholder">Wybierz model…</option>
              {% for m in nemo_models %}
                <option value="{{m}}">{{m}}</option>
              {% endfor %}
            </select>

            <div class="asr-install-row">
              <button class="btn primary mini" type="button" id="asr_nemo_install_btn" data-engine="nemo"><i data-icon="install" data-size="14"></i> <span data-i18n="asr.btn.install">Instaluj</span></button>
              <span class="small muted" id="asr_nemo_inline">—</span>
            </div>
          </div>

          <div class="asr-model-right">
            <div class="asr-info-box" id="asr_info_box_nemo">
              <div class="asr-info-title small"><i data-icon="info_circle" data-size="14"></i> <span data-i18n="asr.model_info">Informacje o modelu</span> — NeMo ASR</div>
              <div class="small" id="asr_info_name_nemo">—</div>
              <div id="asr_info_body_nemo" class="small muted" style="margin-top:6px;"></div>
              <div class="asr-warn" id="asr_info_warning_nemo" style="display:none"></div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <!-- GROUP: Diarization -->
        <div class="label" data-i18n="asr.group.diarization"><i data-icon="transcription" data-size="16"></i> Diaryzacja</div>
        <div class="small muted" data-i18n="asr.group.diarization_desc">pyannote oraz NeMo diarization.</div>

        <div class="hr"></div>

        <!-- pyannote (row: controls + description) -->
        <div class="asr-model-row">
          <div class="asr-model-left">
            <div class="label">pyannote</div>
            <div class="small" id="asr_pyannote_status">—</div>
            <select id="asr_pyannote_select" class="input" data-engine="pyannote">
              <option value="" data-i18n="settings.llm_select_placeholder">Wybierz model…</option>
              {% for p in pyannote_pipelines %}
                <option value="{{p}}">{{p}}</option>
              {% endfor %}
            </select>

            <div class="asr-install-row">
              <button class="btn primary mini" type="button" id="asr_pyannote_install_btn" data-engine="pyannote"><i data-icon="install" data-size="14"></i> <span data-i18n="asr.btn.install">Instaluj</span></button>
              <span class="small muted" id="asr_pyannote_inline">—</span>
            </div>
          </div>

          <div class="asr-model-right">
            <div class="asr-info-box" id="asr_info_box_pyannote">
              <div class="asr-info-title small"><i data-icon="info_circle" data-size="14"></i> <span data-i18n="asr.model_info">Informacje o modelu</span> — pyannote</div>
              <div class="small" id="asr_info_name_pyannote">—</div>
              <div id="asr_info_body_pyannote" class="small muted" style="margin-top:6px;"></div>
              <div class="asr-warn" id="asr_info_warning_pyannote" style="display:none"></div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <!-- NeMo Diarization (row: controls + description) -->
        <div class="asr-model-row">
          <div class="asr-model-left">
            <div class="label">NeMo Diarization</div>
            <div class="small" id="asr_nemo_diar_status">—</div>
            <select id="asr_nemo_diar_select" class="input" data-engine="nemo_diar">
              <option value="" data-i18n="settings.llm_select_placeholder">Wybierz model…</option>
              {% for m in nemo_diarization_models %}
                <option value="{{m}}">{{m}}</option>
              {% endfor %}
            </select>

            <div class="asr-install-row">
              <button class="btn primary mini" type="button" id="asr_nemo_diar_install_btn" data-engine="nemo_diar"><i data-icon="install" data-size="14"></i> <span data-i18n="asr.btn.install">Instaluj</span></button>
              <span class="small muted" id="asr_nemo_diar_inline">—</span>
            </div>
          </div>

          <div class="asr-model-right">
            <div class="asr-info-box" id="asr_info_box_nemo_diar">
              <div class="asr-info-title small"><i data-icon="info_circle" data-size="14"></i> <span data-i18n="asr.model_info">Informacje o modelu</span> — NeMo Diarization</div>
              <div class="small" id="asr_info_name_nemo_diar">—</div>
              <div id="asr_info_body_nemo_diar" class="small muted" style="margin-top:6px;"></div>
              <div class="asr-warn" id="asr_info_warning_nemo_diar" style="display:none"></div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <!-- GROUP: Sound Detection -->
        <div class="label" data-i18n="asr.group.sound_detection"><i data-icon="speaker" data-size="14"></i> Detekcja dźwięków tła</div>
        <div class="small muted" data-i18n="asr.group.sound_detection_desc">Modele do wykrywania dźwięków w tle (szczekanie, kaszlenie, muzyka, TV itp.).</div>

        <div class="hr"></div>

        <!-- Sound Detection Models -->
        <div class="asr-model-row">
          <div class="asr-model-left">
            <div class="label">Sound Detection</div>
            <div class="small" id="asr_sound_detection_status">—</div>
            <select id="asr_sound_detection_select" class="input" data-engine="sound_detection">
              <option value="" data-i18n="settings.llm_select_placeholder">Wybierz model…</option>
              <option value="yamnet">YAMNet (14 MB, szybki)</option>
              <option value="panns_cnn6">PANNs CNN6 (20 MB, szybki)</option>
              <option value="panns_cnn14">PANNs CNN14 (300 MB, dokładny)</option>
              <option value="beats">BEATs (90 MB, najdokładniejszy)</option>
            </select>

            <div class="asr-install-row">
              <button class="btn primary mini" type="button" id="asr_sound_detection_install_btn" data-engine="sound_detection"><i data-icon="install" data-size="14"></i> <span data-i18n="asr.btn.install">Instaluj</span></button>
              <span class="small muted" id="asr_sound_detection_inline">—</span>
            </div>
            <div class="small muted" style="margin-top:6px;">Wykrywa dźwięki tła: szczekanie psa, kaszlenie, muzyka, TV, syreny, kroki itp.</div>
          </div>

          <div class="asr-model-right">
            <div class="asr-info-box" id="asr_info_box_sound_detection">
              <div class="asr-info-title small"><i data-icon="info_circle" data-size="14"></i> <span data-i18n="asr.model_info">Informacje o modelu</span> — Sound Detection</div>
              <div class="small" id="asr_info_name_sound_detection">—</div>
              <div id="asr_info_body_sound_detection" class="small muted" style="margin-top:6px;"></div>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/asr_settings.js?v={{ app_version }}&_={{ static_ts }}"></script>
<script>
  // Auto-save HF token (paste => immediate, typing => debounced)
  (function(){
    const hf = document.getElementById("hf_token");
    if(!hf) return;
    let hfTimer = null;
    async function saveHf(){
      try{
        await api("/api/settings", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ hf_token: hf.value })
        });
      }catch(e){ console.warn("HF token save error:", e); }
    }
    hf.addEventListener("paste", ()=> setTimeout(saveHf, 0));
    hf.addEventListener("input", ()=>{ clearTimeout(hfTimer); hfTimer = setTimeout(saveHf, 800); });
    hf.addEventListener("change", saveHf);
  })();
</script>
{% endblock %}
