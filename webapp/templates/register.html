<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Rejestracja — {{ app_name }}</title>
  <link rel="stylesheet" href="/static/app.css"/>
  <script src="/static/ui.js?v={{ app_version }}"></script>
  <style>
    body { background: var(--bg, #f0f2f5); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; font-family: var(--font, 'Segoe UI', system-ui, sans-serif); }
    .reg-card { background: var(--card-bg, #fff); border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,.08); padding: 2.5rem 2rem; width: 100%; max-width: 420px; }
    .reg-logo { text-align: center; margin-bottom: 1.5rem; }
    .reg-logo img { height: 56px; }
    .reg-logo h1 { font-size: 1.2rem; margin: .5rem 0 0; color: var(--text, #1a1a2e); }
    .reg-logo .ver { font-size: .75rem; color: var(--muted, #888); }
    h2 { font-size: 1.05rem; margin: 0 0 .1rem; color: var(--text, #1a1a2e); }
    h2 + .en { font-size: .735rem; color: var(--muted, #999); font-style: italic; margin-bottom: .2rem; }
    .sub { font-size: .82rem; color: var(--muted, #888); margin: 0 0 .15rem; }
    .sub + .en { font-size: .574rem; color: var(--muted, #aaa); font-style: italic; margin: 0 0 1rem; }
    .en { color: var(--muted, #999); font-style: italic; }
    .field { margin-bottom: .9rem; }
    .field label { display: block; font-size: .85rem; font-weight: 600; margin-bottom: .3rem; color: var(--text, #1a1a2e); }
    .field label .en { font-size: .595rem; font-weight: 400; color: var(--muted, #999); margin-left: .3rem; }
    .field input { width: 100%; padding: .6rem .75rem; border: 1.5px solid var(--border, #d0d5dd); border-radius: 8px; font-size: .95rem; box-sizing: border-box; outline: none; transition: border-color .2s; }
    .field input:focus { border-color: var(--accent, #4a6cf7); }
    .reg-btn { width: 100%; padding: .7rem; border: none; border-radius: 8px; background: var(--accent, #4a6cf7); color: #fff; font-size: 1rem; font-weight: 600; cursor: pointer; transition: opacity .2s; }
    .reg-btn:hover { opacity: .9; }
    .reg-btn:disabled { opacity: .5; cursor: not-allowed; }
    .reg-btn .en { font-size: .7rem; font-weight: 400; font-style: italic; margin-left: .4rem; }
    .reg-error { color: #e74c3c; font-size: .85rem; margin-top: .75rem; min-height: 1.2em; text-align: center; }
    .reg-link { text-align: center; margin-top: 1rem; font-size: .85rem; }
    .reg-link a { color: var(--accent, #4a6cf7); text-decoration: none; font-weight: 600; }
    .reg-link .en { font-size: .595rem; color: var(--muted, #999); font-style: italic; }
    .lang-switch { display: flex; justify-content: center; gap: .3rem; margin-bottom: 1rem; }
    .lang-btn { padding: .25rem .6rem; border: 1.5px solid var(--border, #d0d5dd); border-radius: 6px; background: transparent; cursor: pointer; font-size: .78rem; font-weight: 600; color: var(--muted, #888); transition: all .2s; }
    .lang-btn.active { background: var(--accent, #4a6cf7); color: #fff; border-color: var(--accent, #4a6cf7); }
    .lang-btn:hover:not(.active) { border-color: var(--accent, #4a6cf7); color: var(--accent, #4a6cf7); }
  </style>
</head>
<body>
  <div class="reg-card">
    <div class="reg-logo">
      <img src="/static/logo.png" alt="Logo"/>
      <h1>{{ app_name }}</h1>
      <div class="ver">{{ app_version }}</div>
    </div>
    <div class="lang-switch">
      <button class="lang-btn active" data-lang="pl" id="langPl">PL</button>
      <button class="lang-btn" data-lang="en" id="langEn">EN</button>
    </div>
    <h2>Utwórz konto</h2>
    <div class="en">Create an account</div>
    <p class="sub">Po rejestracji konto musi zostać zatwierdzone przez administratora.</p>
    <div class="en">After registration, your account must be approved by an administrator.</div>
    <form id="regForm" autocomplete="on">
      <div class="field">
        <label for="username">Nazwa użytkownika <span class="en">Username</span></label>
        <input type="text" id="username" name="username" autocomplete="username" required autofocus minlength="3"/>
      </div>
      <div class="field">
        <label for="display_name">Wyświetlana nazwa (opcjonalna) <span class="en">Display name (optional)</span></label>
        <input type="text" id="display_name" name="display_name" autocomplete="name"/>
      </div>
      <div class="field">
        <label for="password">Hasło (min. 6 znaków) <span class="en">Password (min. 6 characters)</span></label>
        <input type="password" id="password" name="password" autocomplete="new-password" required minlength="6"/>
      </div>
      <div class="field">
        <label for="password2">Powtórz hasło <span class="en">Confirm password</span></label>
        <input type="password" id="password2" autocomplete="new-password" required/>
      </div>
      <button type="submit" class="reg-btn" id="regBtn">Zarejestruj się <span class="en">Register</span></button>
      <div class="reg-error" id="regError"></div>
    </form>
    <div class="reg-link">
      <span>Masz już konto?</span> <a href="/login">Zaloguj się</a>
      <div class="en">Already have an account? <a href="/login" style="color:var(--accent,#4a6cf7);font-size:.595rem;">Log in</a></div>
    </div>
  </div>

  <!-- Overlay: Recovery Phrase (shown once after registration) -->
  <div id="phraseOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center;">
    <div style="background:var(--card-bg,#fff);border-radius:16px;padding:2rem;max-width:520px;width:95%;box-shadow:0 8px 40px rgba(0,0,0,.2);text-align:center;">
      <h2 style="margin:0 0 .5rem;font-size:1.1rem;color:var(--text,#1a1a2e);">Fraza odzyskiwania konta <span class="en" style="display:block;font-size:.8rem;">Account Recovery Phrase</span></h2>
      <p style="font-size:.82rem;color:#e74c3c;line-height:1.5;margin:.5rem 0;font-weight:600;">
        Zapisz te 12 słów w bezpiecznym miejscu!
        <span class="en" style="display:block;margin-top:.2rem;">Write down these 12 words and keep them safe!</span>
      </p>
      <p style="font-size:.78rem;color:#e67e22;line-height:1.4;margin:.3rem 0;">
        Zapomnienie frazy może skutkować brakiem możliwości odzyskania konta.
        <span class="en" style="display:block;margin-top:.2rem;">Losing this phrase may result in inability to recover your account.</span>
      </p>
      <div id="phraseWords" style="background:#f8f9fa;border:2px dashed var(--border,#d0d5dd);border-radius:10px;padding:1rem;margin:1rem 0;font-family:monospace;font-size:1.1rem;font-weight:600;letter-spacing:.03em;word-spacing:.3em;line-height:1.8;user-select:all;color:var(--text,#1a1a2e);"></div>
      <label style="display:flex;align-items:center;justify-content:center;gap:.4rem;font-size:.82rem;margin:.8rem 0;cursor:pointer;">
        <input type="checkbox" id="phraseConfirmCheck"/>
        <span>Potwierdzam, że zapisałem frazę <span class="en">I confirm that I have saved the phrase</span></span>
      </label>
      <button class="reg-btn" id="phraseCloseBtn" disabled style="max-width:240px;margin:0 auto;">Kontynuuj <span class="en">Continue</span></button>
    </div>
  </div>
<script>
(function(){
  var curLang = localStorage.getItem('aistate_ui_lang') || 'pl';
  function applyLang(lang) {
    curLang = lang;
    localStorage.setItem('aistate_ui_lang', lang);
    document.querySelectorAll('.lang-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.lang === lang); });
    document.querySelectorAll('.en').forEach(function(el) {
      if (lang === 'en') { el.style.fontStyle = 'normal'; el.style.fontWeight = '600'; }
      else { el.style.fontStyle = ''; el.style.fontWeight = ''; }
    });
  }
  document.querySelectorAll('.lang-btn').forEach(function(btn) {
    btn.addEventListener('click', function() { applyLang(btn.dataset.lang); });
  });
  applyLang(curLang);
})();

document.getElementById('regForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  var btn = document.getElementById('regBtn');
  var errEl = document.getElementById('regError');
  btn.disabled = true;
  errEl.textContent = '';

  var password = document.getElementById('password').value;
  var password2 = document.getElementById('password2').value;

  if (password !== password2) {
    errEl.textContent = 'Hasła nie są identyczne / Passwords do not match';
    btn.disabled = false;
    return;
  }

  try {
    var res = await fetch('/api/auth/register', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        username: document.getElementById('username').value.trim(),
        display_name: document.getElementById('display_name').value.trim(),
        password: password,
      }),
    });
    var data = await res.json();
    if (res.ok && data.status === 'ok') {
      var params = '';
      if (data.approvers && data.approvers.length > 0) {
        params = '?approvers=' + encodeURIComponent(data.approvers.join(', '));
      }
      /* Show recovery phrase before redirecting */
      if (data.recovery_phrase) {
        showPhraseOverlay(data.recovery_phrase, '/pending' + params);
      } else {
        location.href = '/pending' + params;
      }
    } else {
      errEl.textContent = data.message || 'Registration failed';
    }
  } catch (err) {
    errEl.textContent = 'Connection error';
  } finally {
    btn.disabled = false;
  }
});

/* Inline validation + password strength meter */
if (typeof attachValidation === 'function') {
  attachValidation('username', { required: true, minLength: 3, maxLength: 64, pattern: /^[a-zA-Z0-9_.\-]+$/, patternMsg: 'Tylko litery, cyfry, _ . -' });
  attachValidation('password', { required: true, minLength: 6 });
  attachValidation('password2', { required: true, custom: function(v) {
    var pw = document.getElementById('password').value;
    if (v && pw && v !== pw) return 'Hasła nie są identyczne / Passwords do not match';
    return null;
  }});
}
if (typeof attachPasswordMeter === 'function') {
  attachPasswordMeter('password', 'medium');
}

/* Show recovery phrase overlay */
function showPhraseOverlay(phrase, redirectUrl) {
  var overlay = document.getElementById('phraseOverlay');
  var wordsEl = document.getElementById('phraseWords');
  var confirmCb = document.getElementById('phraseConfirmCheck');
  var closeBtn = document.getElementById('phraseCloseBtn');

  wordsEl.textContent = phrase;
  overlay.style.display = 'flex';

  confirmCb.checked = false;
  closeBtn.disabled = true;
  confirmCb.addEventListener('change', function() {
    closeBtn.disabled = !confirmCb.checked;
  });
  closeBtn.addEventListener('click', function() {
    overlay.style.display = 'none';
    if (redirectUrl) location.href = redirectUrl;
  });
}

/* Real-time username uniqueness check */
(function() {
  var usernameInput = document.getElementById('username');
  if (!usernameInput) return;
  var timer = null;
  var indicator = document.createElement('div');
  indicator.style.cssText = 'font-size:.72rem;margin-top:.2rem;min-height:1em;';
  usernameInput.parentNode.appendChild(indicator);

  usernameInput.addEventListener('input', function() {
    clearTimeout(timer);
    var val = usernameInput.value.trim();
    if (val.length < 3) { indicator.textContent = ''; return; }
    timer = setTimeout(async function() {
      try {
        var res = await fetch('/api/auth/check-username?username=' + encodeURIComponent(val));
        var data = await res.json();
        if (data.available) {
          indicator.style.color = '#27ae60';
          indicator.textContent = curLang === 'en' ? 'Username available' : 'Nazwa dostępna';
        } else {
          indicator.style.color = '#e74c3c';
          indicator.textContent = curLang === 'en' ? 'Username already taken' : 'Nazwa jest już zajęta';
        }
      } catch(e) { indicator.textContent = ''; }
    }, 400);
  });
})();
</script>
</body>
</html>
