<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Login — {{ app_name }}</title>
  <link rel="stylesheet" href="/static/app.css"/>
  <style>
    body { background: var(--bg, #f0f2f5); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; font-family: var(--font, 'Segoe UI', system-ui, sans-serif); }
    .login-card { background: var(--card-bg, #fff); border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,.08); padding: 2.5rem 2rem; width: 100%; max-width: 400px; }
    .login-logo { text-align: center; margin-bottom: 1.5rem; }
    .login-logo img { height: 64px; }
    .login-logo h1 { font-size: 1.3rem; margin: .5rem 0 0; color: var(--text, #1a1a2e); }
    .login-logo .ver { font-size: .75rem; color: var(--muted, #888); }
    .login-field { margin-bottom: 1rem; }
    .login-field label { display: block; font-size: .85rem; font-weight: 600; margin-bottom: .3rem; color: var(--text, #1a1a2e); }
    .login-field .en { font-size: .595rem; font-weight: 400; color: var(--muted, #999); font-style: italic; margin-left: .3rem; }
    .login-field input { width: 100%; padding: .6rem .75rem; border: 1.5px solid var(--border, #d0d5dd); border-radius: 8px; font-size: .95rem; box-sizing: border-box; outline: none; transition: border-color .2s; }
    .login-field input:focus { border-color: var(--accent, #4a6cf7); }
    .login-btn { width: 100%; padding: .7rem; border: none; border-radius: 8px; background: var(--accent, #4a6cf7); color: #fff; font-size: 1rem; font-weight: 600; cursor: pointer; transition: opacity .2s; }
    .login-btn:hover { opacity: .9; }
    .login-btn:disabled { opacity: .5; cursor: not-allowed; }
    .login-btn .en { font-size: .7rem; font-weight: 400; font-style: italic; margin-left: .4rem; }
    .login-error { color: #e74c3c; font-size: .85rem; margin-top: .75rem; min-height: 1.2em; text-align: center; }
    .login-pending { background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: .75rem; margin-top: .75rem; font-size: .85rem; color: #92400e; text-align: center; display: none; }
    .login-pending b { display: block; margin-bottom: .2rem; }
    .login-pending .en { font-size: .595rem; color: #b8860b; font-style: italic; }
    .login-pending .role-badges { display: flex; gap: .4rem; flex-wrap: wrap; justify-content: center; margin-top: .4rem; }
    .login-pending .role-badge { background: #fde68a; color: #92400e; padding: .2rem .5rem; border-radius: 5px; font-size: .78rem; font-weight: 600; }
    .login-pending .role-badge .en { display: block; font-size: .55rem; font-weight: 400; margin-top: .05rem; }
    .login-link { text-align: center; margin-top: 1rem; font-size: .85rem; }
    .login-link a { color: var(--accent, #4a6cf7); text-decoration: none; font-weight: 600; }
    .login-link .en { font-size: .595rem; color: var(--muted, #999); font-style: italic; }
    .lang-switch { display: flex; justify-content: center; gap: .3rem; margin-bottom: 1rem; }
    .lang-btn { padding: .25rem .6rem; border: 1.5px solid var(--border, #d0d5dd); border-radius: 6px; background: transparent; cursor: pointer; font-size: .78rem; font-weight: 600; color: var(--muted, #888); transition: all .2s; }
    .lang-btn.active { background: var(--accent, #4a6cf7); color: #fff; border-color: var(--accent, #4a6cf7); }
    .lang-btn:hover:not(.active) { border-color: var(--accent, #4a6cf7); color: var(--accent, #4a6cf7); }
  </style>
</head>
<body>
  <div class="login-card">
    <div class="login-logo">
      <img src="/static/logo.png" alt="Logo"/>
      <h1>{{ app_name }}</h1>
      <div class="ver">{{ app_version }}</div>
    </div>
    <div class="lang-switch" id="langSwitch">
      <button class="lang-btn active" data-lang="pl" id="langPl">PL</button>
      <button class="lang-btn" data-lang="en" id="langEn">EN</button>
    </div>
    <form id="loginForm" autocomplete="on">
      <div class="login-field">
        <label for="username">Nazwa użytkownika <span class="en">Username</span></label>
        <input type="text" id="username" name="username" autocomplete="username" required autofocus/>
      </div>
      <div class="login-field">
        <label for="password">Hasło <span class="en">Password</span></label>
        <input type="password" id="password" name="password" autocomplete="current-password" required/>
      </div>
      <button type="submit" class="login-btn" id="loginBtn">Zaloguj się <span class="en">Log in</span></button>
      <div class="login-error" id="loginError"></div>
      <div class="login-pending" id="loginPending">
        <b>Konto oczekuje na zatwierdzenie</b>
        <span class="en">Account pending approval</span>
        <div style="margin-top:.4rem;">Zatwierdzenia konta dokonuje:</div>
        <div class="en">Account approval is handled by:</div>
        <div class="role-badges" id="pendingApprovers"></div>
      </div>
    </form>
    <div class="login-link">
      <span>Nie masz konta?</span> <a href="/register">Zarejestruj się</a>
      <div class="en">Don't have an account? <a href="/register" style="color:var(--accent,#4a6cf7);font-size:.595rem;">Register</a></div>
    </div>
    <div class="login-link" style="margin-top:.5rem;">
      <a href="#" id="forgotPwLink">Zapomniałeś hasła? Wyślij info do Admina</a>
      <div class="en"><a href="#" id="forgotPwLinkEn" style="color:var(--accent,#4a6cf7);font-size:.595rem;">Forgot password? Notify Admin</a></div>
    </div>
    <div id="forgotPwForm" style="display:none;margin-top:.8rem;padding:.8rem;border:1px solid var(--border,#d0d5dd);border-radius:8px;">
      <div class="login-field" style="margin-bottom:.6rem;">
        <label for="forgotUsername">Podaj nazwę użytkownika <span class="en">Enter your username</span></label>
        <input type="text" id="forgotUsername" autocomplete="username"/>
      </div>
      <button type="button" class="login-btn" id="forgotSendBtn" style="font-size:.9rem;">Wyślij prośbę <span class="en">Send request</span></button>
      <div id="forgotMsg" style="font-size:.85rem;margin-top:.5rem;min-height:1.2em;text-align:center;"></div>
    </div>
  </div>
<script>
(function(){
  var roleEN = {
    'G\u0142\u00f3wny Opiekun': 'Main Guardian',
    'Strażnik Dostępu': 'Access Guardian',
    'Architekt Funkcji': 'Function Architect'
  };

  /* Language toggle */
  var curLang = localStorage.getItem('aistate_ui_lang') || 'pl';
  function applyLang(lang) {
    curLang = lang;
    localStorage.setItem('aistate_ui_lang', lang);
    document.querySelectorAll('.lang-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.lang === lang); });
    /* In PL mode: show PL text, show .en subtitles small.
       In EN mode: hide PL text, show .en as primary */
    document.querySelectorAll('.en').forEach(function(el) {
      if (lang === 'en') {
        el.style.fontSize = '';
        el.style.color = '';
        el.style.fontStyle = 'normal';
        el.style.fontWeight = '600';
      } else {
        el.style.fontSize = '';
        el.style.color = '';
        el.style.fontStyle = '';
        el.style.fontWeight = '';
      }
    });
    /* Toggle PL-only nodes */
    document.querySelectorAll('[data-pl]').forEach(function(el) {
      el.style.display = lang === 'en' ? 'none' : '';
    });
    document.querySelectorAll('[data-en-only]').forEach(function(el) {
      el.style.display = lang === 'en' ? '' : 'none';
    });
  }
  document.querySelectorAll('.lang-btn').forEach(function(btn) {
    btn.addEventListener('click', function() { applyLang(btn.dataset.lang); });
  });
  applyLang(curLang);

  /* Forgot password toggle + submit */
  var forgotLinks = [document.getElementById('forgotPwLink'), document.getElementById('forgotPwLinkEn')];
  var forgotForm = document.getElementById('forgotPwForm');
  forgotLinks.forEach(function(el) {
    if (el) el.addEventListener('click', function(e) {
      e.preventDefault();
      forgotForm.style.display = forgotForm.style.display === 'none' ? 'block' : 'none';
    });
  });

  document.getElementById('forgotSendBtn').addEventListener('click', async function() {
    var btn = this;
    var msgEl = document.getElementById('forgotMsg');
    var uname = document.getElementById('forgotUsername').value.trim();
    if (!uname) { msgEl.style.color = '#e74c3c'; msgEl.textContent = 'Podaj nazwę użytkownika / Enter username'; return; }
    btn.disabled = true;
    msgEl.textContent = '';
    try {
      var res = await fetch('/api/auth/request-reset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username: uname }),
      });
      var data = await res.json();
      if (res.ok) {
        msgEl.style.color = '#27ae60';
        msgEl.textContent = 'Prośba wysłana do administratora / Request sent to admin';
        document.getElementById('forgotUsername').value = '';
      } else {
        msgEl.style.color = '#e74c3c';
        msgEl.textContent = data.message || 'Error';
      }
    } catch (err) {
      msgEl.style.color = '#e74c3c';
      msgEl.textContent = 'Connection error';
    } finally {
      btn.disabled = false;
    }
  });

  document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    var btn = document.getElementById('loginBtn');
    var errEl = document.getElementById('loginError');
    var pendingEl = document.getElementById('loginPending');
    btn.disabled = true;
    errEl.textContent = '';
    pendingEl.style.display = 'none';

    try {
      var res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          username: document.getElementById('username').value.trim(),
          password: document.getElementById('password').value,
        }),
      });
      var data = await res.json();
      if (res.ok && data.status === 'ok') {
        /* Sync user's server-side language preference to localStorage */
        if (data.language) localStorage.setItem('aistate_ui_lang', data.language);
        location.href = '/';
      } else if (data.code === 'pending') {
        pendingEl.style.display = 'block';
        var container = document.getElementById('pendingApprovers');
        container.innerHTML = '';
        var roles = data.approvers || [];
        roles.forEach(function(role) {
          var badge = document.createElement('div');
          badge.className = 'role-badge';
          badge.innerHTML = role + (roleEN[role] ? '<span class="en">' + roleEN[role] + '</span>' : '');
          container.appendChild(badge);
        });
      } else {
        errEl.textContent = data.message || 'Login failed';
      }
    } catch (err) {
      errEl.textContent = 'Connection error';
    } finally {
      btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
