{% extends "base.html" %}
{% block content %}

<div class="analysis-page">

  <div class="card analysis-toolbar" id="analysis_toolbar">
    <div class="analysis-toolbar-left">
      <div class="h1" style="margin:0" data-i18n="analysis.title">üß† Analiza</div>
      <div class="small" id="analysis_status_line"></div>
    </div>

    <div class="analysis-toolbar-right">

      <!-- Generate first (per UX request) -->
      <button class="btn" id="an_generate_btn">üöÄ <span data-i18n="analysis.generate">Generuj</span></button>

      <!-- Models -->
      <div class="analysis-models" id="analysis_models">
  <div class="analysis-model">
    <span class="small" title="Quick model">‚ö°</span>
    <label class="small" for="an_model_quick" data-i18n="analysis.model_quick">Quick</label>
    <select class="input mini-select" id="an_model_quick" disabled>
      <option data-i18n="analysis.models_loading">≈Åadowanie‚Ä¶</option>
    </select>
  </div>
  <div class="analysis-model">
    <span class="small" title="Deep model">üîç</span>
    <label class="small" for="an_model_deep" data-i18n="analysis.model_deep">Deep</label>
    <select class="input mini-select" id="an_model_deep" disabled>
      <option data-i18n="analysis.models_loading">≈Åadowanie‚Ä¶</option>
    </select>
  </div>
</div>
      <!-- Report formats (multi-select) -->
      <div class="analysis-format" id="analysis_report_formats">
        <label class="small" data-i18n="analysis.report">Raport</label>
        <label class="pill"><input type="checkbox" name="an_report_fmt" value="html" checked> HTML</label>
        <label class="pill"><input type="checkbox" name="an_report_fmt" value="doc"> DOC</label>
        <label class="pill"><input type="checkbox" name="an_report_fmt" value="txt"> TXT</label>
      </div>

      <button class="btn secondary" id="an_report_save_btn">üíæ <span data-i18n="analysis.report_save">Zapisz</span></button>
    </div>
  </div>

  <!-- Tab bar -->
  <div class="analysis-tabs" id="analysis_tabs">
    <button class="analysis-tab active" data-tab="llm" id="tab_llm">
      <span class="analysis-tab-icon">üß†</span> Analiza LLM
    </button>
    <button class="analysis-tab" data-tab="aml" id="tab_aml">
      <span class="analysis-tab-icon">üîç</span> Analiza AML
    </button>
  </div>

  <!-- LLM Analysis content (existing) -->
  <div class="analysis-tab-content" id="llm_content">
  <div class="analysis-container">
    <aside class="analysis-sidebar" id="analysis_sidebar">

      <section class="card analysis-sidecard">
        <div class="analysis-sidehdr">
          <div class="h2" data-i18n="analysis.sources">üìÅ ≈πr√≥d≈Ça danych</div>
        </div>

        <div class="analysis-sidebody">
          <label class="check"><input type="checkbox" id="src_transcript"> <span data-i18n="analysis.src_transcript">Transkrypcja</span></label>
          <label class="check"><input type="checkbox" id="src_diarization"> <span data-i18n="analysis.src_diarization">Diaryzacja</span></label>
          <label class="check"><input type="checkbox" id="src_notes_global"> <span data-i18n="analysis.src_notes_global">Notatki globalne</span></label>
          <label class="check"><input type="checkbox" id="src_notes_blocks"> <span data-i18n="analysis.src_notes_blocks">Notatki do blok√≥w</span></label>

          <div class="analysis-docs">
            <div class="analysis-docs-top">
              <div class="h3" data-i18n="analysis.documents">üìé Dokumenty</div>
              <div class="analysis-docs-actions">
                <button class="btn secondary" id="docs_upload_btn">+ <span data-i18n="analysis.add">Dodaj</span></button>
              </div>
            </div>
            <div class="small" id="docs_hint" data-i18n="analysis.docs_hint">Zaznacz dokumenty, kt√≥re majƒÖ wej≈õƒá do analizy.</div>
            <div id="docs_list" class="docs-list"></div>
          </div>
        </div>
      </section>

      <section class="card analysis-sidecard">
        <div class="analysis-sidehdr">
          <div class="h2" data-i18n="analysis.prompts">üéØ Prompty</div>
          <div class="small" id="an_selected_count">0</div>
        </div>

        <div class="analysis-sidebody">
          <div id="prompts_box" class="prompts-box"></div>

          <div class="analysis-side-actions">
            <button class="btn secondary" id="prompt_new_btn">+ <span data-i18n="analysis.new_prompt">Nowy</span></button>
            <button class="btn secondary" id="prompt_import_btn">üì• <span data-i18n="analysis.import">Import</span></button>
          </div>
        </div>
      </section>

    </aside>

    <main class="analysis-main">

      <div class="card quick-analysis" id="quick_box">
        <div class="analysis-sidehdr">
          <div>
            <div class="h2" data-i18n="analysis.quick">‚ö° Szybka analiza</div>
            <div class="small" id="quick_state"></div>
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <label class="pill" title="Enable/disable background quick analysis">
              <input type="checkbox" id="quick_enabled_toggle" checked>
              <span data-i18n="analysis.quick_enabled">Auto</span>
            </label>
            <button class="btn secondary" id="quick_toggle_btn">‚àí</button>
          </div>
        </div>
        <div id="quick_body" class="quick-body">
          <div class="small" data-i18n="analysis.quick_loading">≈Åadowanie‚Ä¶</div>
        </div>
      </div>

      <div class="card custom-prompt" id="custom_prompt_box">
        <div class="analysis-sidehdr">
          <div>
            <div class="h2" data-i18n="analysis.custom_prompt_title">‚úçÔ∏è W≈Çasny prompt</div>
            <div class="small muted" data-i18n="analysis.custom_prompt_desc">Szybkie polecenie dla g≈Çƒôbokiej analizy. Je≈õli puste ‚Äì analiza dzia≈Ça jak dotychczas.</div>
          </div>
          <label class="pill" title="Combine with selected prompts">
            <input type="checkbox" id="custom_prompt_use_templates" checked>
            <span data-i18n="analysis.custom_prompt_use_templates">Po≈ÇƒÖcz z zaznaczonymi promptami</span>
          </label>
        </div>
        <div class="custom-prompt-body" style="margin-top:10px">
          <textarea class="input" id="custom_prompt_text" style="min-height:120px" data-i18n-placeholder="analysis.custom_prompt_placeholder" placeholder="Np. Zr√≥b formalny protok√≥≈Ç spotkania z decyzjami i zadaniami‚Ä¶"></textarea>
        </div>
      </div>

      <div class="card deep-analysis" id="deep_box">
        <div class="analysis-sidehdr">
          <div class="h2" data-i18n="analysis.deep">üîç G≈Çƒôboka analiza</div>
          <div class="small" id="deep_state"></div>
        </div>

        <!-- Progress (similar to Transcription/Di... ) -->
        <div class="an-progress" id="an_progress">
          <div class="small"><span data-i18n="common.progress">Postƒôp</span>: <span id="an_prog_pct">0%</span></div>
          <div class="progress"><div id="an_prog_bar"></div></div>
        </div>

        <div id="deep_result" class="deep-result">
          <div class="small" data-i18n="analysis.deep_hint">Wybierz ≈∫r√≥d≈Ça i prompty, potem kliknij ‚ÄûGeneruj‚Äù.</div>
        </div>
      </div>

      <!-- Finance entities panel (visible only after finance analysis) -->
      <div class="card" id="finance_entities_box" style="display:none;">
        <div class="analysis-sidehdr">
          <div class="h2">üè¶ <span data-i18n="finance.entities.title">Podmioty (Intelligence Memory)</span></div>
          <button class="btn mini" id="finance_entities_refresh" title="Od≈õwie≈º">‚Üª</button>
        </div>
        <div class="small" style="margin-bottom:8px;" data-i18n="finance.entities.hint">
          Oznacz podmioty jako podejrzane ‚Äî zostanƒÖ zapamiƒôtane w przysz≈Çych analizach.
        </div>
        <div id="finance_entities_list" class="finance-entities-list"></div>
      </div>

      <div class="analysis-actions" id="analysis_actions">
        <button class="btn secondary" id="an_copy_btn">üìã <span data-i18n="analysis.copy">Kopiuj</span></button>
        <button class="btn secondary" id="an_stop_btn" style="display:none">‚õî <span data-i18n="analysis.stop">Stop</span></button>
        <span id="an_download_slot"></span>
      </div>

    </main>
  </div>

  <button class="analysis-sidebar-toggle" id="analysis_sidebar_toggle" title="Toggle sidebar">‚óÄÔ∏é</button>
  </div><!-- /llm_content -->

  <!-- AML Analysis content -->
  <div class="analysis-tab-content" id="aml_content" style="display:none">

    <!-- Upload zone -->
    <div class="card aml-upload-zone" id="aml_upload_zone">
      <div class="aml-upload-inner" id="aml_drop_area">
        <div class="aml-upload-icon">üìÑ</div>
        <div class="h2">Analiza AML wyciagu bankowego</div>
        <div class="small muted">Przeciagnij plik PDF lub kliknij aby wybrac</div>
        <button class="btn" id="aml_upload_btn">Wybierz plik</button>
        <input type="file" id="aml_file_input" accept=".pdf" style="display:none">
      </div>
    </div>

    <!-- Column Mapping ‚Äî Visual PDF overlay (shown after PDF upload) -->
    <div id="aml_mapping_card" style="display:none">

      <!-- Template notification banner -->
      <div id="cm_template_banner" class="card" style="display:none;border-left:4px solid var(--ok,#15803d);background:var(--bg-success,#f0fdf4);margin-bottom:12px">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:200px">
            <div style="font-weight:600" id="cm_tpl_title"></div>
            <div class="small muted" id="cm_tpl_subtitle"></div>
          </div>
          <select class="input" id="cm_tpl_select" style="padding:4px 10px;border-radius:8px;min-width:180px;display:none"></select>
          <button class="btn mini" id="cm_tpl_apply_btn" style="display:none">Zastosuj szablon</button>
          <button class="btn mini secondary" id="cm_tpl_ignore_btn">Ignoruj</button>
        </div>
      </div>

      <!-- Header region editor (bank info above table) -->
      <div class="card" id="cm_header_card">
        <div class="analysis-sidehdr">
          <div class="h2">Naglowek wyciagu</div>
          <div style="display:flex;gap:8px;align-items:center">
            <span class="small muted" id="cm_bank_label"></span>
            <button class="btn secondary" id="cm_back_btn">Cofnij</button>
          </div>
        </div>
        <div class="small muted" style="margin:6px 0">Kliknij pole aby poprawic wartosc. Kliknij <b>&#9635;</b> aby podswietlic pole na PDF ‚Äî przeciagnij ramke lub narozniki. Dwuklik na PDF tworzy nowa ramke.</div>
        <div id="cm_header_fields" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px"></div>
      </div>

      <!-- Visual PDF + columns -->
      <div class="card" style="margin-top:12px">
        <div class="analysis-sidehdr">
          <div class="h2">Maska kolumn</div>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="btn mini" id="cm_add_col_btn" title="Dodaj kolumne">+ Kolumna</button>
            <select class="input" id="cm_page_select" style="padding:3px 8px;border-radius:8px;min-width:90px;display:none"></select>
          </div>
        </div>
        <div class="small muted" style="margin:6px 0">Przeciagnij pionowe linie aby poprawic granice kolumn. Kliknij nazwe kolumny aby edytowac podpis.</div>
        <div id="cm_warnings" style="margin-bottom:6px"></div>

        <!-- Visual PDF pages with SVG mask overlays (all pages stacked) -->
        <div id="cm_visual_wrap" style="position:relative;overflow:auto;max-height:700px;border:1px solid var(--border,#e2e8f0);border-radius:8px;background:#f8fafc">
          <div id="cm_pages_container"></div>
        </div>

        <!-- Column type selectors (below the image) -->
        <div class="cm-headers" id="cm_headers" style="margin-top:8px"></div>
      </div>

      <!-- Parsed transaction preview -->
      <div class="card" style="margin-top:12px">
        <div class="analysis-sidehdr">
          <div class="h2" style="font-size:14px">Podglad sparsowanych transakcji</div>
          <button class="btn mini" id="cm_refresh_preview">Odswiez podglad</button>
        </div>
        <div id="cm_parsed_preview" style="max-height:300px;overflow:auto;margin-top:6px">
          <div class="small muted">Kliknij "Odswiez podglad" aby zobaczyc wynik parsowania z aktualnym mapowaniem.</div>
        </div>
      </div>

      <!-- Template & confirm -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <label class="pill">
            <input type="checkbox" id="cm_save_template"> Zapisz jako szablon
          </label>
          <label class="pill">
            <input type="checkbox" id="cm_set_default"> Ustaw domyslny
          </label>
          <input class="input" id="cm_template_name" placeholder="Nazwa szablonu..." style="width:200px;padding:5px 10px;border-radius:10px;display:none">
          <label class="pill">
            <input type="checkbox" id="cm_run_llm"> Analiza LLM
          </label>
          <div style="flex:1"></div>
          <button class="btn" id="cm_confirm_btn" style="min-width:180px">Potwierdz i analizuj</button>
        </div>
      </div>
    </div>

    <!-- Progress -->
    <div class="card aml-progress-card" id="aml_progress_card" style="display:none">
      <div class="analysis-sidehdr">
        <div class="h2">Analizuje wyciag...</div>
      </div>
      <div class="an-progress" style="padding:10px 0">
        <div class="progress"><div id="aml_prog_bar" style="width:0%"></div></div>
        <div class="small muted" id="aml_prog_text">Przetwarzanie PDF...</div>
      </div>
    </div>

    <!-- Results -->
    <div id="aml_results" style="display:none">

      <!-- Summary row: risk score + bank info (merged with header fields) -->
      <div class="aml-summary-row">
        <div class="card aml-risk-card" id="aml_risk_card">
          <div class="aml-risk-gauge">
            <svg viewBox="0 0 120 80" class="aml-gauge-svg">
              <path d="M 10 70 A 50 50 0 0 1 110 70" fill="none" stroke="rgba(0,0,0,.08)" stroke-width="10" stroke-linecap="round"/>
              <path d="M 10 70 A 50 50 0 0 1 110 70" fill="none" stroke="var(--gauge-color, #15803d)" stroke-width="10" stroke-linecap="round"
                    id="aml_gauge_arc" stroke-dasharray="0 157" />
            </svg>
            <div class="aml-risk-number" id="aml_risk_number">0</div>
          </div>
          <div class="aml-risk-label" id="aml_risk_label">Ryzyko AML</div>
        </div>

        <div class="card aml-info-card" id="aml_info_card">
          <div class="h2">Informacje o wyciagu</div>
          <div class="aml-info-grid" id="aml_info_grid">
            <!-- Filled by JS: bank, holder, IBAN, period, balances, currency -->
          </div>
        </div>
      </div>

      <!-- Alerts -->
      <div class="card" id="aml_alerts_card">
        <div class="analysis-sidehdr">
          <div class="h2">Alerty</div>
          <span class="small aml-badge" id="aml_alerts_count">0</span>
        </div>
        <div id="aml_alerts_list" style="margin-top:10px"></div>
      </div>

      <!-- Transaction Review (classification) -->
      <div class="card" id="aml_review_card">
        <div class="analysis-sidehdr">
          <div class="h2">Przeglad i klasyfikacja transakcji</div>
          <div class="rv-stats-bar" id="rv_stats_bar" style="flex:1;margin-left:12px;min-width:100px"></div>
        </div>
        <div class="rv-stats-legend" id="rv_stats_legend" style="margin-bottom:8px"></div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
          <input class="input" id="rv_search" placeholder="Szukaj..." style="width:160px;padding:5px 10px;border-radius:10px">
          <select class="input" id="rv_filter_class" style="padding:5px 8px;border-radius:10px;min-width:130px">
            <option value="">Klasyfikacja: wszystkie</option>
            <option value="neutral">Neutralne</option>
            <option value="legitimate">Poprawne</option>
            <option value="suspicious">Podejrzane</option>
            <option value="monitoring">Obserwacja</option>
          </select>
          <select class="input" id="rv_filter_channel" style="padding:5px 8px;border-radius:10px;min-width:120px">
            <option value="">Kanal: wszystkie</option>
          </select>
          <span class="small muted" id="rv_tx_count">0</span>
        </div>
        <div id="rv_table_wrap" style="max-height:500px;overflow:auto"></div>

        <!-- Suspicious transactions summary (shown when any tx marked suspicious) -->
        <div id="rv_suspicious_summary" style="display:none;margin-top:16px;padding-top:12px;border-top:2px solid var(--danger,#b91c1c)">
          <div class="analysis-sidehdr" style="margin-bottom:8px">
            <div class="h2" style="color:var(--danger,#b91c1c)">Podejrzane transakcje</div>
            <span class="small aml-badge" id="rv_suspicious_count" style="background:var(--danger,#b91c1c);color:#fff">0</span>
          </div>
          <div class="small muted" style="margin-bottom:8px">Transakcje oznaczone jako podejrzane. Kontrahenci i dane sa zapamietywane w pamieci wewnetrznej dla przyszlych analiz.</div>
          <div id="rv_suspicious_list"></div>
        </div>
      </div>

      <!-- Charts -->
      <div class="card" id="aml_charts_card">
        <div class="analysis-sidehdr">
          <div class="h2">Wykresy</div>
          <div style="display:flex;gap:8px;align-items:center">
            <select class="input" id="aml_chart_select" style="padding:5px 8px;border-radius:10px;min-width:180px">
              <option value="balance_timeline">Saldo w czasie</option>
              <option value="category_distribution">Kategorie</option>
              <option value="channel_distribution">Kanaly</option>
              <option value="monthly_trend">Trend miesiƒôczny</option>
              <option value="daily_activity">Aktywnosc dzienna</option>
              <option value="top_counterparties">Top kontrahenci</option>
            </select>
          </div>
        </div>
        <div id="aml_chart_container" style="height:380px;margin-top:10px;position:relative">
          <canvas id="aml_chart_canvas"></canvas>
        </div>
      </div>

      <!-- ML Anomalies -->
      <div class="card" id="aml_ml_card">
        <div class="analysis-sidehdr">
          <div class="h2">Anomalie ML</div>
          <span class="small aml-badge" id="aml_ml_count">0</span>
        </div>
        <div class="small muted" style="margin:8px 0">Algorytm Isolation Forest wykrywa transakcje odstajace od typowego wzorca zachowan na koncie ‚Äî nietypowe kwoty, czestotliwosci lub kontrahentow. Im wyzszy wynik (%) tym bardziej nietypowa transakcja.</div>
        <div id="aml_ml_list" style="max-height:300px;overflow:auto;margin-top:6px">
          <div class="small muted">Brak anomalii.</div>
        </div>
      </div>

      <!-- Graph -->
      <div class="card" id="aml_graph_card">
        <div class="analysis-sidehdr">
          <div class="h2">Graf przeplywow</div>
          <div style="display:flex;gap:8px;align-items:center">
            <select class="input" id="aml_graph_risk_filter" style="padding:5px 8px;border-radius:10px;min-width:130px">
              <option value="">Wszystkie</option>
              <option value="high">Wysokie ryzyko</option>
              <option value="medium">Srednie</option>
              <option value="low">Niskie</option>
            </select>
          </div>
        </div>
        <div id="aml_graph_container" style="height:420px;border:1px solid var(--border);border-radius:12px;margin-top:10px;background:rgba(15,23,42,.02)"></div>
      </div>

      <!-- LLM Analysis -->
      <div class="card" id="aml_llm_card">
        <div class="analysis-sidehdr">
          <div class="h2">Analiza narracyjna (LLM)</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn" id="aml_llm_run_btn">Generuj analize</button>
          </div>
        </div>
        <div id="aml_llm_status" class="small muted" style="margin:8px 0">Kliknij "Generuj analize" aby uzyskac profesjonalny raport AML od modelu LLM (wymaga Ollama).</div>
        <div id="aml_llm_progress" style="display:none;margin:8px 0">
          <div class="an-progress">
            <div class="progress"><div id="aml_llm_prog_bar" style="width:0%;transition:width 0.3s"></div></div>
          </div>
          <div class="small muted" id="aml_llm_prog_text" style="margin-top:4px">Laczenie z Ollama...</div>
        </div>
        <div id="aml_llm_result" style="display:none;margin-top:10px">
          <div id="aml_llm_text" class="aml-llm-text"></div>
        </div>
      </div>

      <!-- Actions -->
      <div class="analysis-actions">
        <button class="btn" id="aml_download_report">Pobierz raport HTML</button>
        <button class="btn secondary" id="aml_new_analysis">Nowa analiza</button>
      </div>
    </div>

    <!-- History -->
    <div class="card" id="aml_history_card" style="display:none">
      <div class="analysis-sidehdr">
        <div class="h2">Historia analiz AML</div>
      </div>
      <div id="aml_history_list" style="margin-top:10px"></div>
    </div>

  </div><!-- /aml_content -->

  <!-- Hidden file inputs -->
  <input type="file" id="docs_file_input" style="display:none" multiple>
  <input type="file" id="prompt_import_input" style="display:none" accept="application/json">

  <!-- Prompt dialog -->
  <dialog id="prompt_dialog" class="an-dialog">
    <form method="dialog" class="an-dialog-form">
      <div class="h2" id="prompt_dialog_title">Prompt</div>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <div class="label" data-i18n="analysis.prompt_name">Nazwa</div>
          <input class="input" id="prompt_name" placeholder="Np. M√≥j raport" required>
        </div>
        <div>
          <div class="label" data-i18n="analysis.prompt_icon">Ikona</div>
          <input class="input" id="prompt_icon" placeholder="üìã">
        </div>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <div class="label" data-i18n="analysis.prompt_category">Kategoria</div>
          <input class="input" id="prompt_category" placeholder="Biznesowe">
        </div>
        <div>
          <div class="label" data-i18n="analysis.prompt_description">Opis</div>
          <input class="input" id="prompt_description" placeholder="">
        </div>
      </div>

      <div>
        <div class="label" data-i18n="analysis.prompt_text">Tre≈õƒá promptu</div>
        <textarea class="input" id="prompt_text" style="min-height:180px" placeholder="Wpisz tre≈õƒá promptu..."></textarea>
      </div>

      <div class="an-dialog-actions">
        <button class="btn secondary" value="cancel" data-i18n="btn.cancel">‚úï Anuluj</button>
        <button class="btn danger" id="prompt_delete_btn" type="button" style="display:none">üóë Usu≈Ñ</button>
        <button class="btn" id="prompt_save_btn" value="ok">üíæ Zapisz</button>
      </div>
    </form>
  </dialog>

</div>
{% endblock %}

{% block scripts %}
<script src="/static/analysis.js?v={{ app_version }}"></script>
<script src="/static/aml.js?v={{ app_version }}"></script>
<script src="/static/review.js?v={{ app_version }}"></script>
<script>
(async()=>{
  try{
    // Tab switching
    const tabs = document.querySelectorAll('.analysis-tab[data-tab]');
    const llmContent = document.getElementById('llm_content');
    const amlContent = document.getElementById('aml_content');
    const toolbar = document.getElementById('analysis_toolbar');
    const sidebarToggle = document.getElementById('analysis_sidebar_toggle');

    const allContents = [llmContent, amlContent];
    const llmToolbar = ['analysis_models','analysis_report_formats','an_generate_btn','an_report_save_btn'];

    tabs.forEach(tab => {
      tab.addEventListener('click', async () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const which = tab.getAttribute('data-tab');

        // Hide all content
        allContents.forEach(c => { if(c) c.style.display = 'none'; });

        if(which === 'llm'){
          llmContent.style.display = '';
          llmToolbar.forEach(id => { const el = document.getElementById(id); if(el) el.style.display = ''; });
          if(sidebarToggle) sidebarToggle.style.display = '';
        } else {
          llmToolbar.forEach(id => { const el = document.getElementById(id); if(el) el.style.display = 'none'; });
          if(sidebarToggle) sidebarToggle.style.display = 'none';

          if(which === 'aml'){
            amlContent.style.display = '';
            if(window.AmlManager && !window.AmlManager._initialized){
              await AmlManager.init();
            }
          }
        }
      });
    });

    if(window.AnalysisManager){
      await AnalysisManager.init();
    }
  }catch(e){
    console.error(e);
  }
})();
</script>
{% endblock %}
