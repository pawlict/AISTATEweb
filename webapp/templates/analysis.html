{% extends "base.html" %}
{% block content %}

<div class="analysis-page">

  <div class="card analysis-toolbar" id="analysis_toolbar">
    <div class="analysis-toolbar-left">
      <div class="h1" style="margin:0"><i data-icon="analysis" data-size="40"></i> <span data-i18n="analysis.title">Analiza</span></div>
    </div>

    <div class="analysis-toolbar-right">

      <!-- Sekcja 1: Generuj -->
      <div class="toolbar-section">
        <button class="btn pill-icon" id="an_generate_btn" title="Analizuj" data-i18n-title="analysis.generate_tooltip"><img src="/static/icons/akcje/generate_ai.svg" alt="Analizuj" draggable="false"></button>
      </div>

      <div class="toolbar-sep"></div>

      <!-- Sekcja 2: Modele -->
      <div class="toolbar-section">
        <div class="analysis-models" id="analysis_models">
          <div class="analysis-model">
            <label class="small" for="an_model_quick" data-i18n="analysis.model_quick">Quick</label>
            <select class="input mini-select" id="an_model_quick" disabled>
              <option data-i18n="analysis.models_loading">Ładowanie…</option>
            </select>
          </div>
          <div class="analysis-model">
            <label class="small" for="an_model_deep" data-i18n="analysis.model_deep">Deep</label>
            <select class="input mini-select" id="an_model_deep" disabled>
              <option data-i18n="analysis.models_loading">Ładowanie…</option>
            </select>
          </div>
        </div>
      </div>

      <div class="toolbar-sep"></div>

      <!-- Sekcja 3: Raport -->
      <div class="toolbar-section">
        <div class="toolbar-group" id="analysis_report_formats">
          <label class="toolbar-group-label" data-i18n="analysis.report"><img src="/static/icons/dokumenty/report.svg" alt="" draggable="false"> Raport</label>
          <div class="toolbar-group-controls">
            <label class="pill pill-icon" title="Dodaj raport HTML" data-i18n-title="analysis.report_add_html"><input type="checkbox" name="an_report_fmt" value="html" checked><img src="/static/icons/dokumenty/doc_html.svg" alt="HTML" draggable="false"></label>
            <label class="pill pill-icon" title="Dodaj raport DOC" data-i18n-title="analysis.report_add_doc"><input type="checkbox" name="an_report_fmt" value="doc"><img src="/static/icons/dokumenty/doc_docx.svg" alt="DOC" draggable="false"></label>
            <label class="pill pill-icon" title="Dodaj raport TXT" data-i18n-title="analysis.report_add_txt"><input type="checkbox" name="an_report_fmt" value="txt"><img src="/static/icons/dokumenty/doc_txt.svg" alt="TXT" draggable="false"></label>
            <button class="btn pill-icon" id="an_report_save_btn" title="Zapisz raport" data-i18n-title="analysis.report_save"><img src="/static/icons/pliki/file_save.svg" alt="Zapisz" draggable="false"></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab bar -->
  <div class="analysis-tabs" id="analysis_tabs">
    <button class="analysis-tab active" data-tab="llm" id="tab_llm">
      <span class="analysis-tab-icon"><i data-icon="brain" data-size="14"></i></span> Analiza LLM
    </button>
    <button class="analysis-tab" data-tab="aml" id="tab_aml">
      <span class="analysis-tab-icon"><i data-icon="search" data-size="14"></i></span> Analiza AML
    </button>
  </div>

  <!-- LLM Analysis content (existing) -->
  <div class="analysis-tab-content" id="llm_content">
  <div class="analysis-container">
    <aside class="analysis-sidebar" id="analysis_sidebar">

      <section class="card analysis-sidecard">
        <div class="analysis-sidehdr">
          <div class="h2" data-i18n="analysis.sources"><i data-icon="folder" data-size="16"></i> Źródła danych</div>
        </div>

        <div class="analysis-sidebody">
          <label class="check"><input type="checkbox" id="src_transcript"> <span data-i18n="analysis.src_transcript">Transkrypcja</span></label>
          <label class="check"><input type="checkbox" id="src_diarization"> <span data-i18n="analysis.src_diarization">Diaryzacja</span></label>
          <label class="check"><input type="checkbox" id="src_notes_global"> <span data-i18n="analysis.src_notes_global">Notatki globalne</span></label>
          <label class="check"><input type="checkbox" id="src_notes_blocks"> <span data-i18n="analysis.src_notes_blocks">Notatki do bloków</span></label>

          <div class="analysis-docs">
            <div class="analysis-docs-top">
              <div class="h3" data-i18n="analysis.documents"><i data-icon="document" data-size="14"></i> Dokumenty</div>
              <div class="analysis-docs-actions">
                <button class="btn secondary" id="docs_upload_btn">+ <span data-i18n="analysis.add">Dodaj</span></button>
              </div>
            </div>
            <div class="small" id="docs_hint" data-i18n="analysis.docs_hint">Zaznacz dokumenty, które mają wejść do analizy.</div>
            <div id="docs_list" class="docs-list"></div>
          </div>
        </div>
      </section>

      <section class="card analysis-sidecard">
        <div class="analysis-sidehdr">
          <div class="h2" data-i18n="analysis.prompts"><i data-icon="deep_search" data-size="16"></i> Prompty</div>
          <div class="small" id="an_selected_count">0</div>
        </div>

        <div class="analysis-sidebody">
          <div id="prompts_box" class="prompts-box"></div>

          <div class="analysis-side-actions">
            <button class="btn secondary" id="prompt_new_btn">+ <span data-i18n="analysis.new_prompt">Nowy</span></button>
            <button class="btn secondary" id="prompt_import_btn"><i data-icon="import" data-size="14"></i> <span data-i18n="analysis.import">Import</span></button>
          </div>
        </div>
      </section>

    </aside>

    <main class="analysis-main">

      <div class="card quick-analysis" id="quick_box">
        <div class="analysis-sidehdr">
          <div>
            <div class="h2" data-i18n="analysis.quick">Szybka analiza</div>
            <div class="small" id="quick_state"></div>
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <label class="pill" title="Enable/disable background quick analysis">
              <input type="checkbox" id="quick_enabled_toggle" checked>
              <span data-i18n="analysis.quick_enabled">Auto</span>
            </label>
            <button class="btn secondary" id="quick_toggle_btn">−</button>
          </div>
        </div>
        <div id="quick_body" class="quick-body">
          <div class="small" data-i18n="analysis.quick_loading">Ładowanie…</div>
        </div>
      </div>

      <div class="card custom-prompt" id="custom_prompt_box">
        <div class="analysis-sidehdr">
          <div>
            <div class="h2" data-i18n="analysis.custom_prompt_title"><i data-icon="edit" data-size="16"></i> Własny prompt</div>
            <div class="small muted" data-i18n="analysis.custom_prompt_desc">Szybkie polecenie dla głębokiej analizy. Jeśli puste – analiza działa jak dotychczas.</div>
          </div>
          <label class="pill" title="Combine with selected prompts">
            <input type="checkbox" id="custom_prompt_use_templates" checked>
            <span data-i18n="analysis.custom_prompt_use_templates">Połącz z zaznaczonymi promptami</span>
          </label>
        </div>
        <div class="custom-prompt-body" style="margin-top:10px">
          <textarea class="input" id="custom_prompt_text" style="min-height:120px" data-i18n-placeholder="analysis.custom_prompt_placeholder" placeholder="Np. Zrób formalny protokół spotkania z decyzjami i zadaniami…"></textarea>
        </div>
      </div>

      <div class="card deep-analysis" id="deep_box">
        <div class="analysis-sidehdr">
          <div class="h2" data-i18n="analysis.deep"><i data-icon="search" data-size="14"></i> Głęboka analiza</div>
          <div class="small" id="deep_state"></div>
        </div>

        <!-- Progress (similar to Transcription/Di... ) -->
        <div class="an-progress" id="an_progress">
          <div class="small"><span data-i18n="common.progress">Postęp</span>: <span id="an_prog_pct">0%</span></div>
          <div class="progress"><div id="an_prog_bar"></div></div>
        </div>

        <div id="deep_result" class="deep-result">
          <div class="small" data-i18n="analysis.deep_hint">Wybierz źródła i prompty, potem kliknij „Generuj”.</div>
        </div>
      </div>

      <!-- Finance entities panel (visible only after finance analysis) -->
      <div class="card" id="finance_entities_box" style="display:none;">
        <div class="analysis-sidehdr">
          <div class="h2"><i data-icon="finance" data-size="16"></i> <span data-i18n="finance.entities.title">Podmioty (Intelligence Memory)</span></div>
          <button class="btn mini" id="finance_entities_refresh" title="Odśwież">↻</button>
        </div>
        <div class="small" style="margin-bottom:8px;" data-i18n="finance.entities.hint">
          Oznacz podmioty jako podejrzane — zostaną zapamiętane w przyszłych analizach.
        </div>
        <div id="finance_entities_list" class="finance-entities-list"></div>
      </div>

      <div class="analysis-actions" id="analysis_actions">
        <button class="btn secondary" id="an_copy_btn"><i data-icon="copy" data-size="14"></i> <span data-i18n="analysis.copy">Kopiuj</span></button>
        <button class="btn secondary" id="an_stop_btn" style="display:none"><i data-icon="stop" data-size="14"></i> <span data-i18n="analysis.stop">Stop</span></button>
        <span id="an_download_slot"></span>
      </div>

    </main>
  </div>

  <button class="analysis-sidebar-toggle" id="analysis_sidebar_toggle" title="Toggle sidebar">◀︎</button>
  </div><!-- /llm_content -->

  <!-- AML Analysis content -->
  <div class="analysis-tab-content" id="aml_content" style="display:none">

    <!-- Upload zone -->
    <div class="card aml-upload-zone" id="aml_upload_zone">
      <div class="aml-upload-inner" id="aml_drop_area">
        <div class="aml-upload-icon"><i data-icon="document" data-size="32"></i></div>
        <div class="h2">Analiza AML wyciągu bankowego</div>
        <div class="small muted">Przeciągnij pliki PDF lub kliknij aby wybrać (można wiele na raz)</div>
        <button class="btn" id="aml_upload_btn">Wybierz pliki</button>
        <input type="file" id="aml_file_input" accept=".pdf" multiple style="display:none">
      </div>
    </div>

    <!-- Batch progress panel (shown during multi-file upload) -->
    <div class="card" id="aml_batch_panel" style="display:none">
      <div class="analysis-sidehdr">
        <div class="h2">Analiza wielu wyciągów</div>
        <span class="small muted" id="aml_batch_counter"></span>
      </div>
      <div id="aml_batch_list" style="margin-top:8px"></div>
      <div id="aml_batch_validation" style="margin-top:12px;display:none"></div>
    </div>

    <!-- Progress -->
    <div class="card aml-progress-card" id="aml_progress_card" style="display:none">
      <div class="analysis-sidehdr">
        <div class="h2">Analizuje wyciag...</div>
      </div>
      <div class="an-progress" style="padding:10px 0">
        <div class="progress"><div id="aml_prog_bar" style="width:0%"></div></div>
        <div class="small muted" id="aml_prog_text">Przetwarzanie PDF...</div>
      </div>
    </div>

    <!-- Results -->
    <div id="aml_results" style="display:none">

      <!-- Summary row: risk score + bank info (merged with header fields) -->
      <div class="aml-summary-row">
        <div class="card aml-risk-card" id="aml_risk_card">
          <div class="aml-risk-gauge">
            <svg viewBox="0 0 120 80" class="aml-gauge-svg">
              <path d="M 10 70 A 50 50 0 0 1 110 70" fill="none" stroke="rgba(0,0,0,.08)" stroke-width="10" stroke-linecap="round"/>
              <path d="M 10 70 A 50 50 0 0 1 110 70" fill="none" stroke="var(--gauge-color, #15803d)" stroke-width="10" stroke-linecap="round"
                    id="aml_gauge_arc" stroke-dasharray="0 157" />
            </svg>
            <div class="aml-risk-number" id="aml_risk_number">0</div>
          </div>
          <div class="aml-risk-label" id="aml_risk_label">Ryzyko AML</div>
        </div>

        <div class="card aml-info-card" id="aml_info_card">
          <div class="h2">Informacje o wyciagu</div>
          <div class="aml-info-grid" id="aml_info_grid">
            <!-- Filled by JS: bank, holder, IBAN, period, balances, currency -->
          </div>
        </div>
      </div>

      <!-- Alerts -->
      <div class="card" id="aml_alerts_card">
        <div class="analysis-sidehdr">
          <div class="h2">Alerty</div>
          <span class="small aml-badge" id="aml_alerts_count">0</span>
        </div>
        <div id="aml_alerts_list" style="margin-top:10px"></div>
      </div>

      <!-- Statement Header (editable review) -->
      <div class="card" id="rv_header_card">
        <div class="analysis-sidehdr">
          <div class="h2">Nagłówek wyciągu</div>
          <button class="btn mini" id="rv_header_save" title="Zapisz zmiany">Zapisz</button>
        </div>
        <div class="small muted" style="margin:6px 0">Sprawdź odczytane dane i popraw jeśli potrzeba. Zmiany tworzą reguły mapowania dla przyszłych importów.</div>
        <div class="rv-header-grid" id="rv_header_grid"></div>
        <div id="rv_header_warnings" style="margin-top:8px"></div>
      </div>

      <!-- Transaction Review (classification) -->
      <div class="card" id="aml_review_card">
        <div class="analysis-sidehdr">
          <div class="h2">Przeglad i klasyfikacja transakcji</div>
          <div class="rv-stats-bar" id="rv_stats_bar" style="flex:1;margin-left:12px;min-width:100px"></div>
        </div>
        <div class="rv-stats-legend" id="rv_stats_legend" style="margin-bottom:8px"></div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
          <input class="input" id="rv_search" placeholder="Szukaj..." style="width:160px;padding:5px 10px;border-radius:10px">
          <select class="input" id="rv_filter_class" style="padding:5px 8px;border-radius:10px;min-width:130px">
            <option value="">Klasyfikacja: wszystkie</option>
            <option value="neutral">Neutralne</option>
            <option value="legitimate">Poprawne</option>
            <option value="suspicious">Podejrzane</option>
            <option value="monitoring">Obserwacja</option>
          </select>
          <select class="input" id="rv_filter_channel" style="padding:5px 8px;border-radius:10px;min-width:120px">
            <option value="">Kanal: wszystkie</option>
          </select>
          <span class="small muted" id="rv_tx_count">0</span>
        </div>
        <div id="rv_table_wrap" style="max-height:500px;overflow:auto"></div>

        <!-- Suspicious transactions summary (shown when any tx marked suspicious) -->
        <div id="rv_suspicious_summary" style="display:none;margin-top:16px;padding-top:12px;border-top:2px solid var(--danger,#b91c1c)">
          <div class="analysis-sidehdr" style="margin-bottom:8px">
            <div class="h2" style="color:var(--danger,#b91c1c)">Podejrzane transakcje</div>
            <span class="small aml-badge" id="rv_suspicious_count" style="background:var(--danger,#b91c1c);color:#fff">0</span>
          </div>
          <div class="small muted" style="margin-bottom:8px">Transakcje oznaczone jako podejrzane. Kontrahenci i dane sa zapamietywane w pamieci wewnetrznej dla przyszlych analiz.</div>
          <div id="rv_suspicious_list"></div>
        </div>
      </div>

      <!-- Charts -->
      <div class="card" id="aml_charts_card">
        <div class="analysis-sidehdr">
          <div>
            <div class="h2">Wykresy</div>
            <div class="small muted" id="aml_chart_hint" style="margin-top:2px">Ctrl + scroll myszy — zoom</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <select class="input" id="aml_chart_select" style="padding:5px 8px;border-radius:10px;min-width:180px">
              <option value="balance_timeline">Saldo w czasie</option>
              <option value="category_distribution">Kategorie</option>
              <option value="channel_distribution">Kanaly</option>
              <option value="monthly_trend">Trend miesięczny</option>
              <option value="daily_activity">Aktywnosc dzienna</option>
              <option value="top_counterparties">Top kontrahenci</option>
            </select>
          </div>
        </div>
        <div id="aml_chart_scroll_wrap" class="aml-chart-scroll-wrap">
          <div id="aml_chart_container" style="height:380px;position:relative;min-width:100%">
            <canvas id="aml_chart_canvas"></canvas>
          </div>
        </div>
        <div id="aml_chart_gap_legend" class="aml-chart-gap-legend" style="display:none"></div>
      </div>

      <!-- ML Anomalies -->
      <div class="card" id="aml_ml_card">
        <div class="analysis-sidehdr">
          <div class="h2">Anomalie ML</div>
          <span class="small aml-badge" id="aml_ml_count">0</span>
        </div>
        <div class="small muted" style="margin:8px 0">Algorytm Isolation Forest wykrywa transakcje odstajace od typowego wzorca zachowan na koncie — nietypowe kwoty, czestotliwosci lub kontrahentow. Im wyzszy wynik (%) tym bardziej nietypowa transakcja.</div>
        <div id="aml_ml_list" style="max-height:300px;overflow:auto;margin-top:6px">
          <div class="small muted">Brak anomalii.</div>
        </div>
      </div>

      <!-- Graph -->
      <div class="card" id="aml_graph_card">
        <div class="analysis-sidehdr">
          <div class="h2">Graf przepływów</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <!-- Layout buttons -->
            <div style="display:flex;gap:3px;background:var(--bg-secondary,#f1f5f9);border-radius:10px;padding:2px">
              <button class="btn mini aml-graph-layout-btn" data-layout="cose" title="Układ siłowy (automatyczny)" style="border-radius:8px;padding:4px 8px;font-size:12px;background:var(--primary);color:#fff">Siłowy</button>
              <button class="btn mini aml-graph-layout-btn" data-layout="circle" title="Układ kołowy" style="border-radius:8px;padding:4px 8px;font-size:12px">Okrąg</button>
              <button class="btn mini aml-graph-layout-btn" data-layout="grid" title="Układ siatkowy" style="border-radius:8px;padding:4px 8px;font-size:12px">Siatka</button>
              <button class="btn mini aml-graph-layout-btn" data-layout="breadthfirst" title="Układ hierarchiczny (drzewiasty)" style="border-radius:8px;padding:4px 8px;font-size:12px">Drzewo</button>
              <button class="btn mini aml-graph-layout-btn" data-layout="concentric" title="Układ koncentryczny (ryzyko)" style="border-radius:8px;padding:4px 8px;font-size:12px">Koncentryczny</button>
            </div>
            <!-- Risk filter -->
            <select class="input" id="aml_graph_risk_filter" style="padding:5px 8px;border-radius:10px;min-width:130px">
              <option value="">Wszystkie</option>
              <option value="high">Wysokie ryzyko</option>
              <option value="medium">Średnie</option>
              <option value="low">Niskie</option>
            </select>
          </div>
        </div>
        <!-- Legend -->
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;font-size:12px;color:#64748b">
          <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#15803d;margin-right:3px"></span>Poprawna</span>
          <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#dc2626;margin-right:3px"></span>Podejrzana</span>
          <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#ea580c;margin-right:3px"></span>Obserwacja</span>
          <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#60a5fa;margin-right:3px"></span>Neutralna</span>
          <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#1f5aa6;margin-right:3px"></span>Własne konto</span>
        </div>
        <div id="aml_graph_container" style="height:420px;border:1px solid var(--border);border-radius:12px;margin-top:10px;background:rgba(15,23,42,.02)"></div>
      </div>

      <!-- LLM Analysis -->
      <div class="card" id="aml_llm_card">
        <div class="analysis-sidehdr">
          <div class="h2">Analiza narracyjna (LLM)</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn" id="aml_llm_run_btn">Generuj analize</button>
          </div>
        </div>
        <div id="aml_llm_status" class="small muted" style="margin:8px 0">Kliknij "Generuj analize" aby uzyskac profesjonalny raport AML od modelu LLM (wymaga Ollama).</div>
        <div id="aml_llm_progress" style="display:none;margin:8px 0">
          <div class="an-progress">
            <div class="progress"><div id="aml_llm_prog_bar" style="width:0%;transition:width 0.3s"></div></div>
          </div>
          <div class="small muted" id="aml_llm_prog_text" style="margin-top:4px">Laczenie z Ollama...</div>
        </div>
        <div id="aml_llm_result" style="display:none;margin-top:10px">
          <div id="aml_llm_text" class="aml-llm-text"></div>
        </div>
      </div>

      <!-- Actions -->
      <div class="analysis-actions">
        <button class="btn" id="aml_download_report">Pobierz raport HTML</button>
        <button class="btn secondary" id="aml_new_analysis">Nowa analiza</button>
      </div>
    </div>

    <!-- History -->
    <div class="card" id="aml_history_card" style="display:none">
      <div class="analysis-sidehdr">
        <div class="h2">Historia analiz AML</div>
        <span class="small muted" id="aml_history_count"></span>
      </div>
      <div id="aml_history_list" style="margin-top:10px"></div>
    </div>

  </div><!-- /aml_content -->

  <!-- Hidden file inputs -->
  <input type="file" id="docs_file_input" style="display:none" multiple>
  <input type="file" id="prompt_import_input" style="display:none" accept="application/json">

  <!-- Prompt dialog -->
  <dialog id="prompt_dialog" class="an-dialog">
    <form method="dialog" class="an-dialog-form">
      <div class="h2" id="prompt_dialog_title">Prompt</div>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <div class="label" data-i18n="analysis.prompt_name">Nazwa</div>
          <input class="input" id="prompt_name" placeholder="Np. Mój raport" required>
        </div>
        <div>
          <div class="label" data-i18n="analysis.prompt_icon">Ikona</div>
          <input class="input" id="prompt_icon" placeholder="copy">
        </div>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <div class="label" data-i18n="analysis.prompt_category">Kategoria</div>
          <input class="input" id="prompt_category" placeholder="Biznesowe">
        </div>
        <div>
          <div class="label" data-i18n="analysis.prompt_description">Opis</div>
          <input class="input" id="prompt_description" placeholder="">
        </div>
      </div>

      <div>
        <div class="label" data-i18n="analysis.prompt_text">Treść promptu</div>
        <textarea class="input" id="prompt_text" style="min-height:180px" placeholder="Wpisz treść promptu..."></textarea>
      </div>

      <div class="an-dialog-actions">
        <button class="btn secondary" value="cancel" data-i18n="btn.cancel"><i data-icon="close" data-size="16"></i> Anuluj</button>
        <button class="btn danger" id="prompt_delete_btn" type="button" style="display:none"><i data-icon="delete" data-size="14"></i> Usuń</button>
        <button class="btn" id="prompt_save_btn" value="ok"><i data-icon="save" data-size="16"></i> Zapisz</button>
      </div>
    </form>
  </dialog>

</div>
{% endblock %}

{% block scripts %}
<script src="/static/analysis.js?v={{ app_version }}"></script>
<script src="/static/aml.js?v={{ app_version }}"></script>
<script src="/static/review.js?v={{ app_version }}"></script>
<script>
(async()=>{
  try{
    // Tab switching
    const tabs = document.querySelectorAll('.analysis-tab[data-tab]');
    const llmContent = document.getElementById('llm_content');
    const amlContent = document.getElementById('aml_content');
    const toolbar = document.getElementById('analysis_toolbar');
    const sidebarToggle = document.getElementById('analysis_sidebar_toggle');

    const allContents = [llmContent, amlContent];
    const llmToolbar = ['analysis_models','analysis_report_formats','an_generate_btn','an_report_save_btn'];

    tabs.forEach(tab => {
      tab.addEventListener('click', async () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const which = tab.getAttribute('data-tab');

        // Hide all content
        allContents.forEach(c => { if(c) c.style.display = 'none'; });

        if(which === 'llm'){
          llmContent.style.display = '';
          llmToolbar.forEach(id => { const el = document.getElementById(id); if(el) el.style.display = ''; });
          if(sidebarToggle) sidebarToggle.style.display = '';
        } else {
          llmToolbar.forEach(id => { const el = document.getElementById(id); if(el) el.style.display = 'none'; });
          if(sidebarToggle) sidebarToggle.style.display = 'none';

          if(which === 'aml'){
            amlContent.style.display = '';
            if(window.AmlManager && !window.AmlManager._initialized){
              await AmlManager.init();
            }
          }
        }
      });
    });

    if(window.AnalysisManager){
      await AnalysisManager.init();
    }
  }catch(e){
    console.error(e);
  }
})();
</script>
{% endblock %}
