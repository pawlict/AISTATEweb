{% extends "base.html" %}
{% block content %}

<div class="analysis-page">

  <div class="card analysis-toolbar" id="analysis_toolbar">
    <div class="analysis-toolbar-left">
      <div class="h1" style="margin:0" data-i18n="analysis.title">ğŸ§  Analiza</div>
      <div class="small" id="analysis_status_line"></div>
    </div>

    <div class="analysis-toolbar-right">

      <!-- Generate first (per UX request) -->
      <button class="btn" id="an_generate_btn">ğŸš€ <span data-i18n="analysis.generate">Generuj</span></button>

      <!-- Models -->
      <div class="analysis-models" id="analysis_models">
  <div class="analysis-model">
    <span class="small" title="Quick model">âš¡</span>
    <label class="small" for="an_model_quick" data-i18n="analysis.model_quick">Quick</label>
    <select class="input mini-select" id="an_model_quick" disabled>
      <option data-i18n="analysis.models_loading">Åadowanieâ€¦</option>
    </select>
  </div>
  <div class="analysis-model">
    <span class="small" title="Deep model">ğŸ”</span>
    <label class="small" for="an_model_deep" data-i18n="analysis.model_deep">Deep</label>
    <select class="input mini-select" id="an_model_deep" disabled>
      <option data-i18n="analysis.models_loading">Åadowanieâ€¦</option>
    </select>
  </div>
</div>
      <!-- Report formats (multi-select) -->
      <div class="analysis-format" id="analysis_report_formats">
        <label class="small" data-i18n="analysis.report">Raport</label>
        <label class="pill"><input type="checkbox" name="an_report_fmt" value="html" checked> HTML</label>
        <label class="pill"><input type="checkbox" name="an_report_fmt" value="doc"> DOC</label>
        <label class="pill"><input type="checkbox" name="an_report_fmt" value="txt"> TXT</label>
      </div>

      <button class="btn secondary" id="an_report_save_btn">ğŸ’¾ <span data-i18n="analysis.report_save">Zapisz</span></button>
    </div>
  </div>

  <div class="analysis-container">
    <aside class="analysis-sidebar" id="analysis_sidebar">

      <section class="card analysis-sidecard">
        <div class="analysis-sidehdr">
          <div class="h2" data-i18n="analysis.sources">ğŸ“ Å¹rÃ³dÅ‚a danych</div>
        </div>

        <div class="analysis-sidebody">
          <label class="check"><input type="checkbox" id="src_transcript"> <span data-i18n="analysis.src_transcript">Transkrypcja</span></label>
          <label class="check"><input type="checkbox" id="src_diarization"> <span data-i18n="analysis.src_diarization">Diaryzacja</span></label>
          <label class="check"><input type="checkbox" id="src_notes_global"> <span data-i18n="analysis.src_notes_global">Notatki globalne</span></label>
          <label class="check"><input type="checkbox" id="src_notes_blocks"> <span data-i18n="analysis.src_notes_blocks">Notatki do blokÃ³w</span></label>

          <div class="analysis-docs">
            <div class="analysis-docs-top">
              <div class="h3" data-i18n="analysis.documents">ğŸ“ Dokumenty</div>
              <div class="analysis-docs-actions">
                <button class="btn secondary" id="docs_upload_btn">+ <span data-i18n="analysis.add">Dodaj</span></button>
              </div>
            </div>
            <div class="small" id="docs_hint" data-i18n="analysis.docs_hint">Zaznacz dokumenty, ktÃ³re majÄ… wejÅ›Ä‡ do analizy.</div>
            <div id="docs_list" class="docs-list"></div>
          </div>
        </div>
      </section>

      <section class="card analysis-sidecard">
        <div class="analysis-sidehdr">
          <div class="h2" data-i18n="analysis.prompts">ğŸ¯ Prompty</div>
          <div class="small" id="an_selected_count">0</div>
        </div>

        <div class="analysis-sidebody">
          <div id="prompts_box" class="prompts-box"></div>

          <div class="analysis-side-actions">
            <button class="btn secondary" id="prompt_new_btn">+ <span data-i18n="analysis.new_prompt">Nowy</span></button>
            <button class="btn secondary" id="prompt_import_btn">ğŸ“¥ <span data-i18n="analysis.import">Import</span></button>
          </div>
        </div>
      </section>

    </aside>

    <main class="analysis-main">

      <div class="card quick-analysis" id="quick_box">
        <div class="analysis-sidehdr">
          <div>
            <div class="h2" data-i18n="analysis.quick">âš¡ Szybka analiza</div>
            <div class="small" id="quick_state"></div>
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <label class="pill" title="Enable/disable background quick analysis">
              <input type="checkbox" id="quick_enabled_toggle" checked>
              <span data-i18n="analysis.quick_enabled">Auto</span>
            </label>
            <button class="btn secondary" id="quick_toggle_btn">âˆ’</button>
          </div>
        </div>
        <div id="quick_body" class="quick-body">
          <div class="small" data-i18n="analysis.quick_loading">Åadowanieâ€¦</div>
        </div>
      </div>

      <div class="card custom-prompt" id="custom_prompt_box">
        <div class="analysis-sidehdr">
          <div>
            <div class="h2" data-i18n="analysis.custom_prompt_title">âœï¸ WÅ‚asny prompt</div>
            <div class="small muted" data-i18n="analysis.custom_prompt_desc">Szybkie polecenie dla gÅ‚Ä™bokiej analizy. JeÅ›li puste â€“ analiza dziaÅ‚a jak dotychczas.</div>
          </div>
          <label class="pill" title="Combine with selected prompts">
            <input type="checkbox" id="custom_prompt_use_templates" checked>
            <span data-i18n="analysis.custom_prompt_use_templates">PoÅ‚Ä…cz z zaznaczonymi promptami</span>
          </label>
        </div>
        <div class="custom-prompt-body" style="margin-top:10px">
          <textarea class="input" id="custom_prompt_text" style="min-height:120px" data-i18n-placeholder="analysis.custom_prompt_placeholder" placeholder="Np. ZrÃ³b formalny protokÃ³Å‚ spotkania z decyzjami i zadaniamiâ€¦"></textarea>
        </div>
      </div>

      <div class="card deep-analysis" id="deep_box">
        <div class="analysis-sidehdr">
          <div class="h2" data-i18n="analysis.deep">ğŸ” GÅ‚Ä™boka analiza</div>
          <div class="small" id="deep_state"></div>
        </div>

        <!-- Progress (similar to Transcription/Di... ) -->
        <div class="an-progress" id="an_progress">
          <div class="small"><span data-i18n="common.progress">PostÄ™p</span>: <span id="an_prog_pct">0%</span></div>
          <div class="progress"><div id="an_prog_bar"></div></div>
        </div>

        <div id="deep_result" class="deep-result">
          <div class="small" data-i18n="analysis.deep_hint">Wybierz ÅºrÃ³dÅ‚a i prompty, potem kliknij â€Generujâ€.</div>
        </div>
      </div>

      <div class="analysis-actions" id="analysis_actions">
        <button class="btn secondary" id="an_copy_btn">ğŸ“‹ <span data-i18n="analysis.copy">Kopiuj</span></button>
        <button class="btn secondary" id="an_stop_btn" style="display:none">â›” <span data-i18n="analysis.stop">Stop</span></button>
        <span id="an_download_slot"></span>
      </div>

    </main>
  </div>

  <button class="analysis-sidebar-toggle" id="analysis_sidebar_toggle" title="Toggle sidebar">â—€ï¸</button>

  <!-- Hidden file inputs -->
  <input type="file" id="docs_file_input" style="display:none" multiple>
  <input type="file" id="prompt_import_input" style="display:none" accept="application/json">

  <!-- Prompt dialog -->
  <dialog id="prompt_dialog" class="an-dialog">
    <form method="dialog" class="an-dialog-form">
      <div class="h2" id="prompt_dialog_title">Prompt</div>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <div class="label" data-i18n="analysis.prompt_name">Nazwa</div>
          <input class="input" id="prompt_name" placeholder="Np. MÃ³j raport" required>
        </div>
        <div>
          <div class="label" data-i18n="analysis.prompt_icon">Ikona</div>
          <input class="input" id="prompt_icon" placeholder="ğŸ“‹">
        </div>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <div class="label" data-i18n="analysis.prompt_category">Kategoria</div>
          <input class="input" id="prompt_category" placeholder="Biznesowe">
        </div>
        <div>
          <div class="label" data-i18n="analysis.prompt_description">Opis</div>
          <input class="input" id="prompt_description" placeholder="">
        </div>
      </div>

      <div>
        <div class="label" data-i18n="analysis.prompt_text">TreÅ›Ä‡ promptu</div>
        <textarea class="input" id="prompt_text" style="min-height:180px" placeholder="Wpisz treÅ›Ä‡ promptu..."></textarea>
      </div>

      <div class="an-dialog-actions">
        <button class="btn secondary" value="cancel" data-i18n="btn.cancel">âœ• Anuluj</button>
        <button class="btn danger" id="prompt_delete_btn" type="button" style="display:none">ğŸ—‘ UsuÅ„</button>
        <button class="btn" id="prompt_save_btn" value="ok">ğŸ’¾ Zapisz</button>
      </div>
    </form>
  </dialog>

</div>
{% endblock %}

{% block scripts %}
<script src="/static/analysis.js?v={{ app_version }}"></script>
<script>
(async()=>{
  try{
    if(window.AnalysisManager){
      await AnalysisManager.init();
    }
  }catch(e){
    console.error(e);
  }
})();
</script>
{% endblock %}
