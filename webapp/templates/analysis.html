{% extends "base.html" %}
{% block content %}

<div class="analysis-page">

  <div class="card analysis-toolbar" id="analysis_toolbar">
    <div class="analysis-toolbar-left">
      <div class="h1" style="margin:0" data-i18n="analysis.title">üß† Analiza</div>
      <div class="small" id="analysis_status_line"></div>
    </div>

    <div class="analysis-toolbar-right">

      <!-- Generate first (per UX request) -->
      <button class="btn" id="an_generate_btn">üöÄ <span data-i18n="analysis.generate">Generuj</span></button>

      <!-- Models -->
      <div class="analysis-models" id="analysis_models">
  <div class="analysis-model">
    <span class="small" title="Quick model">‚ö°</span>
    <label class="small" for="an_model_quick" data-i18n="analysis.model_quick">Quick</label>
    <select class="input mini-select" id="an_model_quick" disabled>
      <option data-i18n="analysis.models_loading">≈Åadowanie‚Ä¶</option>
    </select>
  </div>
  <div class="analysis-model">
    <span class="small" title="Deep model">üîç</span>
    <label class="small" for="an_model_deep" data-i18n="analysis.model_deep">Deep</label>
    <select class="input mini-select" id="an_model_deep" disabled>
      <option data-i18n="analysis.models_loading">≈Åadowanie‚Ä¶</option>
    </select>
  </div>
</div>
      <!-- Report formats (multi-select) -->
      <div class="analysis-format" id="analysis_report_formats">
        <label class="small" data-i18n="analysis.report">Raport</label>
        <label class="pill"><input type="checkbox" name="an_report_fmt" value="html" checked> HTML</label>
        <label class="pill"><input type="checkbox" name="an_report_fmt" value="doc"> DOC</label>
        <label class="pill"><input type="checkbox" name="an_report_fmt" value="txt"> TXT</label>
      </div>

      <button class="btn secondary" id="an_report_save_btn">üíæ <span data-i18n="analysis.report_save">Zapisz</span></button>
    </div>
  </div>

  <!-- Tab bar -->
  <div class="analysis-tabs" id="analysis_tabs">
    <button class="analysis-tab active" data-tab="llm" id="tab_llm">
      <span class="analysis-tab-icon">üß†</span> Analiza LLM
    </button>
    <button class="analysis-tab" data-tab="aml" id="tab_aml">
      <span class="analysis-tab-icon">üîç</span> Analiza AML
    </button>
  </div>

  <!-- LLM Analysis content (existing) -->
  <div class="analysis-tab-content" id="llm_content">
  <div class="analysis-container">
    <aside class="analysis-sidebar" id="analysis_sidebar">

      <section class="card analysis-sidecard">
        <div class="analysis-sidehdr">
          <div class="h2" data-i18n="analysis.sources">üìÅ ≈πr√≥d≈Ça danych</div>
        </div>

        <div class="analysis-sidebody">
          <label class="check"><input type="checkbox" id="src_transcript"> <span data-i18n="analysis.src_transcript">Transkrypcja</span></label>
          <label class="check"><input type="checkbox" id="src_diarization"> <span data-i18n="analysis.src_diarization">Diaryzacja</span></label>
          <label class="check"><input type="checkbox" id="src_notes_global"> <span data-i18n="analysis.src_notes_global">Notatki globalne</span></label>
          <label class="check"><input type="checkbox" id="src_notes_blocks"> <span data-i18n="analysis.src_notes_blocks">Notatki do blok√≥w</span></label>

          <div class="analysis-docs">
            <div class="analysis-docs-top">
              <div class="h3" data-i18n="analysis.documents">üìé Dokumenty</div>
              <div class="analysis-docs-actions">
                <button class="btn secondary" id="docs_upload_btn">+ <span data-i18n="analysis.add">Dodaj</span></button>
              </div>
            </div>
            <div class="small" id="docs_hint" data-i18n="analysis.docs_hint">Zaznacz dokumenty, kt√≥re majƒÖ wej≈õƒá do analizy.</div>
            <div id="docs_list" class="docs-list"></div>
          </div>
        </div>
      </section>

      <section class="card analysis-sidecard">
        <div class="analysis-sidehdr">
          <div class="h2" data-i18n="analysis.prompts">üéØ Prompty</div>
          <div class="small" id="an_selected_count">0</div>
        </div>

        <div class="analysis-sidebody">
          <div id="prompts_box" class="prompts-box"></div>

          <div class="analysis-side-actions">
            <button class="btn secondary" id="prompt_new_btn">+ <span data-i18n="analysis.new_prompt">Nowy</span></button>
            <button class="btn secondary" id="prompt_import_btn">üì• <span data-i18n="analysis.import">Import</span></button>
          </div>
        </div>
      </section>

    </aside>

    <main class="analysis-main">

      <div class="card quick-analysis" id="quick_box">
        <div class="analysis-sidehdr">
          <div>
            <div class="h2" data-i18n="analysis.quick">‚ö° Szybka analiza</div>
            <div class="small" id="quick_state"></div>
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <label class="pill" title="Enable/disable background quick analysis">
              <input type="checkbox" id="quick_enabled_toggle" checked>
              <span data-i18n="analysis.quick_enabled">Auto</span>
            </label>
            <button class="btn secondary" id="quick_toggle_btn">‚àí</button>
          </div>
        </div>
        <div id="quick_body" class="quick-body">
          <div class="small" data-i18n="analysis.quick_loading">≈Åadowanie‚Ä¶</div>
        </div>
      </div>

      <div class="card custom-prompt" id="custom_prompt_box">
        <div class="analysis-sidehdr">
          <div>
            <div class="h2" data-i18n="analysis.custom_prompt_title">‚úçÔ∏è W≈Çasny prompt</div>
            <div class="small muted" data-i18n="analysis.custom_prompt_desc">Szybkie polecenie dla g≈Çƒôbokiej analizy. Je≈õli puste ‚Äì analiza dzia≈Ça jak dotychczas.</div>
          </div>
          <label class="pill" title="Combine with selected prompts">
            <input type="checkbox" id="custom_prompt_use_templates" checked>
            <span data-i18n="analysis.custom_prompt_use_templates">Po≈ÇƒÖcz z zaznaczonymi promptami</span>
          </label>
        </div>
        <div class="custom-prompt-body" style="margin-top:10px">
          <textarea class="input" id="custom_prompt_text" style="min-height:120px" data-i18n-placeholder="analysis.custom_prompt_placeholder" placeholder="Np. Zr√≥b formalny protok√≥≈Ç spotkania z decyzjami i zadaniami‚Ä¶"></textarea>
        </div>
      </div>

      <div class="card deep-analysis" id="deep_box">
        <div class="analysis-sidehdr">
          <div class="h2" data-i18n="analysis.deep">üîç G≈Çƒôboka analiza</div>
          <div class="small" id="deep_state"></div>
        </div>

        <!-- Progress (similar to Transcription/Di... ) -->
        <div class="an-progress" id="an_progress">
          <div class="small"><span data-i18n="common.progress">Postƒôp</span>: <span id="an_prog_pct">0%</span></div>
          <div class="progress"><div id="an_prog_bar"></div></div>
        </div>

        <div id="deep_result" class="deep-result">
          <div class="small" data-i18n="analysis.deep_hint">Wybierz ≈∫r√≥d≈Ça i prompty, potem kliknij ‚ÄûGeneruj‚Äù.</div>
        </div>
      </div>

      <!-- Finance entities panel (visible only after finance analysis) -->
      <div class="card" id="finance_entities_box" style="display:none;">
        <div class="analysis-sidehdr">
          <div class="h2">üè¶ <span data-i18n="finance.entities.title">Podmioty (Intelligence Memory)</span></div>
          <button class="btn mini" id="finance_entities_refresh" title="Od≈õwie≈º">‚Üª</button>
        </div>
        <div class="small" style="margin-bottom:8px;" data-i18n="finance.entities.hint">
          Oznacz podmioty jako podejrzane ‚Äî zostanƒÖ zapamiƒôtane w przysz≈Çych analizach.
        </div>
        <div id="finance_entities_list" class="finance-entities-list"></div>
      </div>

      <div class="analysis-actions" id="analysis_actions">
        <button class="btn secondary" id="an_copy_btn">üìã <span data-i18n="analysis.copy">Kopiuj</span></button>
        <button class="btn secondary" id="an_stop_btn" style="display:none">‚õî <span data-i18n="analysis.stop">Stop</span></button>
        <span id="an_download_slot"></span>
      </div>

    </main>
  </div>

  <button class="analysis-sidebar-toggle" id="analysis_sidebar_toggle" title="Toggle sidebar">‚óÄÔ∏é</button>
  </div><!-- /llm_content -->

  <!-- AML Analysis content -->
  <div class="analysis-tab-content" id="aml_content" style="display:none">

    <!-- Upload zone -->
    <div class="card aml-upload-zone" id="aml_upload_zone">
      <div class="aml-upload-inner" id="aml_drop_area">
        <div class="aml-upload-icon">üìÑ</div>
        <div class="h2">Analiza AML wyciagu bankowego</div>
        <div class="small muted">Przeciagnij plik PDF lub kliknij aby wybrac</div>
        <button class="btn" id="aml_upload_btn">Wybierz plik</button>
        <input type="file" id="aml_file_input" accept=".pdf" style="display:none">
      </div>
    </div>

    <!-- Progress -->
    <div class="card aml-progress-card" id="aml_progress_card" style="display:none">
      <div class="analysis-sidehdr">
        <div class="h2">Analizuje wyciag...</div>
      </div>
      <div class="an-progress" style="padding:10px 0">
        <div class="progress"><div id="aml_prog_bar" style="width:0%"></div></div>
        <div class="small muted" id="aml_prog_text">Przetwarzanie PDF...</div>
      </div>
    </div>

    <!-- Results -->
    <div id="aml_results" style="display:none">

      <!-- Summary row: risk score + bank info -->
      <div class="aml-summary-row">
        <div class="card aml-risk-card" id="aml_risk_card">
          <div class="aml-risk-gauge">
            <svg viewBox="0 0 120 80" class="aml-gauge-svg">
              <path d="M 10 70 A 50 50 0 0 1 110 70" fill="none" stroke="rgba(0,0,0,.08)" stroke-width="10" stroke-linecap="round"/>
              <path d="M 10 70 A 50 50 0 0 1 110 70" fill="none" stroke="var(--gauge-color, #15803d)" stroke-width="10" stroke-linecap="round"
                    id="aml_gauge_arc" stroke-dasharray="0 157" />
            </svg>
            <div class="aml-risk-number" id="aml_risk_number">0</div>
          </div>
          <div class="aml-risk-label" id="aml_risk_label">Ryzyko AML</div>
        </div>

        <div class="card aml-info-card" id="aml_info_card">
          <div class="h2">Informacje o wyciagu</div>
          <div class="aml-info-grid" id="aml_info_grid">
            <!-- Filled by JS -->
          </div>
        </div>
      </div>

      <!-- Alerts -->
      <div class="card" id="aml_alerts_card">
        <div class="analysis-sidehdr">
          <div class="h2">Alerty</div>
          <span class="small aml-badge" id="aml_alerts_count">0</span>
        </div>
        <div id="aml_alerts_list" style="margin-top:10px"></div>
      </div>

      <!-- Graph -->
      <div class="card" id="aml_graph_card">
        <div class="analysis-sidehdr">
          <div class="h2">Graf przeplywow</div>
          <div style="display:flex;gap:8px;align-items:center">
            <select class="input" id="aml_graph_risk_filter" style="padding:5px 8px;border-radius:10px;min-width:130px">
              <option value="">Wszystkie</option>
              <option value="high">Wysokie ryzyko</option>
              <option value="medium">Srednie</option>
              <option value="low">Niskie</option>
            </select>
          </div>
        </div>
        <div id="aml_graph_container" style="height:420px;border:1px solid var(--border);border-radius:12px;margin-top:10px;background:rgba(15,23,42,.02)"></div>
      </div>

      <!-- Transactions table -->
      <div class="card" id="aml_tx_card">
        <div class="analysis-sidehdr">
          <div class="h2">Transakcje</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input class="input" id="aml_tx_search" placeholder="Szukaj..." style="width:180px;padding:5px 10px;border-radius:10px">
            <select class="input" id="aml_tx_channel_filter" style="padding:5px 8px;border-radius:10px;min-width:130px">
              <option value="">Kanal: wszystkie</option>
            </select>
            <span class="small muted" id="aml_tx_count">0</span>
          </div>
        </div>
        <div id="aml_tx_table_wrap" style="max-height:450px;overflow:auto;margin-top:10px"></div>
      </div>

      <!-- Counterparty memory -->
      <div class="card" id="aml_memory_card">
        <div class="analysis-sidehdr">
          <div class="h2">Pamiec kontrahentow</div>
          <button class="btn mini" id="aml_memory_refresh" title="Odswiez">&#x21bb;</button>
        </div>
        <div class="small muted" style="margin:6px 0">Oznacz podmioty jako podejrzane ‚Äî zostana zapamietane w przyszlych analizach.</div>
        <div id="aml_memory_list" style="max-height:300px;overflow:auto"></div>
      </div>

      <!-- Actions -->
      <div class="analysis-actions">
        <button class="btn" id="aml_download_report">Pobierz raport HTML</button>
        <button class="btn secondary" id="aml_new_analysis">Nowa analiza</button>
      </div>
    </div>

    <!-- History -->
    <div class="card" id="aml_history_card" style="display:none">
      <div class="analysis-sidehdr">
        <div class="h2">Historia analiz AML</div>
      </div>
      <div id="aml_history_list" style="margin-top:10px"></div>
    </div>

  </div><!-- /aml_content -->

  <!-- Hidden file inputs -->
  <input type="file" id="docs_file_input" style="display:none" multiple>
  <input type="file" id="prompt_import_input" style="display:none" accept="application/json">

  <!-- Prompt dialog -->
  <dialog id="prompt_dialog" class="an-dialog">
    <form method="dialog" class="an-dialog-form">
      <div class="h2" id="prompt_dialog_title">Prompt</div>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <div class="label" data-i18n="analysis.prompt_name">Nazwa</div>
          <input class="input" id="prompt_name" placeholder="Np. M√≥j raport" required>
        </div>
        <div>
          <div class="label" data-i18n="analysis.prompt_icon">Ikona</div>
          <input class="input" id="prompt_icon" placeholder="üìã">
        </div>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <div class="label" data-i18n="analysis.prompt_category">Kategoria</div>
          <input class="input" id="prompt_category" placeholder="Biznesowe">
        </div>
        <div>
          <div class="label" data-i18n="analysis.prompt_description">Opis</div>
          <input class="input" id="prompt_description" placeholder="">
        </div>
      </div>

      <div>
        <div class="label" data-i18n="analysis.prompt_text">Tre≈õƒá promptu</div>
        <textarea class="input" id="prompt_text" style="min-height:180px" placeholder="Wpisz tre≈õƒá promptu..."></textarea>
      </div>

      <div class="an-dialog-actions">
        <button class="btn secondary" value="cancel" data-i18n="btn.cancel">‚úï Anuluj</button>
        <button class="btn danger" id="prompt_delete_btn" type="button" style="display:none">üóë Usu≈Ñ</button>
        <button class="btn" id="prompt_save_btn" value="ok">üíæ Zapisz</button>
      </div>
    </form>
  </dialog>

</div>
{% endblock %}

{% block scripts %}
<script src="/static/analysis.js?v={{ app_version }}"></script>
<script src="/static/aml.js?v={{ app_version }}"></script>
<script>
(async()=>{
  try{
    // Tab switching
    const tabs = document.querySelectorAll('.analysis-tab[data-tab]');
    const llmContent = document.getElementById('llm_content');
    const amlContent = document.getElementById('aml_content');
    const toolbar = document.getElementById('analysis_toolbar');
    const sidebarToggle = document.getElementById('analysis_sidebar_toggle');

    tabs.forEach(tab => {
      tab.addEventListener('click', async () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const which = tab.getAttribute('data-tab');
        if(which === 'aml'){
          llmContent.style.display = 'none';
          amlContent.style.display = '';
          // Hide LLM-specific toolbar items
          document.getElementById('analysis_models').style.display = 'none';
          document.getElementById('analysis_report_formats').style.display = 'none';
          document.getElementById('an_generate_btn').style.display = 'none';
          document.getElementById('an_report_save_btn').style.display = 'none';
          if(sidebarToggle) sidebarToggle.style.display = 'none';
          // Init AML if not done
          if(window.AmlManager && !window.AmlManager._initialized){
            await AmlManager.init();
          }
        } else {
          llmContent.style.display = '';
          amlContent.style.display = 'none';
          document.getElementById('analysis_models').style.display = '';
          document.getElementById('analysis_report_formats').style.display = '';
          document.getElementById('an_generate_btn').style.display = '';
          document.getElementById('an_report_save_btn').style.display = '';
          if(sidebarToggle) sidebarToggle.style.display = '';
        }
      });
    });

    if(window.AnalysisManager){
      await AnalysisManager.init();
    }
  }catch(e){
    console.error(e);
  }
})();
</script>
{% endblock %}
