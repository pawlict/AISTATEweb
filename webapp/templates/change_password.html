<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Zmiana hasla â€” {{ app_name }}</title>
  <link rel="stylesheet" href="/static/app.css?v={{ app_version }}&_={{ static_ts }}"/>
  <style>
    body { background: var(--bg, #f0f2f5); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; font-family: var(--font, 'Segoe UI', system-ui, sans-serif); }
    .pw-card { background: var(--card-bg, #fff); border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,.08); padding: 2.5rem 2rem; width: 100%; max-width: 420px; }
    .pw-logo { text-align: center; margin-bottom: 1.2rem; }
    .pw-logo img { height: 56px; }
    .pw-logo h1 { font-size: 1.15rem; margin: .5rem 0 0; color: var(--text, #1a1a2e); }
    .pw-field { margin-bottom: .9rem; }
    .pw-field label { display: block; font-size: .85rem; font-weight: 600; margin-bottom: .3rem; color: var(--text, #1a1a2e); }
    .pw-field .en { font-size: .595rem; font-weight: 400; color: var(--muted, #999); font-style: italic; margin-left: .3rem; }
    .pw-field input { width: 100%; padding: .6rem .75rem; border: 1.5px solid var(--border, #d0d5dd); border-radius: 8px; font-size: .95rem; box-sizing: border-box; outline: none; transition: border-color .2s; }
    .pw-field input:focus { border-color: var(--accent, #4a6cf7); }
    .pw-btn { width: 100%; padding: .7rem; border: none; border-radius: 8px; background: var(--accent, #4a6cf7); color: #fff; font-size: 1rem; font-weight: 600; cursor: pointer; transition: opacity .2s; }
    .pw-btn:hover { opacity: .9; }
    .pw-btn:disabled { opacity: .5; cursor: not-allowed; }
    .pw-error { color: #e74c3c; font-size: .85rem; margin-top: .75rem; min-height: 1.2em; text-align: center; }
    .pw-reason { font-size: .85rem; color: #e67e22; line-height: 1.5; margin: 0 0 1rem; text-align: center; }
    .pw-hint { font-size: .76rem; color: var(--muted, #888); line-height: 1.45; margin-top: .5rem; text-align: center; }
    .lang-switch { display: flex; justify-content: center; gap: .3rem; margin-bottom: 1rem; }
    .lang-btn { padding: .25rem .6rem; border: 1.5px solid var(--border, #d0d5dd); border-radius: 6px; background: transparent; cursor: pointer; font-size: .78rem; font-weight: 600; color: var(--muted, #888); transition: all .2s; }
    .lang-btn.active { background: var(--accent, #4a6cf7); color: #fff; border-color: var(--accent, #4a6cf7); }
  </style>
</head>
<body>
  <div class="pw-card">
    <div class="pw-logo">
      <img src="/static/logo.png" alt="Logo"/>
      <h1>{{ app_name }}</h1>
    </div>

    <div class="lang-switch" id="langSwitch">
      <button class="lang-btn active" data-lang="pl">PL</button>
      <button class="lang-btn" data-lang="en">EN</button>
    </div>

    <h2 style="text-align:center;font-size:1.05rem;margin:0 0 .3rem;">
      Zmiana hasla <span class="en" style="display:block;font-size:.8rem;">Change Password</span>
    </h2>

    <p class="pw-reason" id="pwReason">
      Musisz zmienic haslo, aby kontynuowac.
      <span class="en" style="display:block;font-size:.75rem;margin-top:.2rem;">You must change your password to continue.</span>
    </p>

    <div class="pw-field">
      <label for="currentPw">Aktualne haslo <span class="en">Current password</span></label>
      <input type="password" id="currentPw" autocomplete="current-password"/>
    </div>
    <div class="pw-field">
      <label for="newPw">Nowe haslo <span class="en">New password</span></label>
      <input type="password" id="newPw" autocomplete="new-password"/>
    </div>
    <div class="pw-field">
      <label for="confirmPw">Potwierdz nowe haslo <span class="en">Confirm new password</span></label>
      <input type="password" id="confirmPw" autocomplete="new-password"/>
    </div>

    <button class="pw-btn" id="changePwBtn">Zmien haslo <span class="en" style="font-size:.8rem;font-weight:400;margin-left:.3rem;">Change password</span></button>
    <div class="pw-error" id="pwError"></div>

    <div class="pw-hint" id="pwHint"></div>

    <div style="text-align:center;margin-top:1rem;">
      <a href="#" id="logoutLink" style="color:var(--muted,#888);font-size:.82rem;text-decoration:none;">
        Wyloguj sie <span class="en">Log out</span>
      </a>
    </div>
  </div>

<script>
(function(){
  var curLang = localStorage.getItem('aistate_ui_lang') || 'pl';

  /* Language toggle */
  document.querySelectorAll('.lang-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      curLang = btn.dataset.lang;
      localStorage.setItem('aistate_ui_lang', curLang);
      document.querySelectorAll('.lang-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.lang === curLang); });
    });
  });
  /* Apply saved language */
  document.querySelectorAll('.lang-btn').forEach(function(b) {
    b.classList.toggle('active', b.dataset.lang === curLang);
  });

  /* Load password policy hints */
  fetch('/api/auth/password-policy').then(function(r) { return r.json(); }).then(function(d) {
    if (d.status !== 'ok') return;
    var hint = '';
    if (d.policy === 'basic') hint = 'Min. 8 znakow / Min. 8 characters';
    else if (d.policy === 'medium') hint = 'Min. 8 znakow + a-z A-Z 0-9';
    else if (d.policy === 'strong') hint = 'Min. 12 znakow + a-z A-Z 0-9 + znak specjalny (!@#$...)';
    document.getElementById('pwHint').textContent = hint;
  }).catch(function(){});

  /* Change password */
  document.getElementById('changePwBtn').addEventListener('click', async function() {
    var errEl = document.getElementById('pwError');
    var btn = this;
    errEl.textContent = '';

    var cur = document.getElementById('currentPw').value;
    var nw = document.getElementById('newPw').value;
    var confirm = document.getElementById('confirmPw').value;

    if (!cur) {
      errEl.textContent = curLang === 'en' ? 'Enter current password' : 'Podaj aktualne haslo';
      return;
    }
    if (!nw || nw.length < 6) {
      errEl.textContent = curLang === 'en' ? 'Password must be at least 6 characters' : 'Haslo musi miec min. 6 znakow';
      return;
    }
    if (nw !== confirm) {
      errEl.textContent = curLang === 'en' ? 'Passwords do not match' : 'Hasla nie sa identyczne';
      return;
    }
    if (nw === cur) {
      errEl.textContent = curLang === 'en' ? 'New password must differ from the current one' : 'Nowe haslo musi sie roznic od obecnego';
      return;
    }

    btn.disabled = true;
    try {
      var res = await fetch('/api/auth/change-password', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ current_password: cur, new_password: nw }),
      });
      var data = await res.json();
      if (res.ok && data.status === 'ok') {
        location.href = '/';
      } else {
        errEl.textContent = data.message || 'Error';
      }
    } catch (e) {
      errEl.textContent = curLang === 'en' ? 'Connection error' : 'Blad polaczenia';
    } finally {
      btn.disabled = false;
    }
  });

  /* Enter key support */
  document.getElementById('confirmPw').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') document.getElementById('changePwBtn').click();
  });

  /* Logout */
  document.getElementById('logoutLink').addEventListener('click', async function(e) {
    e.preventDefault();
    await fetch('/api/auth/logout', {method: 'POST'});
    location.href = '/login';
  });
})();
</script>
</body>
</html>
