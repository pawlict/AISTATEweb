{% extends "base.html" %}
{% block content %}
<div class="card">
  <h1 class="h1" data-i18n="settings.page_title">Settings</h1>

  <div class="grid">
    <div class="subcard">
      <div class="label" data-i18n="settings.whisper_default_label">Default Whisper model</div>
      <select id="def_whisper">
        {% for m in whisper_models %}
        <option value="{{m}}" {% if m==settings.whisper_model %}selected{% endif %}>{{m}}</option>
        {% endfor %}
      </select>

      <div class="hr"></div>

      <div class="label" data-i18n="settings.ui_language">UI language</div>
      <select id="ui_lang">
        <option value="pl" data-i18n="lang.pl">Polski</option>
        <option value="en" data-i18n="lang.en">English</option>
      </select>

      <div class="hr"></div>

      <!-- Translation options were moved to dedicated panels (Translations + NLLB Settings). -->

      <div id="settings_msg" class="small muted"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // set current value from localStorage first, fallback to backend settings
  const savedLang = localStorage.getItem("aistate_ui_lang");
  const initialLang = savedLang || "{{ settings.ui_language or 'pl' }}";
  const uiLangEl = document.getElementById("ui_lang");
  if(uiLangEl) uiLangEl.value = initialLang;

  // apply i18n now (base calls applyI18n too, but settings needs options translated)
  applyI18n();

  async function saveSettingsPartial(payload){
    try{
      await api("/api/settings", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload)
      });
      const msg = document.getElementById("settings_msg");
      if(msg) msg.textContent = t("settings.autosaved") || t("settings.saved") || "Saved";
    }catch(e){
      const msg = document.getElementById("settings_msg");
      if(msg) msg.textContent = (t("settings.save_error") || "Save error") + ": " + (e?.message || e);
      console.warn(e);
    }
  }

  // Auto-save default Whisper model
  const defWhisper = document.getElementById("def_whisper");
  if(defWhisper){
    defWhisper.addEventListener("change", ()=>{
      saveSettingsPartial({ whisper_model: defWhisper.value });
    });
  }

  // UI language: save first, then reload
  if(uiLangEl){
    uiLangEl.addEventListener("change", async ()=>{
      const v = uiLangEl.value;
      localStorage.setItem("aistate_ui_lang", v);
      await saveSettingsPartial({ ui_language: v });
      location.reload();
    });
  }
</script>
{% endblock %}
