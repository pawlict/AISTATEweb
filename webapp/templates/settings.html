{% extends "base.html" %}
{% block content %}
<div class="card">
  <h1 class="h1" data-i18n="settings.page_title">Settings</h1>

  <div class="grid">
    <div class="subcard">
      <div class="label" data-i18n="settings.hf_label">Hugging Face Token (pyannote)</div>
      <input class="input" id="hf_token" type="password" data-i18n-placeholder="settings.hf_placeholder"
             placeholder="Paste your token (stored locally on the server)" value="{{ settings.hf_token or '' }}"/>
      <div class="small" data-i18n-html="settings.hf_hint_html">Token jest przechowywany w pliku <code>settings.json</code> w katalogu konfiguracji.</div>

      <div class="hr"></div>

      <div class="label" data-i18n="settings.whisper_default_label">Default Whisper model</div>
      <select id="def_whisper">
        {% for m in whisper_models %}
        <option value="{{m}}" {% if m==settings.whisper_model %}selected{% endif %}>{{m}}</option>
        {% endfor %}
      </select>

      <div class="hr"></div>

      <div class="label" data-i18n="settings.ui_language">UI language</div>
      <select id="ui_lang">
        <option value="pl" data-i18n="lang.pl">Polski</option>
        <option value="en" data-i18n="lang.en">English</option>
      </select>

      <div class="hr"></div>

      <div id="settings_msg" class="small muted"></div>
    </div>

    <div class="subcard">
<div class="label" data-i18n="settings.llm_title">ü§ñ Modele LLM (Ollama)</div>

<style>
  /* Inline layout only for Settings -> LLM section */
  .llm-toolbar-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .llm-toolbar-row .spacer{ flex:1 1 auto; }
  .llm-row{ display:grid; grid-template-columns: minmax(360px, 520px) 1fr; gap:14px; align-items:start; }
  .llm-info-box{
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 10px 12px;
  }
  .llm-info-title{ font-weight:600; margin-bottom:6px; }
  .llm-info-box .plain-list{ margin:6px 0 0 18px; }
  .llm-info-box .hr{ margin:10px 0; }
  .llm-inline-warn{ margin-top:10px; }
  .llm-install-row{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
  .llm-install-row .small{ margin:0; }
  @media (max-width: 980px){
    .llm-row{ grid-template-columns: 1fr; }
  }
.llm-mini-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
}
.llm-mini-col{ line-height:1.45; }
.llm-mini-h{ font-weight:600; margin-bottom:6px; opacity:.95; }
.llm-mini-cases{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:4px 12px;
  margin-top:6px;
}
.llm-mini-case{ line-height:1.35; }
.llm-mini-rec{ line-height:1.45; margin-top:6px; }
@media (max-width: 980px){
  .llm-mini-grid{ grid-template-columns: 1fr; }
  .llm-mini-cases{ grid-template-columns: 1fr; }
}
</style>

<div class="ollama-status-row llm-toolbar-row" id="llm_ollama_status">
  <span class="status-dot offline" id="llm_status_dot"></span>
  <span class="small" id="llm_status_text" data-i18n="settings.llm_status_checking">Sprawdzanie‚Ä¶</span>
  <span class="small muted" id="llm_status_url"></span>
  <span class="spacer"></span>
  <button class="btn secondary mini" id="llm_refresh_btn" type="button">üîÑ <span data-i18n="settings.llm_refresh">Od≈õwie≈º listƒô modeli</span></button>
</div>

<div class="small muted" id="llm_refresh_msg" style="margin-top:6px;"></div>

<div class="hr"></div>

<!-- QUICK -->
<div class="llm-row llm-group">
  <div>
    <div class="label" data-i18n="settings.llm_quick_title">‚ö° Szybka analiza</div>
    <div class="small muted" data-i18n="settings.llm_quick_desc">Model do automatycznej analizy w tle (kilka sekund).</div>
    <select id="llm_quick_select" class="input"></select>

    <div class="llm-install-row">
      <button class="btn primary mini" type="button" id="llm_quick_install_btn" style="display:none;">‚¨áÔ∏è <span data-i18n="settings.llm_install">Instaluj</span></button>
      <span class="small muted" id="llm_quick_warn"></span>
    </div>
  </div>

  <div>
    <div class="llm-info-box">
      <div class="llm-info-title small">‚ÑπÔ∏è <span data-i18n="settings.llm_info_inline">Informacje o modelu</span></div>
      <div class="small" id="llm_quick_info_name">‚Äî</div>
      <div id="llm_quick_info_body" class="small muted" style="margin-top:6px;"></div>
      <div class="llm-warn llm-inline-warn" id="llm_quick_info_warning" style="display:none"></div>
    </div>
  </div>
</div>

<div class="hr"></div>

<!-- DEEP -->
<div class="llm-row llm-group">
  <div>
    <div class="label" data-i18n="settings.llm_deep_title">üîç G≈Çƒôboka analiza</div>
    <div class="small muted" data-i18n="settings.llm_deep_desc">Model do szczeg√≥≈Çowych raport√≥w (dziesiƒÖtki sekund / minuty).</div>
    <select id="llm_deep_select" class="input"></select>

    <div class="llm-install-row">
      <button class="btn primary mini" type="button" id="llm_deep_install_btn" style="display:none;">‚¨áÔ∏è <span data-i18n="settings.llm_install">Instaluj</span></button>
      <span class="small muted" id="llm_deep_warn"></span>
    </div>
  </div>

  <div>
    <div class="llm-info-box">
      <div class="llm-info-title small">‚ÑπÔ∏è <span data-i18n="settings.llm_info_inline">Informacje o modelu</span></div>
      <div class="small" id="llm_deep_info_name">‚Äî</div>
      <div id="llm_deep_info_body" class="small muted" style="margin-top:6px;"></div>
      <div class="llm-warn llm-inline-warn" id="llm_deep_info_warning" style="display:none"></div>
    </div>
  </div>
</div>

<div class="hr"></div>

<!-- VISION / OCR -->
<div class="llm-row llm-group">
  <div>
    <div class="label" data-i18n="settings.llm_vision_title">üñºÔ∏è Vision / OCR (dokumenty, faktury)</div>
    <div class="small muted" data-i18n="settings.llm_vision_desc">Model do OCR dokument√≥w, faktur, rachunk√≥w, biling√≥w.</div>
    <select id="llm_vision_select" class="input"></select>

    <div class="llm-install-row">
      <button class="btn primary mini" type="button" id="llm_vision_install_btn" style="display:none;">‚¨áÔ∏è <span data-i18n="settings.llm_install">Instaluj</span></button>
      <span class="small muted" id="llm_vision_warn"></span>
    </div>
  </div>

  <div>
    <div class="llm-info-box">
      <div class="llm-info-title small">‚ÑπÔ∏è <span data-i18n="settings.llm_info_inline">Informacje o modelu</span></div>
      <div class="small" id="llm_vision_info_name">‚Äî</div>
      <div id="llm_vision_info_body" class="small muted" style="margin-top:6px;"></div>
      <div class="llm-warn llm-inline-warn" id="llm_vision_info_warning" style="display:none"></div>
    </div>
  </div>
</div>

<div class="hr"></div>

<!-- TRANSLATION -->
<div class="llm-row llm-group">
  <div>
    <div class="label" data-i18n="settings.llm_translation_title">üåç T≈Çumaczenia (w tym cyrylica)</div>
    <div class="small muted" data-i18n="settings.llm_translation_desc">Model do t≈Çumacze≈Ñ PL/RU/UK/EN. Obs≈Çuga cyrylicy.</div>
    <select id="llm_translation_select" class="input"></select>

    <div class="llm-install-row">
      <button class="btn primary mini" type="button" id="llm_translation_install_btn" style="display:none;">‚¨áÔ∏è <span data-i18n="settings.llm_install">Instaluj</span></button>
      <span class="small muted" id="llm_translation_warn"></span>
    </div>
  </div>

  <div>
    <div class="llm-info-box">
      <div class="llm-info-title small">‚ÑπÔ∏è <span data-i18n="settings.llm_info_inline">Informacje o modelu</span></div>
      <div class="small" id="llm_translation_info_name">‚Äî</div>
      <div id="llm_translation_info_body" class="small muted" style="margin-top:6px;"></div>
      <div class="llm-warn llm-inline-warn" id="llm_translation_info_warning" style="display:none"></div>
    </div>
  </div>
</div>

<div class="hr"></div>

<!-- FINANCIAL -->
<div class="llm-row llm-group">
  <div>
    <div class="label" data-i18n="settings.llm_financial_title">üí∞ Analiza finansowa</div>
    <div class="small muted" data-i18n="settings.llm_financial_desc">Model do analizy rachunk√≥w, balance check, detekcji hazardu.</div>
    <select id="llm_financial_select" class="input"></select>

    <div class="llm-install-row">
      <button class="btn primary mini" type="button" id="llm_financial_install_btn" style="display:none;">‚¨áÔ∏è <span data-i18n="settings.llm_install">Instaluj</span></button>
      <span class="small muted" id="llm_financial_warn"></span>
    </div>
  </div>

  <div>
    <div class="llm-info-box">
      <div class="llm-info-title small">‚ÑπÔ∏è <span data-i18n="settings.llm_info_inline">Informacje o modelu</span></div>
      <div class="small" id="llm_financial_info_name">‚Äî</div>
      <div id="llm_financial_info_body" class="small muted" style="margin-top:6px;"></div>
      <div class="llm-warn llm-inline-warn" id="llm_financial_info_warning" style="display:none"></div>
    </div>
  </div>
</div>

<div class="hr"></div>

<!-- SPECIALIZED -->
<div class="llm-row llm-group">
  <div>
    <div class="label" data-i18n="settings.llm_specialized_title">üîß Specjalistyczne (prawne, advanced)</div>
    <div class="small muted" data-i18n="settings.llm_specialized_desc">Modele prawne (umowy), advanced reasoning.</div>
    <select id="llm_specialized_select" class="input"></select>

    <div class="llm-install-row">
      <button class="btn primary mini" type="button" id="llm_specialized_install_btn" style="display:none;">‚¨áÔ∏è <span data-i18n="settings.llm_install">Instaluj</span></button>
      <span class="small muted" id="llm_specialized_warn"></span>
    </div>
  </div>

  <div>
    <div class="llm-info-box">
      <div class="llm-info-title small">‚ÑπÔ∏è <span data-i18n="settings.llm_info_inline">Informacje o modelu</span></div>
      <div class="small" id="llm_specialized_info_name">‚Äî</div>
      <div id="llm_specialized_info_body" class="small muted" style="margin-top:6px;"></div>
      <div class="llm-warn llm-inline-warn" id="llm_specialized_info_warning" style="display:none"></div>
    </div>
  </div>


<div class="hr"></div>

<!-- CUSTOM / USER MODEL -->
<div class="llm-row llm-group">
  <div style="grid-column: 1 / -1;">
    <div class="label" data-i18n="settings.llm_custom_title">‚ûï Dodaj w≈Çasny model Ollama</div>
    <div class="small muted" data-i18n="settings.llm_custom_desc">Wpisz dowolny model zainstalowany lub dostƒôpny w Ollama (np. phi4:latest). Mo≈ºesz go dodaƒá do wybranej grupy.</div>

    <div style="display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap;">
      <select id="llm_custom_group" class="input" style="max-width:220px;">
        <option value="deep" data-i18n="settings.llm_group_deep">G≈Çƒôboka analiza</option>
        <option value="quick" data-i18n="settings.llm_group_quick">Szybka analiza</option>
        <option value="vision" data-i18n="settings.llm_group_vision">Vision / OCR</option>
        <option value="translation" data-i18n="settings.llm_group_translation">T≈Çumaczenia</option>
        <option value="financial" data-i18n="settings.llm_group_financial">Finanse</option>
        <option value="specialized" data-i18n="settings.llm_group_specialized">Specjalistyczne</option>
      </select>
      <input id="llm_custom_model_id" class="input" type="text" placeholder="np. phi4:latest, llama3.2:1b, mymodel:tag" style="flex:1; min-width:260px;">
      <button class="btn primary mini" type="button" id="llm_custom_add_btn">‚ûï <span data-i18n="settings.llm_custom_add">Dodaj</span></button>
    </div>

    <div class="small muted" id="llm_custom_msg" style="margin-top:6px;"></div>
    <div class="small" id="llm_custom_list" style="margin-top:8px;"></div>
  </div>
</div>

</div>

    </div>
  </div>
</div>



{% endblock %}

{% block scripts %}
<script src="/static/settings_models.js"></script>
<script>
  // set current value from localStorage first, fallback to backend settings
  const savedLang = localStorage.getItem("aistate_ui_lang");
  const initialLang = savedLang || "{{ settings.ui_language or 'pl' }}";
  const uiLangEl = document.getElementById("ui_lang");
  if(uiLangEl) uiLangEl.value = initialLang;

  // apply i18n now (base calls applyI18n too, but settings needs options translated)
  applyI18n();

  async function saveSettingsPartial(payload){
    try{
      await api("/api/settings", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload)
      });
      const msg = document.getElementById("settings_msg");
      if(msg) msg.textContent = t("settings.autosaved") || t("settings.saved") || "Saved ‚úÖ";
    }catch(e){
      const msg = document.getElementById("settings_msg");
      if(msg) msg.textContent = (t("settings.save_error") || "Save error") + ": " + (e?.message || e);
      console.warn(e);
    }
  }

  // init Ollama model settings UI
  (async ()=>{
    try{
      if(window.ModelSettings && typeof window.ModelSettings.init === "function"){
        await window.ModelSettings.init();
      }
    }catch(e){
      console.warn(e);
    }
  })();

  // Auto-save HF token (paste => immediate, typing => debounced)
  const hf = document.getElementById("hf_token");
  let hfTimer = null;
  if(hf){
    hf.addEventListener("paste", ()=>{
      setTimeout(()=> saveSettingsPartial({ hf_token: hf.value }), 0);
    });

    hf.addEventListener("input", ()=>{
      clearTimeout(hfTimer);
      hfTimer = setTimeout(()=> saveSettingsPartial({ hf_token: hf.value }), 800);
    });

    hf.addEventListener("change", ()=>{
      saveSettingsPartial({ hf_token: hf.value });
    });
  }

  // Auto-save default Whisper model
  const defWhisper = document.getElementById("def_whisper");
  if(defWhisper){
    defWhisper.addEventListener("change", ()=>{
      saveSettingsPartial({ whisper_model: defWhisper.value });
    });
  }

  // UI language: save first, then reload
  if(uiLangEl){
    uiLangEl.addEventListener("change", async ()=>{
      const v = uiLangEl.value;
      localStorage.setItem("aistate_ui_lang", v);
      await saveSettingsPartial({ ui_language: v });
      location.reload();
    });
  }
</script>
{% endblock %}
