{% extends "base.html" %}
{% block content %}
<div class="card">
  <h1 class="h1" data-i18n="page.diarization.title">Diarization</h1>

  <div class="topgrid">
    <div class="subcard">
      <div class="label">Tryb</div>
      <select id="di_mode">
        <option value="pyannote">pyannote (audio)</option>
        <option value="text">diaryzacja tekstu (prosta)</option>
      </select>
      <div class="small">Tryb <b>pyannote</b> wymaga tokena HF (w Ustawieniach).</div>

      <div class="hr"></div>

      <div id="di_pyannote_block">
        <div class="grid" style="grid-template-columns: 1fr 1fr">
          <div>
            <div class="label">Język</div>
            <select id="di_lang">
              <option value="auto">auto</option>
              <option value="pl">pl</option>
              <option value="en">en</option>
              <option value="de">de</option>
              <option value="fr">fr</option>
              <option value="es">es</option>
              <option value="uk">uk</option>
              <option value="ru">ru</option>
            </select>
          </div>
          <div>
            <div class="label">Model Whisper (do segmentów)</div>
            <select id="di_model">
              {% for m in whisper_models %}
              <option value="{{m}}" {% if m==default_whisper_model %}selected{% endif %}>{{m}}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="hr"></div>
      </div>

      <div id="di_text_block" style="display:none">
        <div class="label">Tekst wejściowy</div>
        <textarea id="di_text_in" style="min-height:140px" placeholder="Wklej tekst do prostej diaryzacji…"></textarea>

        <div class="hr"></div>

        <div class="grid" style="grid-template-columns: 1fr 1fr">
          <div>
            <div class="label">Liczba mówców</div>
            <input class="input" id="di_speakers" type="number" min="1" max="20" value="2"/>
          </div>
          <div>
            <div class="label">Metoda</div>
            <select id="di_method">
              <option value="alternate">naprzemiennie</option>
              <option value="block">blokami</option>
              <option value="lines">po liniach</option>
              <option value="sentences">po zdaniach</option>
              <option value="sentences+merge">zdania + łączenie</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="label">Mapowanie mówców (JSON)</div>
        <textarea id="di_map" style="min-height:90px" placeholder='np. {"SPK1":"Jan","SPK2":"Anna"}'></textarea>
        <div class="small">Opcjonalnie: podmień etykiety <code>SPK1</code>, <code>SPK2</code> itd. na imiona.</div>
      </div>

      <div class="hr"></div>

      <div class="row" style="flex-wrap:wrap">
        <button class="btn" id="di_btn">Uruchom diaryzację</button>
        <a class="btn secondary" id="di_download" href="#" style="display:none">Pobierz TXT</a>
      </div>

      <div class="small" style="margin-top:10px">
        Status: <b id="di_status">—</b> • Postęp: <span id="di_pct">0%</span>
      </div>
      <div class="progress" style="margin-top:10px"><div id="di_bar"></div></div>
      <div class="small" style="margin-top:10px">Logi są dostępne w zakładce <b>Logi</b>.</div>
    </div>

    <div class="subcard">
      <div class="label">Nazwy mówców (mapowanie JSON)</div>
      <textarea id="di_speaker_map" style="min-height:140px" placeholder='np. {"SPEAKER_00":"Jan","SPEAKER_01":"Anna"}'></textarea>
      <div class="row" style="margin-top:10px; flex-wrap:wrap">
        <button class="btn secondary" id="di_apply_map">Zastosuj w podglądzie</button>
        <button class="btn secondary" id="di_save_map">Zapisz mapowanie w projekcie</button>
      </div>
      <div class="small">Działa dla etykiet typu <code>SPEAKER_00</code> (pyannote) oraz <code>SPK1</code> (tekst).</div>
    </div>
  </div>

  <div class="hr"></div>

  <div class="label">Wynik diaryzacji</div>
  <textarea id="di_out" class="bigarea" placeholder="Tutaj pojawi się wynik…"></textarea>
  <div class="row" style="margin-top:10px; flex-wrap:wrap">
    <button class="btn secondary" id="di_save_txt">Zapisz wynik w projekcie</button>
  </div>
  <div class="small">Zapis tworzy plik w projekcie (np. <code>diarized.txt</code>).</div>
</div>
{% endblock %}

{% block scripts %}
<script>
function onDoneDiarize(j){
  if(j.result && j.result.text){
    document.getElementById("di_out").value = j.result.text;
    if(j.project_id){
      const dl = document.getElementById("di_download");
      dl.href = `/api/projects/${j.project_id}/download/diarized.txt`;
      dl.style.display = "inline-flex";
    }
  }
}

let DI_HAS_AUDIO = false;

function toggleMode(){
  const mode = document.getElementById("di_mode").value;
  document.getElementById("di_pyannote_block").style.display = (mode==="pyannote") ? "block" : "none";
  document.getElementById("di_text_block").style.display = (mode==="text") ? "block" : "none";
}
document.getElementById("di_mode").addEventListener("change", toggleMode);
toggleMode();

document.getElementById("di_btn").addEventListener("click", async ()=>{
  const mode = document.getElementById("di_mode").value;
  const fd = new FormData();

  if(mode === "pyannote"){
    if(!DI_HAS_AUDIO){
      alert("Brak pliku audio w projekcie. Utwórz projekt w zakładce: Nowy projekt.");
      window.location.href = "/new-project";
      return;
    }
    fd.append("lang", document.getElementById("di_lang").value);
    fd.append("model", document.getElementById("di_model").value);
    await startTask("di", "/api/diarize_voice", fd, onDoneDiarize);
  } else {
    const text = document.getElementById("di_text_in").value || "";
    if(!text.trim()){ alert("Wklej tekst wejściowy."); return; }
    fd.append("text", text);
    fd.append("speakers", document.getElementById("di_speakers").value || "2");
    fd.append("method", document.getElementById("di_method").value || "alternate");
    fd.append("mapping_json", document.getElementById("di_map").value || "");
    await startTask("di", "/api/diarize_text", fd, onDoneDiarize);
  }
});

document.getElementById("di_save_txt").addEventListener("click", async ()=>{
  const pid = requireProjectId();
  const text = document.getElementById("di_out").value || "";
  await api(`/api/projects/${pid}/save_diarized`, {
    method:"POST",
    headers:{ "content-type":"application/json" },
    body: JSON.stringify({ text })
  });
  alert("Zapisano wynik diaryzacji w projekcie.");
});

document.getElementById("di_apply_map").addEventListener("click", ()=>{
  let mapping = {};
  const raw = document.getElementById("di_speaker_map").value || "";
  if(raw.trim()){
    try{ mapping = JSON.parse(raw); }catch(e){ alert("Niepoprawny JSON mapowania."); return; }
  }
  let out = document.getElementById("di_out").value || "";
  for(const [k,v] of Object.entries(mapping)){
    out = out.split(k).join(v);
  }
  document.getElementById("di_out").value = out;
});

document.getElementById("di_save_map").addEventListener("click", async ()=>{
  const pid = requireProjectId();
  const raw = document.getElementById("di_speaker_map").value || "";
  let mapping = {};
  if(raw.trim()){
    try{ mapping = JSON.parse(raw); }catch(e){ alert("Niepoprawny JSON mapowania."); return; }
  }
  await api(`/api/projects/${pid}/speaker_map`, {
    method:"POST",
    headers:{ "content-type":"application/json" },
    body: JSON.stringify({ mapping })
  });
  alert("Zapisano mapowanie w projekcie.");
});

(async()=>{
  await refreshCurrentProjectInfo();
  const btn = document.getElementById("di_btn");
  if(btn){
    // audio is required for audio-based diarization
    const needAudio = (document.getElementById("di_mode")?.value || "audio") === "audio";
    btn.disabled = needAudio && !(AISTATE.projectId && AISTATE.audioFile);
  }
  await resumeTask("di", onDoneDiarize);
})();

</script>
{% endblock %}
