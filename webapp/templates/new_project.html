{% extends "base.html" %}
{% block content %}
<div class="card">
  <h1 class="h1" data-i18n="page.new_project.title">New project</h1>

  <div class="topgrid">
    <div class="subcard">
      <div class="label">Nazwa projektu</div>
      <input class="input" id="np_name" type="text" placeholder="np. Wywiad_2026_01_03"/>
      <div class="small">Nazwa jest przechowywana w <code>project.json</code> w folderze projektu.</div>

      <div class="hr"></div>

      <div class="label">Plik źródłowy audio</div>
      <input class="input" id="np_file" type="file" accept="audio/*,.wav,.mp3,.m4a,.flac,.ogg,.opus,.mp4,.aac"/>
      <div class="small">Ten plik będzie plikiem źródłowym projektu (transkrypcja i diaryzacja pracują na tym samym pliku).</div>

      <div class="hr"></div>

      <div class="row" style="flex-wrap:wrap">
        <button class="btn" id="np_create">Utwórz projekt</button>
      </div>
      <div class="small" style="margin-top:10px">Status: <b id="np_status">—</b></div>
    </div>

    <div class="subcard">
      <div class="label">Jak to działa</div>
      <ul class="small" style="line-height:1.5; margin:0; padding-left:18px">
        <li>Po utworzeniu projektu powstaje folder w <code>data_www/projects/&lt;project_id&gt;</code>.</li>
        <li>W folderze zapisywany jest <code>project.json</code> oraz wskazany plik audio.</li>
        <li>Zakładki <b>Transkrypcja</b> i <b>Diaryzacja</b> korzystają z pliku audio projektu (nie wybiera się go ponownie).</li>
      </ul>
      <div class="hr"></div>
      <div class="small">Aktywny projekt jest trzymany w przeglądarce (localStorage). Utworzenie nowego projektu ustawi go jako aktywny.</div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function suggestName(){
  const d = new Date();
  const pad = (n)=>String(n).padStart(2,'0');
  return `Projekt_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
}

document.getElementById("np_name").value = suggestName();

document.getElementById("np_create").addEventListener("click", async ()=>{
  const name = (document.getElementById("np_name").value || "").trim();
  const f = document.getElementById("np_file").files[0];
  if(!name){ alert("Podaj nazwę projektu."); return; }
  if(!f){ alert("Wskaż plik audio."); return; }

  const fd = new FormData();
  fd.append("name", name);
  fd.append("audio", f);

  document.getElementById("np_status").textContent = "Tworzę…";

  try{
    const j = await api("/api/projects/create", {method:"POST", body: fd});
    AISTATE.projectId = j.project_id;
    document.getElementById("np_status").textContent = `Gotowe ✅ (${j.project_id.slice(0,8)})`;
    await refreshProjects('project_select');
    await refreshCurrentProjectInfo();
    window.location.href = "/transcription";
  }catch(e){
    document.getElementById("np_status").textContent = "Błąd ❌";
    alert(e.message || "Błąd tworzenia projektu");
  }
});
</script>
{% endblock %}
