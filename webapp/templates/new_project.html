{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="topgrid3">
    <div class="subcard">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div class="label" style="font-weight:900;color:var(--text);font-size:16px" data-i18n="page.new_project.title">Nowy projekt</div>
          <div class="small" data-i18n="page.new_project.subtitle">Utwórz nowy projekt i wybierz plik audio</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="label" data-i18n="projects.new.name">Nazwa projektu</div>
      <input class="input" id="np_name" type="text" data-i18n-placeholder="np.name_placeholder" placeholder="np. Wywiad_2026_01_03"/>
      <div class="small" data-i18n-html="np.name_hint_html">Nazwa jest przechowywana w <code>project.json</code> w folderze projektu.</div>

      <div class="hr"></div>

      <div class="label" data-i18n="np.audio_label">Plik źródłowy audio</div>
      <input class="input" id="np_file" type="file" accept="audio/*,.wav,.mp3,.m4a,.flac,.ogg,.opus,.mp4,.aac"/>
      <div class="small" data-i18n="np.audio_hint">Ten plik będzie plikiem źródłowym projektu (transkrypcja i diaryzacja pracują na tym samym pliku).</div>

      <div class="hr"></div>

      <div class="row" style="flex-wrap:wrap">
        <button class="btn" id="np_create" data-i18n="np.btn_create">Utwórz projekt</button>
      </div>
      <div class="small" style="margin-top:10px"><span data-i18n="common.status">Status</span>: <b id="np_status">—</b></div>
    </div>

    <div class="subcard">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div class="label" style="font-weight:900;color:var(--text);font-size:16px" data-i18n="projects.open.title">Otwórz projekt</div>
          <div class="small" data-i18n="projects.open.choose">Wybierz zapisany projekt</div>
        </div>
        <button class="btn secondary" id="op_refresh" type="button" data-i18n="projects.open.refresh_btn">Odśwież listę</button>
      </div>

      <div class="hr"></div>

      <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center">
        <select id="op_select"></select>
        <button class="btn" id="op_open" type="button" data-i18n="projects.open.open_btn">Otwórz</button>
      </div>

      <div class="hr"></div>
      <div class="label" data-i18n="projects.open.details">Szczegóły</div>
      <div class="small" id="op_meta" data-i18n="projects.open.no_selection">Wybierz projekt z listy.</div>
    </div>

    <div class="subcard">
      <div class="label" style="font-weight:900;color:var(--text);font-size:16px" data-i18n="np.how.title">Jak to działa</div>
      <ul class="small" style="line-height:1.5; margin:0; padding-left:18px">
        <li data-i18n-html="np.how.li1_html">Po utworzeniu projektu powstaje folder w <code>data_www/projects/&lt;project_id&gt;</code>.</li>
        <li data-i18n-html="np.how.li2_html">W folderze zapisywany jest <code>project.json</code> oraz wskazany plik audio.</li>
        <li data-i18n-html="np.how.li3_html">Zakładki <b>Transkrypcja</b> i <b>Diaryzacja</b> korzystają z pliku audio projektu (nie wybiera się go ponownie).</li>
      </ul>
      <div class="hr"></div>
      <div class="small" data-i18n="np.how.note">Aktywny projekt jest trzymany w przeglądarce (localStorage). Utworzenie nowego projektu ustawi go jako aktywny.</div>
    </div>
  </div>

  <div class="hr"></div>

  <div class="subcard">
  <div class="row" style="gap:12px; align-items:stretch; flex-wrap:wrap;">
    <!-- EXPORT CARD -->
    <div class="subcard" style="flex:1; min-width:240px;">
      <div class="label" style="font-weight:900;color:var(--text);font-size:16px" data-i18n="projects.export.title">Eksport</div>
      <div class="small" data-i18n="projects.export.desc">Eksportuje projekt do pliku <code>.aistate</code>, aby uruchomić go na innej maszynie z zainstalowanym AiSTATEweb.</div>
      <div class="hr"></div>
      <button class="btn secondary" id="export_aistate_btn" type="button" data-i18n="projects.export.btn">Eksportuj</button>
    </div>

    <!-- IMPORT CARD -->
    <div class="subcard" style="flex:1; min-width:240px;">
      <div class="label" style="font-weight:900;color:var(--text);font-size:16px" data-i18n="projects.import.title">Import</div>
      <div class="small" data-i18n="projects.import.desc">Importuje plik <code>.aistate</code> i dodaje projekt do katalogu projektów tej instancji.</div>
      <div class="hr"></div>
      <input id="import_aistate_file" type="file" accept=".aistate" style="display:none" />
      <button class="btn secondary" id="import_aistate_btn" type="button" data-i18n="projects.import.btn">Import</button>
    </div>

    <!-- DELETE CARD -->
    <div class="subcard" style="flex:1; min-width:240px;">
      <div class="label" style="font-weight:900;color:var(--text);font-size:16px" data-i18n="projects.delete.title">Usuń</div>
      <div class="small" data-i18n="projects.delete.desc">Usuwa wybrany projekt z programu (opcjonalnie z nadpisaniem plików).</div>
      <div class="hr"></div>
      <button class="btn danger" id="delete_project_btn" type="button" data-i18n="projects.delete.btn">Usuń</button>
    </div>
  </div>
</div>

<!-- Delete modal -->
<div id="deleteProjectModal" class="modal-overlay" style="display:none">
  <div class="modal-panel">
    <div class="modal-header">
      <div class="modal-title" data-i18n="projects.delete.modal.title">Usuń projekt</div>
      <button id="deleteModalCloseX" class="btn secondary" type="button">✕</button>
    </div>

    <div class="modal-body">
      <div class="label" data-i18n="projects.delete.modal.choose">Wybierz projekt do usunięcia</div>
      <select id="deleteProjectSelect" class="input"></select>
      <div class="small" data-i18n="projects.delete.modal.choose_hint">Możesz usunąć bieżący projekt lub dowolny istniejący na dysku.</div>

      <div class="hr"></div>

      <div class="label" data-i18n="projects.delete.modal.method">Metoda nadpisywania</div>
      <select id="deleteWipeMethod" class="input">
        <option value="none" data-i18n="projects.delete.wipe.none">Szybkie (bez nadpisywania)</option>
        <option value="random1" data-i18n="projects.delete.wipe.random1">Pseudolosowy (1x)</option>
        <option value="hmg_is5" data-i18n="projects.delete.wipe.hmg">British HMG IS5 (3x)</option>
        <option value="gutmann" data-i18n="projects.delete.wipe.gutmann">Gutmann (35x)</option>
      </select>
      <div class="small" data-i18n="projects.delete.modal.note">Uwaga: na SSD/VM/CoW nadpisywanie może nie gwarantować pełnego „secure erase”.</div>
    </div>

    <div class="modal-footer">
      <button id="deleteModalCancel" class="btn secondary" type="button" data-i18n="common.cancel">Anuluj</button>
      <button id="deleteModalConfirm" class="btn danger" type="button" data-i18n="projects.delete.modal.confirm">Usuń</button>
    </div>
  </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
function suggestName(){
  const d = new Date();
  const pad = (n)=>String(n).padStart(2,'0');
  return `Projekt_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
}

document.getElementById("np_name").value = suggestName();

document.getElementById("np_create").addEventListener("click", async ()=>{
  const name = (document.getElementById("np_name").value || "").trim();
  const f = document.getElementById("np_file").files[0];
  if(!name){ alert(t("np.alert.enter_name")); return; }
  if(!f){ alert(t("np.alert.select_audio")); return; }

  const fd = new FormData();
  fd.append("name", name);
  fd.append("audio", f);

  document.getElementById("np_status").textContent = t("np.status.creating");

  try{
    const j = await api("/api/projects/create", {method:"POST", body: fd});
    AISTATE.projectId = j.project_id;
    document.getElementById("np_status").textContent = tFmt("np.status.done", {id: j.project_id.slice(0,8)});
    await refreshProjects('project_select');
    await refreshCurrentProjectInfo();
    window.location.href = "/transcription";
  }catch(e){
    document.getElementById("np_status").textContent = t("np.status.error");
    alert(e.message || t("np.alert.create_error"));
  }
});

async function updateOpenMeta(){
  const pid = (document.getElementById('op_select')?.value || '').trim();
  const box = document.getElementById('op_meta');
  if(!box) return;
  if(!pid){
    box.textContent = t('projects.open.no_selection');
    return;
  }
  try{
    const meta = await api(`/api/projects/${pid}/meta`);
    const name = meta.name || t('projects.unnamed');
    const audio = meta.audio_file || t('projects.no_file');
    const created = meta.created_at || '—';
    const updated = meta.updated_at || '—';
    const flags = [
      meta.has_transcript ? t('projects.open.tr_yes') : t('projects.open.tr_no'),
      meta.has_diarized ? t('projects.open.di_yes') : t('projects.open.di_no'),
    ].join(' · ');
    box.innerHTML = `<b>${escapeHtml(name)}</b> <span style="opacity:.8">(${pid.slice(0,8)})</span><br>`
      + `${escapeHtml(flags)}<br>`
      + `<span style="opacity:.85">${escapeHtml(t('projects.open.audio'))}:</span> <code>${escapeHtml(audio)}</code><br>`
      + `<span style="opacity:.85">${escapeHtml(t('projects.open.created'))}:</span> ${escapeHtml(created)} · <span style="opacity:.85">${escapeHtml(t('projects.open.updated'))}:</span> ${escapeHtml(updated)}`;
  }catch(e){
    box.textContent = '—';
  }
}

function escapeHtml(s){
  return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function refreshOpenProjects(){
  await refreshProjects('op_select');
  await updateOpenMeta();
}

document.getElementById('op_refresh').addEventListener('click', async ()=>{
  await refreshOpenProjects();
});

document.getElementById('op_select').addEventListener('change', async ()=>{
  await updateOpenMeta();
});

document.getElementById('op_open').addEventListener('click', async ()=>{
  const pid = (document.getElementById('op_select')?.value || '').trim();
  if(!pid){
    alert(t('projects.open.no_selection'));
    return;
  }
  AISTATE.projectId = pid;
  AISTATE.audioFile = '';
  await refreshCurrentProjectInfo();
  window.location.href = '/transcription';
});

// ---------- Export / Import / Delete (Projects) ----------
(function bindProjectExportImportDelete(){
  const exportBtn = document.getElementById('export_aistate_btn') || document.getElementById('export_zip_btn');
  const importBtn = document.getElementById('import_aistate_btn');
  const importInput = document.getElementById('import_aistate_file');
  const deleteBtn = document.getElementById('delete_project_btn');

  const modal = document.getElementById('deleteProjectModal');
  const modalCloseX = document.getElementById('deleteModalCloseX');
  const modalCancel = document.getElementById('deleteModalCancel');
  const modalConfirm = document.getElementById('deleteModalConfirm');
  const modalSelect = document.getElementById('deleteProjectSelect');
  const wipeSelect = document.getElementById('deleteWipeMethod');

  function sanitizeFilename(name){
    return String(name || 'AISTATE_project')
      .replace(/[\\\/:*?"<>|]+/g, "_")
      .replace(/\s+/g, " ")
      .trim() || 'AISTATE_project';
  }

  async function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    try{
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }finally{
      URL.revokeObjectURL(url);
    }
  }

  async function exportAistate(){
    const pid = requireProjectId();
    // Try to use project name from meta for filename
    let fname = pid;
    try{
      const meta = await api(`/api/projects/${pid}/meta`);
      fname = sanitizeFilename(meta.name || pid);
    }catch(e){}
    const res = await fetch(`/api/projects/${pid}/export.aistate`, {method:'GET'});
    if(!res.ok){
      const txt = await res.text().catch(()=> '');
      throw new Error(txt || `HTTP ${res.status}`);
    }
    const blob = await res.blob();
    await downloadBlob(blob, `${fname}.aistate`);
  }

  if(exportBtn){
    exportBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        await exportAistate();
      }catch(err){
        console.error(err);
        alert((err && err.message) ? err.message : t('projects.export.error'));
      }
    });
  }

  if(importBtn && importInput){
    importBtn.addEventListener('click', ()=>{
      importInput.click();
    });

    importInput.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      e.target.value = '';
      if(!f) return;

      const name = (f.name || '').toLowerCase();
      if(!name.endsWith('.aistate')){
        alert(t('projects.import.bad_ext'));
        return;
      }

      const fd = new FormData();
      fd.append('file', f);

      try{
        const j = await api('/api/projects/import', {method:'POST', body: fd});
        if(j && j.project_id){
          AISTATE.projectId = j.project_id;
          AISTATE.audioFile = '';
          await refreshCurrentProjectInfo();
          await refreshOpenProjects();
          window.location.href = '/transcription';
        }
      }catch(err){
        console.error(err);
        alert((err && err.message) ? err.message : t('projects.import.error'));
      }
    });
  }

  function modalShow(){ if(modal) modal.style.display = 'flex'; }
  function modalHide(){ if(modal) modal.style.display = 'none'; }

  async function fillDeleteList(){
    if(!modalSelect) return;
    modalSelect.innerHTML = '';
    const current = (AISTATE.projectId || '').trim();

    // Current project option first (if exists)
    if(current){
      const opt = document.createElement('option');
      opt.value = current;
      opt.textContent = `${current} — ${t('projects.delete.modal.current')}`;
      modalSelect.appendChild(opt);
    }

    const data = await api('/api/projects');
    const projects = (data && data.projects) ? data.projects : [];
    for(const p of projects){
      const pid = p.project_id;
      if(!pid) continue;
      // avoid duplicate current
      if(current && pid === current) continue;

      const opt = document.createElement('option');
      opt.value = pid;
      const nm = p.name ? ` — ${p.name}` : '';
      opt.textContent = `${pid}${nm}`;
      modalSelect.appendChild(opt);
    }

    if(!modalSelect.value && modalSelect.options.length){
      modalSelect.selectedIndex = 0;
    }
  }

  async function openDeleteModal(){
    await fillDeleteList();
    modalShow();
  }

  async function doDelete(){
    if(!modalSelect || !modalSelect.value){
      alert(t('projects.delete.modal.no_choice'));
      return;
    }
    const pid = modalSelect.value;
    const wipe = (wipeSelect && wipeSelect.value) ? wipeSelect.value : 'none';

    const ok = confirm(t('projects.delete.modal.confirm2'));
    if(!ok) return;

    try{
      await api(`/api/projects/${pid}?wipe_method=${encodeURIComponent(wipe)}`, {method:'DELETE'});
      if(AISTATE.projectId === pid){
        AISTATE.projectId = '';
        AISTATE.audioFile = '';
        await refreshCurrentProjectInfo();
      }
      await refreshOpenProjects();
      modalHide();
      alert(t('projects.delete.done'));
    }catch(err){
      console.error(err);
      alert((err && err.message) ? err.message : t('projects.delete.error'));
    }
  }

  if(deleteBtn){
    deleteBtn.addEventListener('click', async ()=>{
      try{ await openDeleteModal(); }
      catch(err){
        console.error(err);
        alert((err && err.message) ? err.message : t('projects.delete.error'));
      }
    });
  }

  if(modalCloseX) modalCloseX.addEventListener('click', modalHide);
  if(modalCancel) modalCancel.addEventListener('click', modalHide);

  if(modal){
    modal.addEventListener('click', (e)=>{
      if(e.target === modal) modalHide();
    });
  }

  if(modalConfirm) modalConfirm.addEventListener('click', doDelete);
})();

// Initialize saved-project list
refreshOpenProjects();
</script>
{% endblock %}
