{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="topgrid3">
    <div class="subcard">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div class="label" style="font-weight:900;color:var(--text);font-size:16px" data-i18n="page.new_project.title">Nowy projekt</div>
          <div class="small" data-i18n="page.new_project.subtitle">Utwórz nowy projekt i wybierz plik audio</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="label" data-i18n="projects.new.name">Nazwa projektu</div>
      <input class="input" id="np_name" type="text" placeholder="np. Wywiad_2026_01_03"/>
      <div class="small">Nazwa jest przechowywana w <code>project.json</code> w folderze projektu.</div>

      <div class="hr"></div>

      <div class="label">Plik źródłowy audio</div>
      <input class="input" id="np_file" type="file" accept="audio/*,.wav,.mp3,.m4a,.flac,.ogg,.opus,.mp4,.aac"/>
      <div class="small">Ten plik będzie plikiem źródłowym projektu (transkrypcja i diaryzacja pracują na tym samym pliku).</div>

      <div class="hr"></div>

      <div class="row" style="flex-wrap:wrap">
        <button class="btn" id="np_create">Utwórz projekt</button>
      </div>
      <div class="small" style="margin-top:10px">Status: <b id="np_status">—</b></div>
    </div>

    <div class="subcard">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div class="label" style="font-weight:900;color:var(--text);font-size:16px" data-i18n="projects.open.title">Otwórz projekt</div>
          <div class="small" data-i18n="projects.open.choose">Wybierz zapisany projekt</div>
        </div>
        <button class="btn secondary" id="op_refresh" type="button" data-i18n="projects.open.refresh_btn">Odśwież listę</button>
      </div>

      <div class="hr"></div>

      <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center">
        <select id="op_select"></select>
        <button class="btn" id="op_open" type="button" data-i18n="projects.open.open_btn">Otwórz</button>
      </div>

      <div class="hr"></div>
      <div class="label" data-i18n="projects.open.details">Szczegóły</div>
      <div class="small" id="op_meta" data-i18n="projects.open.no_selection">Wybierz projekt z listy.</div>
    </div>

    <div class="subcard">
      <div class="label" style="font-weight:900;color:var(--text);font-size:16px">Jak to działa</div>
      <ul class="small" style="line-height:1.5; margin:0; padding-left:18px">
        <li>Po utworzeniu projektu powstaje folder w <code>data_www/projects/&lt;project_id&gt;</code>.</li>
        <li>W folderze zapisywany jest <code>project.json</code> oraz wskazany plik audio.</li>
        <li>Zakładki <b>Transkrypcja</b> i <b>Diaryzacja</b> korzystają z pliku audio projektu (nie wybiera się go ponownie).</li>
      </ul>
      <div class="hr"></div>
      <div class="small">Aktywny projekt jest trzymany w przeglądarce (localStorage). Utworzenie nowego projektu ustawi go jako aktywny.</div>
    </div>
  </div>

  <div class="hr"></div>

  <div class="subcard">
    <div class="label" style="font-weight:900;color:var(--text);font-size:16px" data-i18n="projects.export.title">Eksport</div>
    <div class="small" data-i18n="projects.export.zip_hint">Eksportuje folder projektu (audio, wyniki, raporty, metadata).</div>
    <div class="hr"></div>
    <div class="row" style="flex-wrap:wrap">
      <a class="btn secondary" id="export_zip_btn" href="#" data-i18n="projects.export.zip_btn">Eksportuj ZIP bieżącego projektu</a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function suggestName(){
  const d = new Date();
  const pad = (n)=>String(n).padStart(2,'0');
  return `Projekt_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
}

document.getElementById("np_name").value = suggestName();

document.getElementById("np_create").addEventListener("click", async ()=>{
  const name = (document.getElementById("np_name").value || "").trim();
  const f = document.getElementById("np_file").files[0];
  if(!name){ alert("Podaj nazwę projektu."); return; }
  if(!f){ alert("Wskaż plik audio."); return; }

  const fd = new FormData();
  fd.append("name", name);
  fd.append("audio", f);

  document.getElementById("np_status").textContent = "Tworzę…";

  try{
    const j = await api("/api/projects/create", {method:"POST", body: fd});
    AISTATE.projectId = j.project_id;
    document.getElementById("np_status").textContent = `Gotowe ✅ (${j.project_id.slice(0,8)})`;
    await refreshProjects('project_select');
    await refreshCurrentProjectInfo();
    window.location.href = "/transcription";
  }catch(e){
    document.getElementById("np_status").textContent = "Błąd ❌";
    alert(e.message || "Błąd tworzenia projektu");
  }
});

async function updateOpenMeta(){
  const pid = (document.getElementById('op_select')?.value || '').trim();
  const box = document.getElementById('op_meta');
  if(!box) return;
  if(!pid){
    box.textContent = t('projects.open.no_selection');
    return;
  }
  try{
    const meta = await api(`/api/projects/${pid}/meta`);
    const name = meta.name || t('projects.unnamed');
    const audio = meta.audio_file || t('projects.no_file');
    const created = meta.created_at || '—';
    const updated = meta.updated_at || '—';
    const flags = [
      meta.has_transcript ? t('projects.open.tr_yes') : t('projects.open.tr_no'),
      meta.has_diarized ? t('projects.open.di_yes') : t('projects.open.di_no'),
    ].join(' · ');
    box.innerHTML = `<b>${escapeHtml(name)}</b> <span style="opacity:.8">(${pid.slice(0,8)})</span><br>`
      + `${escapeHtml(flags)}<br>`
      + `<span style="opacity:.85">${escapeHtml(t('projects.open.audio'))}:</span> <code>${escapeHtml(audio)}</code><br>`
      + `<span style="opacity:.85">${escapeHtml(t('projects.open.created'))}:</span> ${escapeHtml(created)} · <span style="opacity:.85">${escapeHtml(t('projects.open.updated'))}:</span> ${escapeHtml(updated)}`;
  }catch(e){
    box.textContent = '—';
  }
}

function escapeHtml(s){
  return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function refreshOpenProjects(){
  await refreshProjects('op_select');
  await updateOpenMeta();
}

document.getElementById('op_refresh').addEventListener('click', async ()=>{
  await refreshOpenProjects();
});

document.getElementById('op_select').addEventListener('change', async ()=>{
  await updateOpenMeta();
});

document.getElementById('op_open').addEventListener('click', async ()=>{
  const pid = (document.getElementById('op_select')?.value || '').trim();
  if(!pid){
    alert(t('projects.open.no_selection'));
    return;
  }
  AISTATE.projectId = pid;
  AISTATE.audioFile = '';
  await refreshCurrentProjectInfo();
  window.location.href = '/transcription';
});

document.getElementById('export_zip_btn').addEventListener('click', async (e)=>{
  e.preventDefault();
  const pid = requireProjectId();
  window.location = `/api/projects/${pid}/export.zip`;
});

// Initialize saved-project list
refreshOpenProjects();
</script>
{% endblock %}
